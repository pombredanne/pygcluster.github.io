

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyGCluster &mdash; pyGCluster 0.18.4 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.18.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="pyGCluster 0.18.4 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">pyGCluster 0.18.4 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyGCluster</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python2.7</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">pyGCluster is a clustering algorithm focusing on noise injection for subsequent cluster validation.</span>
<span class="sd">By requesting identical cluster identity, the reproducibility of a large amount of clusters</span>
<span class="sd">obtained with agglomerative hierarchical clustering (AHC) is assessed.</span>
<span class="sd">Furthermore, a multitude of different distance-linkage combinations (DLCs) are evaluated.</span>
<span class="sd">Finally, associations of highly reproducible clusters, called communities, are created.</span>
<span class="sd">Graphical representation of the results as node maps and expression maps is implemented.</span>

<span class="sd">The pyGCluster module contains the main class :py:class:`pyGCluster.Cluster` and some functions</span>
<span class="sd">    | :py:func:`pyGCluster.create_default_alphabet`</span>
<span class="sd">    | :py:func:`pyGCluster.resampling_multiprocess`</span>
<span class="sd">    | :py:func:`pyGCluster.seekAndDestry`</span>
<span class="sd">    | :py:func:`pyGCluster.yield_noisejected_dataset`</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c">#</span>
<span class="c"># pyGCluster</span>
<span class="c">#</span>
<span class="c"># Copyright (C) D. Jaeger and C. Fufezan</span>
<span class="c">#</span>
<span class="c">#    This program is free software: you can redistribute it and/or modify</span>
<span class="c">#    it under the terms of the GNU General Public License as published by</span>
<span class="c">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">#    (at your option) any later version.</span>
<span class="c">#</span>
<span class="c">#    This program is distributed in the hope that it will be useful,</span>
<span class="c">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">#    GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c">#    You should have received a copy of the GNU General Public License</span>
<span class="c">#    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span> <span class="k">as</span> <span class="n">ddict</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c"># if python3k, cPickle is implemented in pickle-library</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;since fastcluster runs only under python2k, please re-call pyGCluster with python2k.&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">else</span><span class="p">:</span> <span class="c"># 2k, explicitely import cPickle</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>

<div class="viewcode-block" id="yield_noisejected_dataset"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.yield_noisejected_dataset">[docs]</a><span class="k">def</span> <span class="nf">yield_noisejected_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">iterations</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generator yielding a re-sampled dataset with each iteration.</span>
<span class="sd">    A re-sampled dataset is created by re-sampling each data point</span>
<span class="sd">    from the normal distribution given by its associated mean and standard deviation value.</span>
<span class="sd">    See the example in Supplementary Material in pyGCluster&#39;s publication for how to define an own noise-function (e.g. uniform noise).</span>

<span class="sd">    :param data: dictionary ( OrderedDict! ) holding the data to be re-sampled.</span>
<span class="sd">    :type data: collections.OrderedDict()</span>
<span class="sd">    :param iterations: the number of re-sampled datasets this generator will yield.</span>
<span class="sd">    :type iterations: int</span>

<span class="sd">    :rtype: none</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="c"># the check that no condition is missing in arg: data is made prior, in Cluster.__init__()</span>
    <span class="c"># this is required, because only equally shaped arrays can be clustered!</span>
    <span class="c"># otherwise, &#39;ValueError: setting an array element with a sequence.&#39;</span>
    <span class="n">Random</span>                     <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()</span> <span class="c"># get instance for new seed!</span>
    <span class="n">n_conditions</span>               <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">simulated_dataset</span>          <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span> <span class="p">),</span> <span class="n">n_conditions</span> <span class="p">)</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">iterations</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">row_index</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">data</span> <span class="p">):</span>
            <span class="k">for</span> <span class="n">col_index</span><span class="p">,</span> <span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">data_tuple</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">):</span>
                <span class="n">mean</span><span class="p">,</span> <span class="n">sd</span>  <span class="o">=</span> <span class="n">data_tuple</span>
                <span class="n">new_ratio</span> <span class="o">=</span> <span class="n">Random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sd</span> <span class="p">)</span>
                <span class="n">simulated_dataset</span><span class="p">[</span> <span class="n">row_index</span> <span class="p">][</span> <span class="n">col_index</span> <span class="p">]</span> <span class="o">=</span> <span class="n">new_ratio</span>
        <span class="k">yield</span> <span class="n">simulated_dataset</span>
    <span class="k">return</span>
</div>
<div class="viewcode-block" id="create_default_alphabet"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.create_default_alphabet">[docs]</a><span class="k">def</span> <span class="nf">create_default_alphabet</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the default alphabet which is used to save clusters in a lesser memory-intense form:</span>
<span class="sd">    instead of saving e.g. a cluster containing identifiers with indices of 1,20,30 as &quot;1,20,30&quot;, the indices are converted to a baseX system -&gt; &quot;1,k,u&quot;.</span>

<span class="sd">    The default alphabet that is returned is:</span>
<span class="sd">        &gt;&gt;&gt; string.printable.replace( &#39;,&#39;, &#39;&#39; )</span>

<span class="sd">    :rtype: string</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span> <span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="seekAndDestry"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.seekAndDestry">[docs]</a><span class="k">def</span> <span class="nf">seekAndDestry</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Any multiprocesses given by processes are terminated.</span>

<span class="sd">    :param processes: list containing multiprocess.Process()</span>
<span class="sd">    :type processes: list</span>

<span class="sd">    :rtype: none</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="k">return</span>
</div>
<div class="viewcode-block" id="resampling_multiprocess"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.resampling_multiprocess">[docs]</a><span class="k">def</span> <span class="nf">resampling_multiprocess</span><span class="p">(</span>
                                <span class="n">DataQ</span>                                    <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                                <span class="n">data</span>                                     <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                                <span class="n">iterations</span>                               <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
                                <span class="n">alphabet</span>                                 <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                                <span class="n">dlc</span>                                      <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                                <span class="n">min_cluster_size</span>                         <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                <span class="n">min_cluster_freq_2_retain</span>                  <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
                                <span class="n">function_2_generate_noise_injected_datasets</span> <span class="o">=</span> <span class="bp">None</span>
                            <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is the function that is called for each multiprocesses that is evoked internally in pyGCluster during the re-sampling routine.</span>
<span class="sd">    Agglomerative hierarchical clustering is performed for each distance-linkage combination (DLC) on each of iteration datasets.</span>
<span class="sd">    Clusters from each hierarchical tree are extracted, and their counts are saved in a temporary cluster-count matrix.</span>
<span class="sd">    After *iterations* iterations, clusters are filtered according to min_cluster_freq_2_retain.</span>
<span class="sd">    These clusters, together with their respective counts among all DLCs, are returned.</span>
<span class="sd">    The return value is a list containing tuples with two elements: cluster (string) and counts ( one dimensional np.array )</span>

<span class="sd">    :param DataQ: data queue which is used to pipe the re-sampling results back to pyGCluster.</span>
<span class="sd">    :type DataQ: multiprocessing.Queue()</span>
<span class="sd">    :param data: dictionary ( OrderedDict! ) holding the data to be clustered -&gt; passed through to the noise-function.</span>
<span class="sd">    :type data: collections.OrderedDict()</span>
<span class="sd">    :param iterations: the number of iterations this multiprocess is going to perform.</span>
<span class="sd">    :type iterations: int</span>
<span class="sd">    :param alphabet: in order to save memory, the indices describing a cluster are converted to a specific alphabet (rather than decimal system).</span>
<span class="sd">    :type alphabet: string</span>
<span class="sd">    :param dlc: list of the distance-linkage combinations that are going to be evaluated.</span>
<span class="sd">    :type dlc: list</span>
<span class="sd">    :param min_cluster_size: minimum size of a cluster to be considered in the re-sampling routine (smaller clusters are discarded)</span>
<span class="sd">    :type min_cluster_size: int</span>
<span class="sd">    :param min_cluster_freq_2_retain: once all iterations are performed, clusters are filtered according to 50% (because typically forwarded from pyGCluster) of this threshold.</span>
<span class="sd">    :type min_cluster_freq_2_retain: float</span>
<span class="sd">    :param function_2_generate_noise_injected_datasets: function to generate re-sampled datasets.</span>
<span class="sd">    :type function_2_generate_noise_injected_datasets: function</span>

<span class="sd">    :rtype: list</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="kn">import</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">as</span> <span class="nn">ssd</span>
    <span class="n">imported_from_scipy</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">fastcluster</span> <span class="kn">import</span> <span class="n">linkage</span> <span class="k">as</span> <span class="n">ahc</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">linkage</span> <span class="k">as</span> <span class="n">ahc</span>
            <span class="n">imported_from_scipy</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;You do require either &quot;fastcluster&quot; or &quot;scipy&quot;!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">DataQ</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span> <span class="s">&#39;[ ERROR ] need a Data-Queune and a data object! Returning ...&#39;</span> <span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">alphabet</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">alphabet</span> <span class="o">=</span> <span class="n">create_default_alphabet</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="p">,</span> <span class="s">&#39;[ ERROR ] the alphabet must not contain a comma (&quot;,&quot;)!&#39;</span>
    <span class="k">if</span> <span class="n">dlc</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dlc</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;euclidean-average&#39;</span> <span class="p">]</span>  <span class="c"># NOTE maybe better have all as default ! :)</span>
    <span class="k">if</span> <span class="n">function_2_generate_noise_injected_datasets</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">function_2_generate_noise_injected_datasets</span> <span class="o">=</span> <span class="n">yield_noisejected_dataset</span>
    <span class="n">n_objects</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">n_dlc</span>       <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">dlc</span> <span class="p">)</span>
    <span class="n">metrices</span>                       <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="p">[</span> <span class="n">combo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">]</span> <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">dlc</span> <span class="p">]</span> <span class="p">)</span>

    <span class="c"># build lookup-dict to convert index into baseX system, given by alphabet</span>
    <span class="n">baseX</span>       <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">alphabet</span> <span class="p">)</span>
    <span class="n">index2baseX</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">:</span> <span class="s">&#39;0&#39;</span> <span class="p">}</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_objects</span> <span class="p">):</span>
        <span class="n">old_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># modified ref: http://stackoverflow.com/questions/2267362/convert-integer-to-a-string-in-a-given-numeric-base-in-python</span>
        <span class="k">while</span> <span class="n">index</span><span class="p">:</span>
            <span class="n">digits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">alphabet</span><span class="p">[</span> <span class="n">index</span> <span class="o">%</span> <span class="n">baseX</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">index</span> <span class="o">/=</span> <span class="n">baseX</span>
        <span class="n">digits</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">converted_index</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">digits</span> <span class="p">)</span>
        <span class="n">index2baseX</span><span class="p">[</span> <span class="n">old_index</span> <span class="p">]</span> <span class="o">=</span> <span class="n">converted_index</span>

    <span class="c"># build initial template of &#39;clusters&#39;-dict (which is needed to extract clusters from the hierarchical tree)</span>
    <span class="n">clusters_template</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ID</span> <span class="p">:</span> <span class="p">[</span> <span class="n">index2baseX</span><span class="p">[</span> <span class="n">ID</span> <span class="p">]</span> <span class="p">]</span> <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_objects</span> <span class="p">)</span> <span class="p">}</span>
    <span class="c"># initialize temporary cluster-count matrix and the other necessary objects to fill it</span>
    <span class="n">tmpstruct_clustercount_monitor</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span>                  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">,</span> <span class="n">n_dlc</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span> <span class="p">)</span>
    <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span>             <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span>   <span class="o">=</span> <span class="n">dlc</span>
    <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster sieve&#39;</span> <span class="p">]</span>                   <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Discarded IDs&#39;</span> <span class="p">]</span>                   <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c"># get simulated datasets</span>
    <span class="k">for</span> <span class="n">simulated_dataset</span> <span class="ow">in</span> <span class="n">function_2_generate_noise_injected_datasets</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">iterations</span> <span class="p">):</span>
        <span class="c"># calculate distance matrices:</span>
        <span class="n">metric2condenseddist</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">imported_from_scipy</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrices</span><span class="p">:</span>
                <span class="n">metric2condenseddist</span><span class="p">[</span> <span class="n">metric</span> <span class="p">]</span> <span class="o">=</span> <span class="n">ssd</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span> <span class="n">simulated_dataset</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span> <span class="p">)</span>
        <span class="c"># perform AHC:</span>
        <span class="k">for</span> <span class="n">dlc_index</span><span class="p">,</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">dlc</span> <span class="p">):</span>
            <span class="n">metric</span><span class="p">,</span> <span class="n">linkage</span> <span class="o">=</span> <span class="n">combo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span> <span class="p">)</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            linkage matrix example:</span>
<span class="sd">            original data:</span>
<span class="sd">            [[1,2,3],</span>
<span class="sd">             [3,2,1],</span>
<span class="sd">             [1,3,5]]</span>

<span class="sd">            Linkage matrix representing AHC with euclidean distance and ward linkage:</span>
<span class="sd">            [[ 0.        ,  2.        ,  2.23606798,  2.        ],      CLUSTER ID 3</span>
<span class="sd">             [ 1.        ,  3.        ,  4.2031734 ,  3.        ]]      CLUSTER ID 4</span>
<span class="sd">               ^ child1     ^ child2     ^ distance   ^ cluster size</span>
<span class="sd">            Hence, element 0 and 2 were merged into cluster with ID = 3 (size = 2),</span>
<span class="sd">            then element 1 and cluster 3 are merged into the root cluster with ID = 4 (size = 3).</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="c"># perform AHC</span>
            <span class="k">if</span> <span class="n">imported_from_scipy</span><span class="p">:</span>
                <span class="n">linkage_matrix</span> <span class="o">=</span> <span class="n">ahc</span><span class="p">(</span> <span class="n">simulated_dataset</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">linkage_matrix</span> <span class="o">=</span> <span class="n">ahc</span><span class="p">(</span> <span class="n">metric2condenseddist</span><span class="p">[</span> <span class="n">metric</span> <span class="p">],</span> <span class="n">method</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">preserve_input</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
            <span class="c"># reconstruct clusters from the linkage matrix</span>
            <span class="n">clusters</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># key = clusterID, value = cluster-indices</span>
            <span class="n">clusters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">clusters_template</span> <span class="p">)</span>
            <span class="n">clusterID_linkagematrix</span> <span class="o">=</span> <span class="n">n_objects</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">childID_1</span><span class="p">,</span> <span class="n">childID_2</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">linkage_matrix</span><span class="p">:</span>
                <span class="n">clusterID_linkagematrix</span>             <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cluster_linkagematrix</span>               <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">clusters</span><span class="p">[</span> <span class="n">childID_1</span> <span class="p">]</span> <span class="o">+</span> <span class="n">clusters</span><span class="p">[</span> <span class="n">childID_2</span> <span class="p">]</span> <span class="p">)</span>
                <span class="n">clusters</span><span class="p">[</span> <span class="n">clusterID_linkagematrix</span> <span class="p">]</span> <span class="o">=</span> <span class="n">cluster_linkagematrix</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster_linkagematrix</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_cluster_size</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">cluster</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cluster_linkagematrix</span> <span class="p">)</span>
                <span class="c"># insert cluster into tmpstruct_clustercount_monitor and update it:</span>
                <span class="c"># but add only if its count &gt; 1 (determined via the &#39;Cluster sieve&#39;):</span>
                <span class="n">add</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]:</span>
                    <span class="n">clusterID</span> <span class="o">=</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span>
                    <span class="n">add</span>       <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster sieve&#39;</span> <span class="p">]:</span>
                        <span class="k">if</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Discarded IDs&#39;</span> <span class="p">]:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">clusterID</span> <span class="o">=</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Discarded IDs&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># KeyError: &#39;pop from an empty set&#39; = set is empty</span>
                                <span class="n">clusterID</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clusterID</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span> <span class="o">=</span> <span class="n">clusterID</span>
                        <span class="n">add</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster sieve&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span>
                        <span class="n">add</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">add</span><span class="p">:</span>
                    <span class="c"># increase count by 1</span>
                    <span class="c"># if new cluster, add 10 ** 5 new rows</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">clusterID</span> <span class="p">][</span> <span class="n">dlc_index</span> <span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span><span class="s">&#39;Cluster counts&#39;</span><span class="p">],</span>
                             <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span><span class="p">,</span> <span class="n">n_dlc</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span> <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">clusterID</span> <span class="p">][</span> <span class="n">dlc_index</span> <span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c"># increase count by 1</span>
            <span class="k">del</span> <span class="n">clusters</span>
        <span class="k">del</span> <span class="n">metric2condenseddist</span>
    <span class="k">del</span> <span class="n">simulated_dataset</span>

    <span class="c"># only transfer clusters equal or above 50% of &#39;min_cluster_freq_2_retain&#39; threshold to pyGCluster:</span>
    <span class="n">min_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">min_cluster_freq_2_retain</span> <span class="o">*</span> <span class="n">iterations</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="p">)</span>
    <span class="n">clusterIDs2retain</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_count</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">cluster_counts_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">clusterID</span> <span class="ow">in</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">clusterID</span> <span class="ow">in</span> <span class="n">clusterIDs2retain</span><span class="p">:</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">tmpstruct_clustercount_monitor</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">clusterID</span> <span class="p">]</span>
            <span class="n">cluster_counts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">del</span> <span class="n">tmpstruct_clustercount_monitor</span>
    <span class="n">DataQ</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="n">cluster_counts_list</span> <span class="p">)</span>
    <span class="k">del</span> <span class="n">cluster_counts_list</span>
    <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster">[docs]</a><span class="k">class</span> <span class="nc">Cluster</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The pyGCluster class</span>

<span class="sd">    :param working_directory: directory in which all results are written (requires write-permission!).</span>
<span class="sd">    :type working_directory: string</span>
<span class="sd">    :param verbosity_level: either 0, 1 or 2.</span>
<span class="sd">    :type verbosity_level: int</span>
<span class="sd">    :param data: Dictionary containing the data which is to be clustered.</span>
<span class="sd">    :type data: dict</span>

<span class="sd">    In order to work with the default noise-injection function as well as plot</span>
<span class="sd">    expression maps correctly, the data-dict **has** to have the following</span>
<span class="sd">    structure.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; data = {</span>
<span class="sd">        ...            Identifier1 : {</span>
<span class="sd">        ...                            condition1 :  ( mean11, sd11 ),</span>
<span class="sd">        ...                            condition2 :  ( mean12, sd12 ),</span>
<span class="sd">        ...                            condition3 :  ( mean13, sd13 ),</span>
<span class="sd">        ...             },</span>
<span class="sd">        ...            Identifier2 : {</span>
<span class="sd">        ...                            condition2 :  ( mean22, sd22 ),</span>
<span class="sd">        ...                            condition3 :  ( mean23, sd23 ),</span>
<span class="sd">        ...                            condition3 :  ( mean13, sd13 ),</span>
<span class="sd">        ...             },</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; import pyGCluster</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass = pyGCluster.Cluster(data=data, verbosity_level=1, working_directory=...)</span>

<span class="sd">    .. note ::</span>
<span class="sd">        If any condition for an identifier in the &quot;nested_data_dict&quot;-dict is missing,</span>
<span class="sd">        this entry is discarded, i.e. not imported into the Cluster Class.</span>
<span class="sd">        This is because pyGCluster does not implement any missing value estimation.</span>
<span class="sd">        One possible solution is to replace missing values by a mean value and a standard</span>
<span class="sd">        deviation that is representative for the complete data range in the given condition.</span>

<span class="sd">    pyGCluster inherits from the regular Python Dictionary object.</span>
<span class="sd">    Hence, the attributes of pyGCluster can be accessed as Python Dictionary keys.</span>

<span class="sd">    A selection of the most important attributes / keys are:</span>

<span class="sd">        &gt;&gt;&gt; # general</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Working directory&#39; ]</span>
<span class="sd">        ...     # this is the directory where all pyGCluster results</span>
<span class="sd">        ...     # (pickle objects, expression maps, node map, ...) are saved into.</span>
<span class="sd">        /Users/Shared/moClusterDirectory</span>
<span class="sd">        &gt;&gt;&gt; # original data ca be accessed via</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Data&#39; ]</span>
<span class="sd">        ...     # this collections.OrderedDict contains the data that has been</span>
<span class="sd">        ...     # or will be clustered (see also below).</span>
<span class="sd">        ... plenty of data ;)</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Conditions&#39; ]</span>
<span class="sd">        ...     # sorted list of all conditions that are defined in the &quot;Data&quot;-dictionary</span>
<span class="sd">        [ &#39;condition1&#39;, &#39;condition2&#39;, &#39;condition3&#39; ]</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Identifiers&#39; ]</span>
<span class="sd">        ...     # sorted tuple of all identifiers, i.e. ClusterClass[ &#39;Data&#39; ].keys()</span>
<span class="sd">        ( &#39;Identifier1&#39;, &#39;Identifier2&#39; , ... &#39;IdentifierN&#39; )</span>
<span class="sd">        &gt;&gt;&gt; # re-sampling paramerters</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Iterations&#39; ]</span>
<span class="sd">        ...     # the number of datasets that were clustered.</span>
<span class="sd">        1000000</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Cluster 2 clusterID&#39; ]</span>
<span class="sd">        ...     # dictionary with clusters as keys, and their respective row index</span>
<span class="sd">        ...     # in the &quot;Cluster count&quot;-matrix (= clusterID) as values.</span>
<span class="sd">        { ... }</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Cluster counts&#39; ]</span>
<span class="sd">        ...     # numpy.uint32 matrix holding the counts for each</span>
<span class="sd">        ...     # distance-linkage combination of the clusters.</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Distance-linkage combinations&#39; ]</span>
<span class="sd">        ...     # sorted list containing the distance-linkage combinations</span>
<span class="sd">        ...     # that were evaluted in the re-sampling routine.</span>
<span class="sd">        &gt;&gt;&gt; # Communities</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Communities&#39; ]</span>
<span class="sd">        ...     # see function pyGCluster.Cluster.build_nodemap for further information.</span>
<span class="sd">        &gt;&gt;&gt; # Visualization</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;Additional labels&#39; ]</span>
<span class="sd">        ...     # dictionary with an identifier of the &quot;Data&quot;-dict as key,</span>
<span class="sd">        ...     # and a list of additional information (e.g. annotation, GO terms) as value.</span>
<span class="sd">        {</span>
<span class="sd">            &#39;Identifier1&#39; :</span>
<span class="sd">                        [&#39;Photosynthesis related&#39; , &#39;zeroFactor: 12.31&#39; ],</span>
<span class="sd">            &#39;Identifier2&#39; : [ ... ] ,</span>
<span class="sd">             ...</span>
<span class="sd">        }</span>
<span class="sd">        &gt;&gt;&gt; ClusterClass[ &#39;for IO skip clusters bigger than&#39; ]</span>
<span class="sd">        ...     # Default = 100. Since some clusters are really large</span>
<span class="sd">        ...     # (with sizes close to the root (the cluster holding all objects)),</span>
<span class="sd">        ...     # clusters with more objects than this value</span>
<span class="sd">        ...     # are not plotted as expression maps or expression profile plots.</span>


<span class="sd">    pyGCluster offers the possibility to save the analysis (e.g. after re-sampling)</span>
<span class="sd">    via :py:func:`pyGCluster.Cluster.save` , and continue</span>
<span class="sd">    via :py:func:`pyGCluster.Cluster.load`</span>
<span class="sd">    Initializes  pyGCluster.Cluster class</span>

<span class="sd">    Classically, users start the multiprocessing clustering routine with multiple</span>
<span class="sd">    distance linkage combinations via the :py:func:`pyGCluster.Cluster.do_it_all`</span>
<span class="sd">    function. This function allows to update the pyGCluster class with all user</span>
<span class="sd">    parameters before it calls :py:func:`pyGCluster.Cluster.resample`.</span>
<span class="sd">    The main advantage in calling :py:func:`pyGCluster.Cluster.do_it_all` is</span>
<span class="sd">    that all general plotting functions are called afterwards as well, these are:</span>

<span class="sd">        | :py:func:`pyGCluster.Cluster.plot_clusterfreqs`</span>
<span class="sd">        | :py:func:`pyGCluster.Cluster.build_nodemap`</span>
<span class="sd">        | :py:func:`pyGCluster.Cluster.write_dot`</span>
<span class="sd">        | :py:func:`pyGCluster.Cluster.draw_community_expression_maps`</span>

<span class="sd">    If one choses, one can manually update the parameters (setting the key, value</span>
<span class="sd">    pairs in pyGCluster) and then evoke :py:func:`pyGCluster.Cluster.resample`</span>
<span class="sd">    with the appropriate parameters. This useful if certain memory intensive</span>
<span class="sd">    distance-linkage combinations are to be clustered on a specific computer.</span>

<span class="sd">    .. note ::</span>
<span class="sd">       Cluster Class can be initilized empty and filled using :py:func:`pyGCluster.Cluster.load`</span>



<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">working_directory</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_resampling_results</span><span class="p">()</span> <span class="c"># initializes important variables</span>
        <span class="k">if</span> <span class="n">working_directory</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">working_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span>             <span class="o">=</span> <span class="n">working_directory</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;for IO skip clusters bigger than&#39;</span> <span class="p">]</span>   <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Version&#39;</span> <span class="p">]</span>                       <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Verbosity level&#39;</span> <span class="p">]</span>               <span class="o">=</span> <span class="n">verbosity_level</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Additional labels&#39;</span> <span class="p">]</span>             <span class="o">=</span> <span class="p">{}</span>   <span class="c"># will be used as dict in draw functions, i.e. ids</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">]</span>                          <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">]</span>                       <span class="o">=</span> <span class="p">{</span>
                                        <span class="s">&#39;Params&#39;</span><span class="p">:</span>   <span class="p">{</span>   <span class="s">&#39;title&#39;</span>         <span class="p">:</span> <span class="s">&#39;pyGCluster expression map&#39;</span><span class="p">,</span>
                                                        <span class="s">&#39;font family&#39;</span>    <span class="p">:</span> <span class="s">&#39;Helvetica&#39;</span><span class="p">,</span>
                                                        <span class="s">&#39;font size&#39;</span>      <span class="p">:</span> <span class="mi">14</span> <span class="p">,</span>
                                                        <span class="s">&#39;rBox width&#39;</span>     <span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
                                                        <span class="s">&#39;rBox height&#39;</span>    <span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                                                        <span class="s">&#39;left border&#39;</span>    <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                                        <span class="s">&#39;top border&#39;</span>     <span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="c"># will be adjusted depending on the labels :)</span>
                                                        <span class="s">&#39;text spacing&#39;</span>   <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                                        <span class="s">&#39;text width&#39;</span>     <span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>
                                                        <span class="s">&#39;separator width&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
                                                        <span class="s">&#39;min&#39;</span>            <span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                                                        <span class="s">&#39;max&#39;</span>            <span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                                                        <span class="s">&#39;legend filename&#39;</span><span class="p">:</span> <span class="s">&#39;legend.svg&#39;</span><span class="p">,</span>
                                                        <span class="s">&#39;heat map filename&#39;</span> <span class="p">:</span> <span class="s">&#39;expression_map.svg&#39;</span><span class="p">,</span>
                                                        <span class="s">&#39;default color&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">],</span>
                                                        <span class="s">&#39;color gradient&#39;</span> <span class="p">:</span> <span class="s">&#39;default&#39;</span><span class="p">,</span>
                                        <span class="p">},</span>
                                        <span class="s">&#39;Color Gradients&#39;</span> <span class="p">:</span> <span class="p">{</span>
                                                    <span class="s">&#39;default&#39;</span>       <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">255</span><span class="p">)),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.40</span><span class="p">,(</span><span class="mi">255</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">)),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,(</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.05</span><span class="p">,(</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.40</span><span class="p">,(</span><span class="mi">40</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">40</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">40</span><span class="p">))</span> <span class="p">],</span>
                                                    <span class="s">&#39;Daniel&#39;</span>       <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">))],</span>
                                                    <span class="s">&#39;barplot&#39;</span>      <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mf">0.0000001</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">120</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">120</span><span class="p">))],</span>
                                                    <span class="s">&#39;1337&#39;</span>         <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">)),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,(</span><span class="mi">77</span><span class="p">,</span><span class="mi">77</span><span class="p">,</span><span class="mi">77</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="p">,(</span><span class="o">+</span><span class="mf">0.02</span><span class="p">,(</span><span class="mi">77</span><span class="p">,</span><span class="mi">77</span><span class="p">,</span><span class="mi">77</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="p">],</span>
                                                    <span class="s">&#39;BrBG&#39;</span>         <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">166</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">26</span><span class="p">)),</span>  <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">223</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">125</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">245</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">245</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">193</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">113</span><span class="p">))</span> <span class="p">],</span>
                                                    <span class="s">&#39;PiYG&#39;</span>         <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">208</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">139</span><span class="p">)),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">241</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">218</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">247</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">247</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">184</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">134</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">77</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">38</span><span class="p">))</span> <span class="p">],</span>
                                                    <span class="s">&#39;PRGn&#39;</span>         <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">148</span><span class="p">)),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">194</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">207</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">247</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">247</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">166</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">160</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">55</span><span class="p">))</span> <span class="p">],</span>
                                                    <span class="s">&#39;PuOr&#39;</span>         <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>   <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">253</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">99</span><span class="p">)),</span>  <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">247</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">247</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">178</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">210</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">94</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">153</span><span class="p">))</span> <span class="p">],</span>
                                                    <span class="s">&#39;RdBu&#39;</span>         <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">202</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>   <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">244</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">130</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">247</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">247</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">146</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">222</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">176</span><span class="p">)),</span> <span class="p">],</span>
                                                    <span class="s">&#39;RdGy&#39;</span>         <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">202</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>   <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">244</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">130</span><span class="p">)),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)),</span> <span class="p">],</span>
                                                    <span class="s">&#39;RdYlBu&#39;</span>       <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">215</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">28</span><span class="p">)),</span>  <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">253</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">97</span><span class="p">)),</span>  <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">191</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">171</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">233</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">182</span><span class="p">)),</span> <span class="p">],</span>
                                                    <span class="s">&#39;RdYlGn&#39;</span>       <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">215</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">28</span><span class="p">)),</span>  <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">253</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">97</span><span class="p">)),</span>  <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">191</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">166</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">106</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">65</span><span class="p">)),</span> <span class="p">],</span>
                                                    <span class="s">&#39;Spectral&#39;</span>     <span class="p">:</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">215</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">28</span><span class="p">)),</span>  <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">253</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">97</span><span class="p">)),</span>  <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">191</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">171</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">164</span><span class="p">)),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">43</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">186</span><span class="p">)),</span> <span class="p">],</span>
                                        <span class="p">},</span>
                                        <span class="s">&#39;SVG box styles&#39;</span>  <span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;modern&#39;</span> <span class="p">:</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">            &lt;g id=&quot;rowPos{0}_conPos{1}&quot;&gt;</span>
<span class="s">                &lt;title&gt;{ratio}&amp;#177;{std} - [{x0}.{y0} w:{width} h:{height}&lt;/title&gt;</span>
<span class="s">                &lt;rect x=&quot;{x0}&quot; y=&quot;{y0}&quot; width=&quot;{width}&quot; height=&quot;{height}&quot; style=&quot;fill:rgb({r},{g},{b});fill-opacity:0.2;stroke:white;stroke-width:1;&quot; title=&quot;{ratio}&amp;#177;{std}&quot; /&gt;</span>
<span class="s">                &lt;path d = &quot;M {x0} {y0} L {x3} {y0} L {x2} {y1} L {x1} {y1} L {x1} {y2} L {x0} {y3} L {x0} {y0}&quot; style=&quot;fill:rgb({r},{g},{b});stroke:black;stroke-width:1;stroke-opacity:0.0;&quot;/&gt;</span>
<span class="s">                &lt;path d = &quot;M {x2} {y2} L {x1} {y2} L {x2} {y1} L {x2} {y2}&quot; style=&quot;fill:rgb({r},{g},{b});stroke:black;stroke-width:1;stroke-opacity:0.0;&quot;/&gt;</span>
<span class="s">                &lt;path d = &quot;M {x1} {y1} L {x1} {y2} L {x2} {y1} L {x1} {y1}&quot; style=&quot;fill:rgb({r},{g},{b}); fill-opacity:0.7; stroke:red;stroke-width:1;stroke-opacity:0.0;&quot;/&gt;</span>
<span class="s">            &lt;/g&gt;&#39;&#39;&#39;</span><span class="p">,</span>

            <span class="s">&#39;fusion&#39;</span> <span class="p">:</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">            &lt;g id=&quot;rowPos{0}_conPos{1}&quot;&gt;</span>
<span class="s">                &lt;title&gt;{ratio}&amp;#177;{std} - [{x0}.{y0} w:{width} h:{height}&lt;/title&gt;</span>
<span class="s">                &lt;rect x=&quot;{x0}&quot; y=&quot;{y0}&quot; width=&quot;{width}&quot; height=&quot;{height}&quot; style=&quot;fill:rgb({r},{g},{b});fill-opacity:0.7;stroke:white;stroke-width:1;&quot; title=&quot;{ratio}&amp;#177;{std}&quot; /&gt;</span>
<span class="s">                &lt;path d = &quot;M {x0} {y0} L {x3} {y0} L {x2} {y1} L {x1} {y1} L {x1} {y2} L {x0} {y3} L {x0} {y0}&quot; style=&quot;fill:rgb({r},{g},{b});stroke:black;stroke-width:1;stroke-opacity:0.0;&quot;/&gt;</span>
<span class="s">                &lt;path d = &quot;M {x2} {y2} L {x1} {y2} L {x2} {y1} L {x2} {y2}&quot; style=&quot;fill:rgb({r},{g},{b});stroke:black;stroke-width:1;stroke-opacity:0.0;&quot;/&gt;</span>
<span class="s">                &lt;path d = &quot;M {x1} {y1} L {x1} {y2} L {x2} {y1} L {x1} {y1}&quot; style=&quot;fill:rgb({r},{g},{b}); fill-opacity:0.7; stroke:red;stroke-width:1;stroke-opacity:0.0;&quot;/&gt;</span>
<span class="s">                &lt;rect x=&quot;{x1}&quot; y=&quot;{y1}&quot; width=&quot;{widthNew}&quot; height=&quot;{heightNew}&quot; style=&quot;fill:None;stroke:black;stroke-width:1;&quot; title=&quot;{ratio}&amp;#177;{std}&quot; /&gt;</span>

<span class="s">            &lt;/g&gt;&#39;&#39;&#39;</span><span class="p">,</span>

            <span class="s">&#39;classic&#39;</span> <span class="p">:</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">                &lt;g id=&quot;rowPos{0}_conPos{1}&quot;&gt;</span>
<span class="s">                    &lt;title&gt;{ratio}&amp;#177;{std} - [{x0}.{y0} w:{width} h:{height}&lt;/title&gt;</span>
<span class="s">                    &lt;rect x=&quot;{x0}&quot; y=&quot;{y0}&quot; width=&quot;{width}&quot; height=&quot;{height}&quot; style=&quot;fill:rgb({r},{g},{b});stroke:white;stroke-width:1;&quot; title=&quot;{ratio}&amp;#177;{std}&quot; /&gt;</span>
<span class="s">                    &lt;rect x=&quot;{x1}&quot; y=&quot;{y1}&quot; width=&quot;{widthNew}&quot; height=&quot;{heightNew}&quot; style=&quot;fill:None;stroke:black;stroke-width:1;&quot; title=&quot;{ratio}&amp;#177;{std}&quot; /&gt;</span>
<span class="s">                &lt;/g&gt;&#39;&#39;&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c"># check if data is valid, i.e. contains a value for each condition</span>
        <span class="n">data_as_ordered_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="c"># determine number of different conditions:</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">conditions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c"># discard entry if any condition is missing:</span>
                <span class="n">missing_conditions</span> <span class="o">=</span> <span class="n">conditions</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_conditions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">data</span> <span class="p">):</span>
                <span class="n">data_as_ordered_dict</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="p">):</span>
                    <span class="n">data_as_ordered_dict</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]</span>  <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">conditions</span> <span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">]</span>        <span class="o">=</span> <span class="n">data_as_ordered_dict</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Identifiers&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_data_is_log2_transformed</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ WARNING ] there are NO ratios &lt; 0! Is the data log2 transformed?&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;pyGCluster initialized with {0} objects among {1} different conditions.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">),</span> <span class="nb">len</span><span class="p">(</span> <span class="n">conditions</span> <span class="p">)</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Cluster.draw_expression_map"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.draw_expression_map">[docs]</a>    <span class="k">def</span> <span class="nf">draw_expression_map</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">conditions</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">additional_labels</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">min_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">expression_map_filename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">legend_filename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">color_gradient</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">,</span> <span class="n">box_style</span> <span class="o">=</span> <span class="s">&#39;classic&#39;</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Draws expression map as SVG</span>

<span class="sd">        :param min_value_4_expression_map: lower bound for color coding of values in the expression map. Remember that log2-values are expected, i.e. this value should be &lt; 0!</span>
<span class="sd">        :type min_value_4_expression_map: float</span>
<span class="sd">        :param max_value_4_expression_map: upper bound for color coding of values in the expression map.</span>
<span class="sd">        :type max_value_4_expression_map: float</span>
<span class="sd">        :param color_gradient: name of the color gradient used for plotting the expression map. Currently supported are default, Daniel, barplot, 1337, BrBG, PiYG, PRGn, PuOr, RdBu, RdGy, RdYlBu, RdYlGn and Spectral</span>
<span class="sd">        :type color_gradient: string</span>
<span class="sd">        :param expression_map_filename: file name for expression map. .svg will be added if required.</span>
<span class="sd">        :type expression_map_filename: string</span>
<span class="sd">        :param legend_filename: file name for legend .svg will be added if required.</span>
<span class="sd">        :type legend_filename: string</span>
<span class="sd">        :param box_style: the way the relative standard deviation is visualized in the expression map. Currently supported are &#39;modern&#39;, &#39;fusion&#39; or &#39;classic&#39;.</span>
<span class="sd">        :type box_style: string</span>
<span class="sd">        :param additional_labels: dictionary, where additional labels can be defined which will be added in the expression map plots to the gene/protein names</span>
<span class="sd">        :type additional_labels: dict</span>

<span class="sd">        :rtype: none</span>

<span class="sd">        Data has to be a nested dict in the following format:</span>
<span class="sd">            &gt;&gt;&gt;  data =   {</span>
<span class="sd">            ...         fastaID1 : {</span>
<span class="sd">            ...                 cond1 : ( mean, sd ) , cond2 : ( mean, sd ), ...</span>
<span class="sd">            ...         }</span>
<span class="sd">            ...         fastaID2 : {</span>
<span class="sd">            ...                 cond1 : ( mean, sd ) , cond2 : ( mean, sd ), ...</span>
<span class="sd">            ...         }</span>
<span class="sd">            ...  }</span>

<span class="sd">        optional and, if needed, data will be extracted from</span>
<span class="sd">            | self[ &#39;Data&#39; ]</span>
<span class="sd">            | self[ &#39;Identifiers&#39; ]</span>
<span class="sd">            | self[ &#39;Conditions&#39; ]</span>



<span class="sd">        &#39;&#39;&#39;</span>


        <span class="k">if</span> <span class="n">additional_labels</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">additional_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">conditions</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">conditions</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">conditions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span> <span class="n">conditions</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">identifiers</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">identifiers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">))</span>
        <span class="c">#</span>
        <span class="c"># Updating self[ &#39;Additional labels&#39; ]</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="n">additional_labels</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">additional_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">identifier</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Additional labels&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Additional labels&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c"># self[ &#39;Additional labels&#39; ][ identifier ] += additional_labels[ identifier ]</span>
        <span class="c">#</span>
        <span class="c"># Updating min/max if required</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="n">max_value_4_expression_map</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;max&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">max_value_4_expression_map</span>
        <span class="k">if</span> <span class="n">min_value_4_expression_map</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;min&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">min_value_4_expression_map</span>
        <span class="c">#</span>
        <span class="c"># determine range id needed</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;min&#39;</span> <span class="p">]</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;max&#39;</span> <span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">allValues</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">allValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;min&#39;</span> <span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;min&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span> <span class="nb">min</span><span class="p">(</span> <span class="n">allValues</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;max&#39;</span> <span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;max&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span> <span class="n">allValues</span> <span class="p">)</span> <span class="p">)</span>
        <span class="c">#</span>
        <span class="c"># setting default color gradient if match is found</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="n">color_gradient</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">color_gradient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span> <span class="s">&#39;Color Gradients&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Do not know color gradient {0}, falling back to default&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">color_gradient</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">color_gradient</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;color gradient&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">color_gradient</span>
        <span class="c">#</span>
        <span class="c">#</span>
        <span class="c">#</span>
        <span class="k">if</span> <span class="n">expression_map_filename</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;heat map filename&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">expression_map_filename</span>
        <span class="k">if</span> <span class="n">legend_filename</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;legend filename&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">legend_filename</span>

        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;expression profile filename&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;heat map filename&#39;</span> <span class="p">]</span><span class="o">+</span><span class="s">&#39;_expP.svg&#39;</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;heat map filename&#39;</span><span class="p">,</span> <span class="s">&#39;legend filename&#39;</span><span class="p">,</span> <span class="s">&#39;expression profile filename&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s">&#39;.svg&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="n">filename</span> <span class="p">]:</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="n">filename</span> <span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;.svg&#39;</span>
        <span class="c">#</span>
        <span class="c"># recalculate topBorder</span>
        <span class="c">#</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">conditions</span> <span class="p">):</span>
            <span class="n">lineHeight</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">line</span> <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;font size&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lineHeight</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;top border&#39;</span> <span class="p">]:</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;top border&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">lineHeight</span>

        <span class="c">#</span>
        <span class="c">#</span>
        <span class="c">#</span>
        <span class="n">expProf</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span> <span class="p">[]</span> <span class="p">)</span> <span class="p">,</span> <span class="s">&#39;require a list of identifiers!&#39;</span>
        <span class="c"># self._draw_expression_map_legend()</span>
        <span class="n">svgOut</span>               <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;heat map filename&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">svgWidth</span>             <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">conditions</span> <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;rBox width&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;left border&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;text width&#39;</span><span class="p">]</span>
        <span class="n">svgHeight</span>            <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">identifiers</span> <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;rBox height&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;top border&#39;</span><span class="p">]</span>
        <span class="n">number_of_separators</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;svg</span>
<span class="s">        xmlns=&quot;http://www.w3.org/2000/svg&quot;</span>
<span class="s">        version=&quot;1.1&quot;</span>
<span class="s">        preserveAspectRatio=&quot;xMinYMin meet&quot;</span>
<span class="s">        width=&quot;{0}&quot;</span>
<span class="s">        height=&quot;{1}&quot;</span>
<span class="s">        font-size=&quot;{font size}px&quot;</span>
<span class="s">        font-family=&quot;{font family}&quot;</span>
<span class="s">        fill=&quot;black&quot;</span>
<span class="s">        text-anchor=&quot;beginning&quot;</span>
<span class="s">        baseline-alignment=&quot;middle&quot;</span>
<span class="s">        &gt;</span>
<span class="s">        &lt;title&gt;{title}&lt;/title&gt;</span>
<span class="s">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">svgWidth</span><span class="p">,</span>
                <span class="n">svgHeight</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">]</span>
            <span class="p">),</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="n">svgOut</span>
        <span class="p">)</span>
        <span class="c">#</span>
        <span class="c"># write top legend</span>
        <span class="c">#</span>
        <span class="k">for</span> <span class="n">condPos</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">conditions</span> <span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;left border&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">condPos</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;top border&#39;</span> <span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;text spacing&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">print</span><span class="p">(</span>  <span class="nb">unicode</span><span class="p">(</span>
                            <span class="s">&#39;            &lt;text x=&quot;{0}&quot; y=&quot;{1}&quot; text-anchor=&quot;left&quot; transform=&quot;rotate(-90, {0}, {1})&quot;&gt;{2}&lt;/text&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">x</span><span class="p">,</span>
                            <span class="n">y</span><span class="p">,</span>
                            <span class="n">condition</span>
                            <span class="p">),</span>
                    <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;replace&#39;</span>
                    <span class="p">),</span>
                    <span class="nb">file</span> <span class="o">=</span> <span class="n">svgOut</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">rowPos</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">identifiers</span> <span class="p">):</span>
            <span class="n">adjustedRowPos</span> <span class="o">=</span> <span class="n">rowPos</span> <span class="o">-</span> <span class="n">number_of_separators</span>
            <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="s">&#39;_placeholder_&#39;</span><span class="p">:</span>
                <span class="n">shapeDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HM_calcShapeAndColor</span><span class="p">(</span>
                                                        <span class="n">x</span>                    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">y</span>                    <span class="o">=</span> <span class="n">adjustedRowPos</span><span class="p">,</span>
                                                        <span class="n">ratio</span>                <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">std</span>                  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">number_of_separators</span> <span class="o">=</span> <span class="n">number_of_separators</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x1_separator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x0&#39;</span><span class="p">]</span>
                <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x2_separator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span>  <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">conditions</span> <span class="p">))</span>
                <span class="k">print</span><span class="p">(</span> <span class="nb">unicode</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">                            &lt;line x1=&quot;{x1_separator}&quot; y1=&quot;{y0}&quot; x2=&quot;{x2_separator}&quot; y2=&quot;{y0}&quot; style=&quot;stroke:rgb{0};stroke-width:{1}&quot;/&gt;</span>
<span class="s">                            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;default color&#39;</span><span class="p">],</span>
                                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;separator width&#39;</span><span class="p">],</span>
                                    <span class="o">**</span><span class="n">shapeDict</span>
                                <span class="p">),</span>
                        <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;replace&#39;</span>
                        <span class="p">),</span>
                    <span class="nb">file</span> <span class="o">=</span> <span class="n">svgOut</span>
                <span class="p">)</span>
                <span class="n">number_of_separators</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expProf</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[]</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">conPos</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">conditions</span> <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ratio</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span>
                        <span class="n">insertion_point</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">expProf</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="o">-</span><span class="mi">1</span> <span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="c"># first entry in profile</span>
                        <span class="n">expProf</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="o">-</span><span class="mi">1</span> <span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">insertion_point</span><span class="p">,</span>  <span class="n">ratio</span> <span class="o">-</span> <span class="n">std</span> <span class="p">)</span>
                        <span class="n">expProf</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="o">-</span><span class="mi">1</span> <span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">insertion_point</span><span class="p">,</span>  <span class="n">ratio</span> <span class="o">+</span> <span class="n">std</span> <span class="p">)</span>

                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">ratio</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
                        <span class="n">expProf</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[]</span> <span class="p">)</span>

                    <span class="n">shapeDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HM_calcShapeAndColor</span><span class="p">(</span>
                                                            <span class="n">x</span>                    <span class="o">=</span> <span class="n">conPos</span><span class="p">,</span>
                                                            <span class="n">y</span>                    <span class="o">=</span> <span class="n">adjustedRowPos</span><span class="p">,</span>
                                                            <span class="n">ratio</span>                <span class="o">=</span> <span class="n">ratio</span><span class="p">,</span>
                                                            <span class="n">std</span>                  <span class="o">=</span> <span class="n">std</span><span class="p">,</span>
                                                            <span class="n">number_of_separators</span> <span class="o">=</span> <span class="n">number_of_separators</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">print</span><span class="p">(</span> <span class="nb">unicode</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;Heat map&#39;</span><span class="p">][</span><span class="s">&#39;SVG box styles&#39;</span><span class="p">][</span> <span class="n">box_style</span> <span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">rowPos</span><span class="p">,</span>
                                        <span class="n">conPos</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">shapeDict</span>
                                        <span class="p">),</span>
                                    <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;replace&#39;</span>
                                    <span class="p">),</span>
                        <span class="nb">file</span> <span class="o">=</span> <span class="n">svgOut</span>
                    <span class="p">)</span>

                <span class="c">#</span>

                <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x_text&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="p">(</span><span class="n">conPos</span> <span class="o">+</span> <span class="mi">1</span>  <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;left border&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;text spacing&#39;</span><span class="p">]</span>
                <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y_text&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="p">(</span><span class="n">adjustedRowPos</span> <span class="o">+</span> <span class="mf">0.77</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox height&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;top border&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;separator width&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_separators</span><span class="p">)</span>
                <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="s">&#39;{0} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">identifier</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">additional_labels</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">]</span> <span class="o">+=</span>  <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">additional_labels</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">])</span>

                <span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Additional labels&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">]</span> <span class="o">+=</span>  <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Additional labels&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">])</span>

                <span class="k">print</span><span class="p">(</span> <span class="nb">unicode</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">            &lt;g id=&quot;Text rowPos{0}_conPos{1}&quot;&gt;</span>
<span class="s">                &lt;title&gt;{ratio}&amp;#177;{std}&lt;/title&gt;</span>
<span class="s">                &lt;text xml:space=&#39;preserve&#39; x=&quot;{x_text}&quot; y=&quot;{y_text}&quot;&gt;{text}&lt;/text&gt;</span>
<span class="s">            &lt;/g&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">rowPos</span><span class="p">,</span>
                                    <span class="n">conPos</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">shapeDict</span>
                                    <span class="p">),</span>
                                <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;replace&#39;</span>
                                <span class="p">),</span>
                    <span class="nb">file</span> <span class="o">=</span> <span class="n">svgOut</span>
                <span class="p">)</span>

        <span class="c"># eof</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;&lt;/svg&gt;&quot;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">svgOut</span> <span class="p">)</span>
        <span class="n">svgOut</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c">#</span>
        <span class="c"># Drawing legend</span>
        <span class="c">#</span>
        <span class="n">svgLegendOut</span>         <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;legend filename&#39;</span><span class="p">]</span> <span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">svgWidth</span>             <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">conditions</span> <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;rBox width&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;left border&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;text width&#39;</span><span class="p">]</span>
        <span class="n">svgHeight</span>            <span class="o">=</span> <span class="mi">11</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;rBox height&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;top border&#39;</span><span class="p">]</span>
        <span class="n">number_of_separators</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;svg</span>
<span class="s">        xmlns=&quot;http://www.w3.org/2000/svg&quot;</span>
<span class="s">        version=&quot;1.1&quot;</span>
<span class="s">        preserveAspectRatio=&quot;xMinYMin meet&quot;</span>
<span class="s">        width=&quot;{0}&quot;</span>
<span class="s">        height=&quot;{1}&quot;</span>
<span class="s">        font-size=&quot;{font size}px&quot;</span>
<span class="s">        font-family=&quot;{font family}&quot;</span>
<span class="s">        fill=&quot;black&quot;</span>
<span class="s">        text-anchor=&quot;beginning&quot;</span>
<span class="s">        baseline-alignment=&quot;middle&quot;</span>
<span class="s">        &gt;</span>
<span class="s">        &lt;title&gt;Legend&lt;/title&gt;</span>
<span class="s">        &lt;text x=&quot;{2}&quot; y=&quot;{3}&quot; text-anchor=&quot;left&quot; transform=&quot;rotate(-90, {2}, {3})&quot;&gt;ratio&lt;/text&gt;</span>
<span class="s">        &lt;text x=&quot;{4}&quot; y=&quot;{3}&quot; text-anchor=&quot;left&quot; transform=&quot;rotate(-90, {4}, {3})&quot;&gt;rel. std&lt;/text&gt;</span>
<span class="s">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">svgWidth</span><span class="p">,</span>
                <span class="n">svgHeight</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;left border&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;top border&#39;</span> <span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;text spacing&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;left border&#39;</span> <span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="p">),</span>
                <span class="o">**</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">]</span>
            <span class="p">),</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="n">svgLegendOut</span>
        <span class="p">)</span>
        <span class="n">positive_step_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span><span class="s">&#39;Params&#39;</span><span class="p">][</span> <span class="s">&#39;max&#39;</span> <span class="p">]</span> <span class="o">/</span> <span class="mf">5.0</span>
        <span class="n">negative_step_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span><span class="s">&#39;Params&#39;</span><span class="p">][</span> <span class="s">&#39;min&#39;</span> <span class="p">]</span> <span class="o">/</span> <span class="mf">5.0</span>
        <span class="n">number_of_separators</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">-</span> <span class="n">y</span>
            <span class="k">if</span> <span class="n">_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">positive_step_size</span> <span class="o">*</span> <span class="n">_</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">negative_step_size</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">_</span>

            <span class="n">shapeDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HM_calcShapeAndColor</span><span class="p">(</span>
                        <span class="n">x</span>       <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">y</span>       <span class="o">=</span> <span class="n">y</span><span class="p">,</span>
                        <span class="n">ratio</span>   <span class="o">=</span> <span class="n">ratio</span><span class="p">,</span>
                        <span class="n">std</span>     <span class="o">=</span> <span class="mf">0.0</span>
            <span class="p">)</span>
            <span class="k">print</span><span class="p">(</span> <span class="nb">unicode</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;Heat map&#39;</span><span class="p">][</span><span class="s">&#39;SVG box styles&#39;</span><span class="p">][</span> <span class="n">box_style</span> <span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">y</span><span class="p">,</span>
                                        <span class="mi">2</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">shapeDict</span>
                                        <span class="p">),</span>
                                    <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;replace&#39;</span>
                                    <span class="p">),</span>
                        <span class="nb">file</span> <span class="o">=</span> <span class="n">svgLegendOut</span>
            <span class="p">)</span>

            <span class="n">std</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="n">shapeDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HM_calcShapeAndColor</span><span class="p">(</span>
                        <span class="n">x</span>       <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="n">y</span>       <span class="o">=</span> <span class="n">y</span><span class="p">,</span>
                        <span class="n">ratio</span>   <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                        <span class="n">std</span>     <span class="o">=</span> <span class="n">std</span>
            <span class="p">)</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">147</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">147</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">147</span>
            <span class="k">print</span><span class="p">(</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;Heat map&#39;</span><span class="p">][</span><span class="s">&#39;SVG box styles&#39;</span><span class="p">][</span> <span class="n">box_style</span> <span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">y</span><span class="p">,</span>
                                        <span class="mi">3</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">shapeDict</span>
                                        <span class="p">),</span>
                                    <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;replace&#39;</span>
                                    <span class="p">),</span>
                        <span class="nb">file</span> <span class="o">=</span> <span class="n">svgLegendOut</span>
            <span class="p">)</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x_text_left&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;left border&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;text spacing&#39;</span><span class="p">]</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x_text_right&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;left border&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;text spacing&#39;</span><span class="p">]</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y_text_left&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.77</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox height&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;top border&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;separator width&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_separators</span><span class="p">)</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;text_left&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="s">&#39;{0:3.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">ratio</span> <span class="p">)</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;text_right&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="s">&#39;{0:2.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">std</span> <span class="p">)</span>

            <span class="k">print</span><span class="p">(</span> <span class="nb">unicode</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">                    &lt;g id=&quot;Legend {0}&quot;&gt;</span>
<span class="s">                        &lt;title&gt;{ratio}&amp;#177;{std}&lt;/title&gt;</span>
<span class="s">                        &lt;text xml:space=&#39;preserve&#39; x=&quot;{x_text_left}&quot; y=&quot;{y_text_left}&quot;&gt;{text_left}&lt;/text&gt;</span>
<span class="s">                        &lt;text xml:space=&#39;preserve&#39; x=&quot;{x_text_right}&quot; y=&quot;{y_text_left}&quot;&gt;{text_right}&lt;/text&gt;</span>
<span class="s">                    &lt;/g&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">y</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">shapeDict</span>
                                    <span class="p">),</span>
                                <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;replace&#39;</span>
                                <span class="p">),</span>
                    <span class="nb">file</span> <span class="o">=</span> <span class="n">svgLegendOut</span>
            <span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;&lt;/svg&gt;&quot;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">svgLegendOut</span> <span class="p">)</span>
        <span class="n">svgLegendOut</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>
</div>
    <span class="k">def</span> <span class="nf">_HM_calcShapeAndColor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">number_of_separators</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Internal function to determine shape and color of expression map entries</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">shapeDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;ratio&#39;</span><span class="p">]</span>                             <span class="o">=</span> <span class="n">ratio</span>
        <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;std&#39;</span><span class="p">]</span>                               <span class="o">=</span> <span class="n">std</span>
        <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">],</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">],</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HM_visualizeColor</span><span class="p">(</span> <span class="n">ratio</span> <span class="p">)</span>
        <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x0&#39;</span><span class="p">]</span>                                 <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;left border&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span>  <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y0&#39;</span><span class="p">]</span>                                 <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;top border&#39;</span><span class="p">]</span>  <span class="o">+</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox height&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;width&#39;</span><span class="p">]</span>                             <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span>
        <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;height&#39;</span><span class="p">]</span>                            <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox height&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">std</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ratio</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span> <span class="c"># or std != 0.0:</span>
            <span class="k">if</span> <span class="n">std</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># ratio and sd for this entry are None, this will lead to white box</span>
                <span class="n">stdAsPercentOfRatio</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">ratio</span> <span class="o">+=</span> <span class="mf">0.01</span>
                <span class="n">stdAsPercentOfRatio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">std</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">ratio</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">stdAsPercentOfRatio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">stdAsPercentOfRatio</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;widthNew&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stdAsPercentOfRatio</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span>  <span class="p">))</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;heightNew&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">stdAsPercentOfRatio</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox height&#39;</span><span class="p">]</span> <span class="p">))</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x1&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x0&#39;</span><span class="p">]</span>  <span class="o">+</span>  <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox width&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;widthNew&#39;</span><span class="p">]))</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y1&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y0&#39;</span><span class="p">]</span>  <span class="o">+</span>  <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;rBox height&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;heightNew&#39;</span><span class="p">]))</span>

            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y0&#39;</span><span class="p">]</span>                <span class="o">+=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;separator width&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_separators</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y1&#39;</span><span class="p">]</span>             <span class="o">+=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span><span class="s">&#39;separator width&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">number_of_separators</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;height_half&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;height&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y3&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;height&#39;</span><span class="p">]</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x3&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;width&#39;</span><span class="p">]</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;y1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;heightNew&#39;</span><span class="p">]</span>
            <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x2&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;x1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">shapeDict</span><span class="p">[</span><span class="s">&#39;widthNew&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">shapeDict</span>

    <span class="k">def</span> <span class="nf">_HM_visualizeColor</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ratio</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        determine color for expression map values</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">##</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span><span class="p">][</span> <span class="s">&#39;Params&#39;</span> <span class="p">][</span> <span class="s">&#39;default color&#39;</span> <span class="p">][:]</span>
        <span class="n">colorGradient</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span> <span class="s">&#39;Color Gradients&#39;</span> <span class="p">][</span>  <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span><span class="s">&#39;Params&#39;</span><span class="p">][</span><span class="s">&#39;color gradient&#39;</span><span class="p">]</span>  <span class="p">]</span>
        <span class="k">if</span> <span class="n">ratio</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span><span class="s">&#39;Params&#39;</span><span class="p">][</span> <span class="s">&#39;max&#39;</span> <span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">colorGradient</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scaling</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Heat map&#39;</span> <span class="p">][</span><span class="s">&#39;Params&#39;</span><span class="p">][</span> <span class="s">&#39;min&#39;</span> <span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">colorGradient</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>

            <span class="n">scaled_ratio</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">/</span> <span class="n">scaling</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect</span><span class="p">(</span>  <span class="n">colorGradient</span><span class="p">,</span> <span class="p">(</span> <span class="n">scaled_ratio</span><span class="p">,</span> <span class="p">)</span>  <span class="p">)</span>

            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span>  <span class="n">colorGradient</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span> <span class="n">colorGradient</span><span class="p">):</span>
                <span class="n">color</span> <span class="o">=</span>  <span class="n">colorGradient</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># linear interpolation ... between idx-1 &amp; idx</span>
                <span class="n">dX</span> <span class="o">=</span> <span class="p">(</span> <span class="n">scaled_ratio</span> <span class="o">-</span>  <span class="n">colorGradient</span><span class="p">[</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">][</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span>  <span class="n">colorGradient</span><span class="p">[</span> <span class="n">idx</span> <span class="p">][</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">-</span> <span class="n">colorGradient</span><span class="p">[</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">][</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">color_chanel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">d_</span> <span class="o">=</span> <span class="n">dX</span> <span class="o">*</span> <span class="p">(</span> <span class="n">colorGradient</span><span class="p">[</span> <span class="n">idx</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">][</span> <span class="n">color_chanel</span> <span class="p">]</span> <span class="o">-</span>  <span class="n">colorGradient</span><span class="p">[</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">][</span> <span class="n">color_chanel</span> <span class="p">])</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">d_</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span> <span class="p">:</span>
                        <span class="n">color</span><span class="p">[</span> <span class="n">color_chanel</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="n">colorGradient</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span> <span class="mi">1</span> <span class="p">][</span> <span class="n">color_chanel</span> <span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">color</span><span class="p">[</span> <span class="n">color_chanel</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="n">colorGradient</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span> <span class="mi">1</span> <span class="p">][</span> <span class="n">color_chanel</span> <span class="p">]</span> <span class="o">+</span> <span class="n">d_</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">color</span>

<div class="viewcode-block" id="Cluster.draw_expression_map_for_cluster"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.draw_expression_map_for_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">draw_expression_map_for_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusterID</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">cluster</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">min_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">color_gradient</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">box_style</span> <span class="o">=</span> <span class="s">&#39;classic&#39;</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plots an expression map for a given cluster.</span>
<span class="sd">        Either the parameter &quot;clusterID&quot; or &quot;cluster&quot; can be defined.</span>
<span class="sd">        This function is useful to plot a user-defined cluster, e.g. knowledge-based cluster (TCA-cluster, Glycolysis-cluster ...). In this case, the parameter &quot;cluster&quot; should be defined.</span>

<span class="sd">        :param clusterID: ID of a cluster (those are obtained e.g. from the plot of cluster frequencies or the node map)</span>
<span class="sd">        :type clusterID: int</span>
<span class="sd">        :param cluster: tuple containing the indices of the objects describing a cluster.</span>
<span class="sd">        :type cluster: tuple</span>
<span class="sd">        :param filename: name of the SVG file for the expression map.</span>
<span class="sd">        :type filename: string</span>

<span class="sd">        The following parameters are passed to :py:func:`pyGCluster.Cluster.draw_expression_map`:</span>

<span class="sd">        :param min_value_4_expression_map: lower bound for color coding of values in the expression map. Remember that log2-values are expected, i.e. this value should be &lt; 0!</span>
<span class="sd">        :type min_value_4_expression_map: float</span>
<span class="sd">        :param max_value_4_expression_map: upper bound for color coding of values in the expression map.</span>
<span class="sd">        :type max_value_4_expression_map: float</span>
<span class="sd">        :param color_gradient: name of the color gradient used for plotting the expression map. Currently supported are default, Daniel, barplot, 1337, BrBG, PiYG, PRGn, PuOr, RdBu, RdGy, RdYlBu, RdYlGn and Spectral</span>
<span class="sd">        :type color_gradient: string</span>
<span class="sd">        :param box_style: name of box style used in SVG. Currently supported are classic, modern, fusion.</span>
<span class="sd">        :type box_style: string</span>


<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># check if function call was valid:</span>
        <span class="k">if</span> <span class="n">clusterID</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cluster</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ ERROR ] call function &quot;draw_expression_map_for_cluster&quot; with either a clusterID or a cluster.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">clusterID</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cluster</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ ERROR ] call function &quot;draw_expression_map_for_cluster&quot; with either a clusterID or a cluster.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="k">return</span>
        <span class="c"># if clusterID is given, get the corresponding cluster:</span>
        <span class="k">elif</span> <span class="n">clusterID</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">cID</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">cID</span> <span class="o">==</span> <span class="n">clusterID</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">c</span>

        <span class="c"># determine hm_filename:</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;{0}.svg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">hm_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">filename</span> <span class="p">)</span>
        <span class="c"># prepare for drawing of expression map ...</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">additional_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cFreq</span><span class="p">,</span> <span class="n">cFreqDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">(</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">cluster</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">cFreq</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Identifiers&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">]</span>
            <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">identifier</span> <span class="p">)</span>
            <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]:</span>
                <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span>
            <span class="n">additional_labels</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;{0:3.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">cFreq</span> <span class="p">)</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_expression_map</span><span class="p">(</span>
            <span class="n">identifiers</span>       <span class="o">=</span> <span class="n">identifiers</span><span class="p">,</span>
            <span class="n">data</span>              <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
            <span class="n">conditions</span>        <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">],</span>
            <span class="n">additional_labels</span> <span class="o">=</span> <span class="n">additional_labels</span><span class="p">,</span>
            <span class="n">min_value_4_expression_map</span>              <span class="o">=</span> <span class="n">min_value_4_expression_map</span><span class="p">,</span>
            <span class="n">max_value_4_expression_map</span>              <span class="o">=</span> <span class="n">max_value_4_expression_map</span><span class="p">,</span>
            <span class="n">expression_map_filename</span> <span class="o">=</span> <span class="n">hm_filename</span><span class="p">,</span>
            <span class="n">legend_filename</span>   <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">color_gradient</span>    <span class="o">=</span> <span class="n">color_gradient</span><span class="p">,</span>
            <span class="n">box_style</span>         <span class="o">=</span> <span class="n">box_style</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;... expression map saved as &quot;{0}&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">hm_filename</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.draw_expression_map_for_community_cluster"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.draw_expression_map_for_community_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">draw_expression_map_for_community_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">min_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">color_gradient</span> <span class="o">=</span> <span class="s">&#39;1337&#39;</span><span class="p">,</span> <span class="n">sub_folder</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">min_obcofreq_2_plot</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">box_style</span> <span class="o">=</span> <span class="s">&#39;classic&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plots the expression map for a given &quot;community cluster&quot;:</span>
<span class="sd">        Any cluster in the community node map is internally represented as a tuple with two elements:</span>
<span class="sd">        &quot;cluster&quot; and &quot;level&quot;. Those objects are stored as keys in self[ &#39;Communities&#39; ],</span>
<span class="sd">        from where they may be extracted and fed into this function.</span>

<span class="sd">        :param name: &quot;community cluster&quot; -&gt; best obtain from self[ &#39;Communities&#39; ].keys()</span>
<span class="sd">        :type name: tuple</span>
<span class="sd">        :param min_obcofreq_2_plot: minimum obCoFreq of an cluster&#39;s object to be shown in the expression map.</span>
<span class="sd">        :type min_obcofreq_2_plot: float</span>

<span class="sd">        The following parameters are passed to :py:func:`pyGCluster.Cluster.draw_expression_map`:</span>

<span class="sd">        :param min_value_4_expression_map: lower bound for color coding of values in the expression map. Remember that log2-values are expected, i.e. this value should be &lt; 0!</span>
<span class="sd">        :type min_value_4_expression_map: float</span>
<span class="sd">        :param max_value_4_expression_map: upper bound for color coding of values in the expression map.</span>
<span class="sd">        :type max_value_4_expression_map: float</span>
<span class="sd">        :param color_gradient: name of the color gradient used for plotting the expression map. Currently supported are default, Daniel, barplot, 1337, BrBG, PiYG, PRGn, PuOr, RdBu, RdGy, RdYlBu, RdYlGn and Spectral</span>
<span class="sd">        :type color_gradient: string</span>
<span class="sd">        :param box_style: name of box style used in SVG. Currently supported are classic, modern, fusion.</span>
<span class="sd">        :type box_style: string</span>
<span class="sd">        :param sub_folder: if specified, the expression map is saved in this folder, rather than in pyGCluster&#39;s working directory.</span>
<span class="sd">        :type sub_folder: string</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">additional_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">]:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">normalized_obCoFreq</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">]</span>
                <span class="k">if</span> <span class="n">normalized_obCoFreq</span> <span class="o">&lt;</span> <span class="n">min_obcofreq_2_plot</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Identifiers&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">]</span>
                <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">identifier</span> <span class="p">)</span>
                <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]:</span>
                    <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span>
                <span class="n">additional_labels</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;{0:3.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">normalized_obCoFreq</span> <span class="p">)</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;_placeholder_&#39;</span> <span class="p">)</span>
        <span class="n">hm_filename</span> <span class="o">=</span> <span class="s">&#39;{0}-{1}.svg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">],</span> <span class="n">name</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">sub_folder</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>  <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">sub_folder</span> <span class="p">)</span> <span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>  <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">sub_folder</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">hm_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">sub_folder</span> <span class="p">,</span> <span class="n">hm_filename</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">draw_expression_map</span><span class="p">(</span>
            <span class="n">identifiers</span>       <span class="o">=</span> <span class="n">identifiers</span><span class="p">,</span>
            <span class="n">data</span>              <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
            <span class="n">conditions</span>        <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">],</span>
            <span class="n">additional_labels</span> <span class="o">=</span> <span class="n">additional_labels</span><span class="p">,</span>
            <span class="n">min_value_4_expression_map</span>              <span class="o">=</span> <span class="n">min_value_4_expression_map</span><span class="p">,</span>
            <span class="n">max_value_4_expression_map</span>              <span class="o">=</span> <span class="n">max_value_4_expression_map</span><span class="p">,</span>
            <span class="n">expression_map_filename</span> <span class="o">=</span> <span class="n">hm_filename</span><span class="p">,</span>
            <span class="n">legend_filename</span>   <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">color_gradient</span>    <span class="o">=</span> <span class="n">color_gradient</span><span class="p">,</span>
            <span class="n">box_style</span>         <span class="o">=</span> <span class="n">box_style</span>
        <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.draw_community_expression_maps"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.draw_community_expression_maps">[docs]</a>    <span class="k">def</span> <span class="nf">draw_community_expression_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">color_gradient</span> <span class="o">=</span> <span class="s">&#39;1337&#39;</span><span class="p">,</span> <span class="n">box_style</span> <span class="o">=</span> <span class="s">&#39;classic&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plots the expression map for each community showing its object composition.</span>

<span class="sd">        The following parameters are passed to :py:func:`pyGCluster.Cluster.draw_expression_map`:</span>

<span class="sd">        :param min_value_4_expression_map: lower bound for color coding of values in the expression map. Remember that log2-values are expected, i.e. this value should be &lt; 0!</span>
<span class="sd">        :type min_value_4_expression_map: float</span>
<span class="sd">        :param max_value_4_expression_map: upper bound for color coding of values in the expression map.</span>
<span class="sd">        :type max_value_4_expression_map: float</span>
<span class="sd">        :param color_gradient: name of the color gradient used for plotting the expression map. Currently supported are default, Daniel, barplot, 1337, BrBG, PiYG, PRGn, PuOr, RdBu, RdGy, RdYlBu, RdYlGn and Spectral</span>
<span class="sd">        :type color_gradient: string</span>
<span class="sd">        :param box_style: name of box style used in SVG. Currently supported are classic, modern, fusion.</span>
<span class="sd">        :type box_style: string</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">max_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="p">[</span> <span class="n">name</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_levelX_clusters</span><span class="p">(</span> <span class="n">level</span> <span class="o">=</span> <span class="n">max_level</span> <span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">max_level</span> <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;for IO skip clusters bigger than&#39;</span> <span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">additional_labels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">]:</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Identifiers&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">]</span>
                    <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">identifier</span> <span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]:</span>
                        <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span>
                    <span class="n">additional_labels</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;{0:3.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">]</span> <span class="p">)</span> <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;_placeholder_&#39;</span> <span class="p">)</span>
            <span class="n">hm_filename</span> <span class="o">=</span> <span class="s">&#39;{0}-{1}.svg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">],</span> <span class="n">name</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_expression_map</span><span class="p">(</span>
                <span class="n">identifiers</span>       <span class="o">=</span> <span class="n">identifiers</span><span class="p">,</span>
                <span class="n">data</span>              <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
                <span class="n">conditions</span>        <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">],</span>
                <span class="n">additional_labels</span> <span class="o">=</span> <span class="n">additional_labels</span><span class="p">,</span>
                <span class="n">min_value_4_expression_map</span>              <span class="o">=</span> <span class="n">min_value_4_expression_map</span><span class="p">,</span>
                <span class="n">max_value_4_expression_map</span>              <span class="o">=</span> <span class="n">max_value_4_expression_map</span><span class="p">,</span>
                <span class="n">expression_map_filename</span> <span class="o">=</span> <span class="n">hm_filename</span><span class="p">,</span>
                <span class="n">legend_filename</span>   <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                <span class="n">color_gradient</span>    <span class="o">=</span> <span class="n">color_gradient</span><span class="p">,</span>
                <span class="n">box_style</span>         <span class="o">=</span> <span class="n">box_style</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;... community expression maps saved in &quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.delete_resampling_results"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.delete_resampling_results">[docs]</a>    <span class="k">def</span> <span class="nf">delete_resampling_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resets all variables holding any result of the re-sampling process.</span>
<span class="sd">        This includes the convergence determination as well as the community structure.</span>
<span class="sd">        Does not delete the data that is intended to be clustered.</span>

<span class="sd">        :rtype: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span>                                     <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span>                                          <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distances&#39;</span> <span class="p">]</span>                                               <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Linkages&#39;</span> <span class="p">]</span>                                                <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span>                           <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Iterations&#39;</span> <span class="p">]</span>                                              <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">]</span>                      <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - iteration 2 n_mostfreq&#39;</span> <span class="p">]</span>      <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - first detected at iteration&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]</span>                                             <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Function parameters&#39;</span> <span class="p">]</span>                                     <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.check_if_data_is_log2_transformed"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.check_if_data_is_log2_transformed">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_data_is_log2_transformed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Simple check if any value of the data_tuples (i.e. any mean) is below zero.</span>
<span class="sd">        Below zero indicates that the input data was log2 transformed.</span>

<span class="sd">        :rtype: boolean</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">condition</span><span class="p">,</span> <span class="n">data_tuple</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_tuple</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Adds re-sampling results of a pyGCluster instance into another one.</span>
<span class="sd">        If the clustered data differs among those two instances, the other instance is NOT added.</span>
<span class="sd">        If the distance-linkage combinations among those two instances differ, the other instance is NOT added.</span>

<span class="sd">        :param other: the pyGCluster instance that is to be added to self.</span>
<span class="sd">        :type other: pyGCluster instance</span>

<span class="sd">        :rtype: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">],</span> <span class="s">&#39;[ ERROR ] pyGCluster-instances with different clustered data cannot be merged!&#39;</span>
        <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">other</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">),</span> <span class="s">&#39;[ ERROR ] pyGCluster-instances with a different distance-linkage combinations cannot be merged!&#39;</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Iterations&#39;</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">other</span><span class="p">[</span> <span class="s">&#39;Iterations&#39;</span> <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span> <span class="p">)</span>
        <span class="n">otherDLC2selfDLC</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">other_dlc_index</span><span class="p">,</span> <span class="n">dlc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">other</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">):</span>
            <span class="n">self_dlc_index</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">dlc</span> <span class="p">)</span>
            <span class="n">otherDLC2selfDLC</span><span class="p">[</span> <span class="n">other_dlc_index</span> <span class="p">]</span> <span class="o">=</span> <span class="n">self_dlc_index</span>
        <span class="c"># merge clusters from other into self</span>
        <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">other_clusterID</span> <span class="ow">in</span> <span class="n">other</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cluster</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]:</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="c"># new cluster found, assign index</span>
            <span class="n">self_clusterID</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">other_dlc_index</span><span class="p">,</span> <span class="n">self_dlc_index</span> <span class="ow">in</span> <span class="n">otherDLC2selfDLC</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">self_clusterID</span> <span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">],</span>
                            <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span> <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span> <span class="c"># add rows at bottom</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">self_clusterID</span> <span class="p">][</span> <span class="n">self_dlc_index</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">other</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">other_clusterID</span> <span class="p">][</span> <span class="n">other_dlc_index</span> <span class="p">]</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Cluster.resample"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.resample">[docs]</a>    <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">linkages</span><span class="p">,</span> <span class="n">function_2_generate_noise_injected_datasets</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">min_cluster_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">alphabet</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">force_plotting</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">min_cluster_freq_2_retain</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">pickle_filename</span> <span class="o">=</span> <span class="s">&#39;pyGCluster_resampled.pkl&#39;</span><span class="p">,</span> <span class="n">cpus_2_use</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">iter_tol</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">iter_step</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">iter_max</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">,</span> <span class="n">iter_top_P</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">iter_window</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span> <span class="n">iter_till_the_end</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Routine for the assessment of cluster reproducibility (re-sampling routine).</span>
<span class="sd">        To this, a high number of noise-injected datasets are created, which are subsequently clustered by AHC.</span>
<span class="sd">        Those are created via :py:func:`pyGCluster.function_2_generate_noise_injected_datasets` (default = usage of Gaussian distributions).</span>
<span class="sd">        Each &#39;simulated&#39; dataset is then subjected to AHC x times, where x equals the number of distance-linkage combinations that come from all possible combinations of &quot;distances&quot; and &quot;linkages&quot;.</span>
<span class="sd">        In order to speed up the re-sampling routine, it is distributed to multiple threads, if cpus_2_use &gt; 1.</span>

<span class="sd">        The re-sampling routine stops once either convergence (see below) is detected or iter_max iterations have been performed.</span>
<span class="sd">        Eventually, only clusters with a maximum frequency of at least min_cluster_freq_2_retain are stored; all others are discarded.</span>

<span class="sd">        In order to visually inspect convergence, a convergence plot is created.</span>
<span class="sd">        For more information about the convergence estimation, see Supplementary Material of pyGCluster&#39;s publication.</span>

<span class="sd">        For a complete list of possible</span>
<span class="sd">        Distance matrix calculations</span>
<span class="sd">        see: http://docs.scipy.org/doc/scipy/reference/spatial.distance.html</span>
<span class="sd">        or Linkage methods</span>
<span class="sd">        see: http://docs.scipy.org/doc/scipy/reference/generated/scipy.cluster.hierarchy.linkage.html</span>

<span class="sd">        .. note ::</span>
<span class="sd">            If memory is of concern (e.g. for a large dataset, &gt; 5000 objects), cpus_2_use should be kept low.</span>

<span class="sd">        :param distances: list of distance metrices, given as strings, e.g. [ &#39;correlation&#39;, &#39;euclidean&#39; ]</span>
<span class="sd">        :type distances: list</span>
<span class="sd">        :param linkages: list of distance metrices, given as strings, e.g. [ &#39;average&#39;, &#39;complete&#39;, &#39;ward&#39; ]</span>
<span class="sd">        :type linkages: list</span>
<span class="sd">        :param function_2_generate_noise_injected_datasets: function to generate noise-injected datasets. If None (default), Gaussian distributions are used.</span>
<span class="sd">        :type function_2_generate_noise_injected_datasets: function</span>
<span class="sd">        :param min_cluster_size: minimum size of a cluster, so that it is included in the assessment of cluster reproducibilities.</span>
<span class="sd">        :type min_cluster_size: int</span>
<span class="sd">        :param alphabet: alphabet used to convert decimal indices to characters to save memory. Defaults to string.printable, without &#39;,&#39;.</span>
<span class="sd">        :type alphabet: string</span>

<span class="sd">        .. note ::</span>
<span class="sd">            If alphabet contains &#39;,&#39;, this character is removed from alphabet, because the indices comprising a cluster are saved comma-seperated.</span>

<span class="sd">        :param force_plotting: the convergence plot is created after each iter_step iteration (otherwise only when convergence is detected).</span>
<span class="sd">        :type force_plotting: boolean</span>
<span class="sd">        :param min_cluster_freq_2_retain: ]0, 1[ minimum frequency of a cluster (only the maximum of the dlc-frequencies matters here) it has to exhibit to be stored in pyGCluster once all iterations are finished.</span>
<span class="sd">        :type min_cluster_freq_2_retain: float</span>
<span class="sd">        :param cpus_2_use: number of threads that are evoked in the re-sampling routine.</span>
<span class="sd">        :type cpus_2_use: int</span>
<span class="sd">        :param iter_max: maximum number of re-sampling iterations.</span>
<span class="sd">        :type iter_max: int</span>

<span class="sd">        Convergence determination:</span>

<span class="sd">        :param iter_tol: ]0, 1e-3[ value for the threshold of the median of normalized slopes, in order to declare convergence.</span>
<span class="sd">        :type iter_tol: float</span>
<span class="sd">        :param iter_step: number of iterations each multiprocess performs and simultaneously the interval in which to check for convergence.</span>
<span class="sd">        :type iter_step: int</span>
<span class="sd">        :param iter_top_P: ]0, 1[ for the convergence estmation, the amount of most frequent clusters is examined. This is the threshold for the minimum frequency of a cluster to be included.</span>
<span class="sd">        :type iter_top_P: float</span>
<span class="sd">        :param iter_window: size of the sliding window in iterations. The median is obtained from normalized slopes inside this window - *should be a multiple of iter_step*</span>
<span class="sd">        :type iter_window: int</span>
<span class="sd">        :param iter_till_the_end: if set to True, the convergence determination is switched off; hence, re-sampling is performed until iter_max is reached.</span>
<span class="sd">        :type iter_till_the_end: boolean</span>

<span class="sd">        :rtype: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Function parameters&#39;</span> <span class="p">][</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample</span><span class="o">.</span><span class="n">__name__</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span> <span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">&#39;self&#39;</span> <span class="p">}</span>
        <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="kn">import</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">as</span> <span class="nn">sch</span>
        <span class="kn">import</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">as</span> <span class="nn">ssd</span>

        <span class="k">if</span> <span class="n">function_2_generate_noise_injected_datasets</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">function_2_generate_noise_injected_datasets</span> <span class="o">=</span> <span class="n">yield_noisejected_dataset</span>
        <span class="k">if</span> <span class="n">alphabet</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">alphabet</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span>
        <span class="n">alphabet</span> <span class="o">=</span> <span class="n">alphabet</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span> <span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span> <span class="p">)</span>

        <span class="c">## create distance-linkage combinations (dlc)</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distances&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">distances</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Linkages&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">linkages</span>
        <span class="c"># check if all distance metrices are valid:</span>
        <span class="n">invalid_dists</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distances&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span> <span class="nb">dir</span><span class="p">(</span> <span class="n">ssd</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid_dists</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;[ WARNING ] invalid distance metrices! &quot;{0}&quot; are not in &quot;scipy.spatial.distance&quot;.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">invalid_dists</span> <span class="p">)</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="c"># check if all linkage methods are valid:</span>
        <span class="n">invalid_linkages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Linkages&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="o">-</span> <span class="n">sch</span><span class="o">.</span><span class="n">_cpy_linkage_methods</span>
        <span class="k">if</span> <span class="n">invalid_linkages</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;[ WARNING ] invalid linkage methods! &quot;{0}&quot; are not in &quot;scipy.cluster.hierarchy&quot;.&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">invalid_linkages</span> <span class="p">)</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="c"># get all possible distance-linkage combinations:</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">distance</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distances&#39;</span> <span class="p">]:</span>
            <span class="k">for</span> <span class="n">linkage</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Linkages&#39;</span> <span class="p">]:</span>
                <span class="k">if</span> <span class="n">distance</span> <span class="o">!=</span> <span class="s">&#39;euclidean&#39;</span> <span class="ow">and</span> <span class="n">linkage</span> <span class="ow">in</span> <span class="n">sch</span><span class="o">.</span><span class="n">_cpy_euclid_methods</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;{0}-{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">distance</span><span class="p">,</span> <span class="n">linkage</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">n_dlc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;{0} distance-linkage combinations are evaluated.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">n_dlc</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;... those are: {0}.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>

        <span class="c">## check if permission to write:</span>
        <span class="k">if</span> <span class="n">pickle_filename</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="s">&#39;tmp.txt&#39;</span> <span class="p">),</span> <span class="s">&#39;w&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="s">&#39;tmp.txt&#39;</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;[ WARNING ] You do not have permission, or folder does not exist!</span><span class="se">\n\t</span><span class="s">results in &quot;{0}&quot; are NOT pickled!&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
                <span class="n">pickle_filename</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c">## check if a pickle file with the same name is already in the &quot;Working directory&quot;</span>
        <span class="c">## this indicates that clustering is likely to be continued:</span>
        <span class="k">if</span> <span class="n">pickle_filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;Pickle file with the same name detected! Pickle &quot;{0}&quot; will be loaded and clustering continued ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">pickle_filename</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">()</span>
            <span class="n">loaded</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">pickle_filename</span> <span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span> <span class="o">+</span> <span class="n">loaded</span>

        <span class="c">## create tmp_struct to store the cluster counts:</span>
        <span class="n">tmpstruct_clustercounts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span>         <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span><span class="p">,</span> <span class="n">n_dlc</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span> <span class="p">)</span>
        <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span>    <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Discarded IDs&#39;</span> <span class="p">]</span>          <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c">## initialize variables for the convergence determination</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_step&#39;</span> <span class="p">]</span>     <span class="o">=</span> <span class="n">iter_step</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_top_P&#39;</span> <span class="p">]</span>     <span class="o">=</span> <span class="n">iter_top_P</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_tol&#39;</span> <span class="p">]</span>      <span class="o">=</span> <span class="n">iter_tol</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_window&#39;</span> <span class="p">]</span>   <span class="o">=</span> <span class="n">iter_window</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_max&#39;</span> <span class="p">]</span>      <span class="o">=</span> <span class="n">iter_max</span>
        <span class="k">if</span> <span class="n">iter_window</span> <span class="o">%</span> <span class="n">iter_step</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;[ WARNING ] iter_window = {0} is NOT a multiple of iter_step = {1}. Better re-call with a multiple of iter_step!&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">iter_window</span><span class="p">,</span> <span class="n">iter_step</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>

        <span class="c">## prepare for multiprocesses:</span>
        <span class="k">if</span> <span class="n">cpus_2_use</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cpus_2_use</span> <span class="o">&gt;</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">():</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;[ WARNING ] You requested to perform re-sampling on {0} threads, but only {1} available -&gt; better re-call with &quot;cpus_2_use = {1}&quot;!&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">cpus_2_use</span><span class="p">,</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="n">n_multiprocesses</span> <span class="o">=</span> <span class="n">cpus_2_use</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_multiprocesses</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="n">DataQ</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="n">kwargs4multiprocess</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;DataQ&#39;</span> <span class="p">]</span>                      <span class="o">=</span> <span class="n">DataQ</span>
        <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;data&#39;</span> <span class="p">]</span>                       <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">]</span>
        <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;iterations&#39;</span> <span class="p">]</span>                 <span class="o">=</span> <span class="n">iter_step</span>
        <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;alphabet&#39;</span> <span class="p">]</span>                   <span class="o">=</span> <span class="n">alphabet</span>
        <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;dlc&#39;</span> <span class="p">]</span>                        <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span>
        <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;min_cluster_size&#39;</span> <span class="p">]</span>           <span class="o">=</span> <span class="n">min_cluster_size</span>
        <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;min_cluster_freq_2_retain&#39;</span> <span class="p">]</span>    <span class="o">=</span> <span class="n">min_cluster_freq_2_retain</span>
        <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;function_2_generate_noise_injected_datasets&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">function_2_generate_noise_injected_datasets</span>

        <span class="c">#this does not work on windows... we have to check that</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">getwindowsversion</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">nice</span><span class="p">(</span> <span class="mi">10</span> <span class="p">)</span>
        <span class="n">min_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">min_cluster_freq_2_retain</span> <span class="o">*</span> <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;iterations&#39;</span> <span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">min_count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;[ WARNING ] params &quot;min_cluster_freq_2_retain&quot; = {0} and &quot;iter_step&quot; = {1}, hence min_count = {2}</span><span class="se">\n\t</span><span class="s">-&gt; huge accumulation of unstable clusters in pyGCluster!&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">min_cluster_freq_2_retain</span><span class="p">,</span> <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;iterations&#39;</span> <span class="p">],</span> <span class="n">min_count</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="c"># check if multiprocess are valid:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;checking if multiprocesses are functioning ...&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="p">,</span>  <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp_kwargs4multiprocess</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span> <span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs4multiprocess</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>
            <span class="n">tmp_kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;iterations&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span> <span class="n">target</span> <span class="o">=</span> <span class="n">resampling_multiprocess</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">tmp_kwargs4multiprocess</span> <span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">tmp_kwargs4multiprocess</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ ERROR ] Failed to launch multi-processes!&#39;</span><span class="p">,</span>  <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="n">seekAndDestry</span><span class="p">(</span> <span class="p">[</span> <span class="n">p</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">DataQ</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ ERROR ] Failed to collect multi-processes!&#39;</span><span class="p">,</span>  <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="n">seekAndDestry</span><span class="p">(</span> <span class="p">[</span> <span class="n">p</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">raise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;success!&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>

        <span class="c">## other stuff:</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - iteration 2 n_mostfreq&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">converged</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">ask2continue</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">iter_to_continue</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c">### now comes the actual re-sampling routine :)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
            <span class="c"># prevent exceeding iter_max:</span>
            <span class="k">if</span> <span class="n">iter_max</span> <span class="o">&lt;</span> <span class="n">iteration</span> <span class="o">+</span> <span class="n">n_multiprocesses</span> <span class="o">*</span> <span class="n">iter_step</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">iter_to_continue</span><span class="p">:</span>
                <span class="n">n_multiprocesses_tmp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span> <span class="n">iter_max</span> <span class="o">-</span> <span class="n">iteration</span> <span class="p">)</span> <span class="o">/</span> <span class="n">iter_step</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;Continuing another {0} (# processes) * {1} (iter_step) iterations would exceed iter_max (= {2}). Hence, # processes are lowered to {3} so that {4} iterations have been totally performed.&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">n_multiprocesses</span><span class="p">,</span> <span class="n">iter_step</span><span class="p">,</span> <span class="n">iter_max</span><span class="p">,</span> <span class="n">n_multiprocesses_tmp</span><span class="p">,</span> <span class="n">iteration</span> <span class="o">+</span> <span class="n">n_multiprocesses_tmp</span> <span class="o">*</span> <span class="n">iter_step</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
                <span class="n">n_multiprocesses</span> <span class="o">=</span> <span class="n">n_multiprocesses_tmp</span>
            <span class="c"># Launching multi-processes</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_multiprocesses</span> <span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span> <span class="n">target</span> <span class="o">=</span> <span class="n">resampling_multiprocess</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs4multiprocess</span> <span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">p</span> <span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="p">)</span> <span class="c"># to increase randomness!</span>

            <span class="c"># Collecting Process outputs and transfer cluster-counts into &#39;tmpstruct_clustercounts&#39;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_multiprocesses</span> <span class="p">):</span>
                <span class="n">cluster_counts_list</span> <span class="o">=</span> <span class="n">DataQ</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">iteration</span> <span class="o">+=</span> <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;iterations&#39;</span> <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&quot;Clustering. Resampling data : iteration {0: &gt;7}/{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">iter_max</span> <span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">counts</span> <span class="ow">in</span> <span class="n">cluster_counts_list</span><span class="p">:</span>
                    <span class="c"># get cluster ID:</span>
                    <span class="k">if</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]:</span>
                        <span class="n">clusterID</span> <span class="o">=</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># if available, get a discarded ID and assign this ID to the cluster:</span>
                        <span class="k">if</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Discarded IDs&#39;</span> <span class="p">]:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">clusterID</span> <span class="o">=</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Discarded IDs&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># KeyError: &#39;pop from an empty set&#39; = set is empty</span>
                                <span class="n">clusterID</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">clusterID</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span> <span class="o">=</span> <span class="n">clusterID</span>
                    <span class="c"># update counts:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">clusterID</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">counts</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">(</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">],</span>
                              <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span><span class="p">,</span> <span class="n">n_dlc</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span> <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">clusterID</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">counts</span>
                <span class="c"># determine most frequent clusters:</span>
                <span class="n">min_count</span> <span class="o">=</span> <span class="n">iteration</span> <span class="o">*</span> <span class="n">iter_top_P</span>
                <span class="n">mostfreqIDs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_count</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - iteration 2 n_mostfreq&#39;</span> <span class="p">][</span> <span class="n">iteration</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">mostfreqIDs</span> <span class="p">)</span>
                <span class="k">del</span> <span class="n">mostfreqIDs</span>
                <span class="c"># check if converged:</span>
                <span class="k">if</span> <span class="n">iter_till_the_end</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">converged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check4convergence</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">converged</span> <span class="ow">or</span> <span class="n">force_plotting</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">convergence_plot</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">cluster_counts_list</span>
            <span class="c"># terminate processes:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="c"># once all processes finished iter_step clusterings, perform a purging step:</span>
            <span class="c"># discard all clusters with a maximum count of the threshold:</span>
            <span class="n">min_required_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">min_cluster_freq_2_retain</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;iterations&#39;</span> <span class="p">]</span> <span class="o">*</span> <span class="n">n_multiprocesses</span> <span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Discarding {0}-count-clusters ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">min_required_count</span> <span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">max_counts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span> <span class="c"># get max count for each cluster</span>
            <span class="n">IDs2discard</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span> <span class="n">max_counts</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">del</span> <span class="n">max_counts</span>
            <span class="c"># reset counts:</span>
            <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">IDs2discard</span><span class="p">:</span>
                <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">ID</span> <span class="p">][</span> <span class="p">:</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c"># delete those clusters which were attributed the discarded clusterIDs</span>
            <span class="n">clusters2discard</span> <span class="o">=</span> <span class="p">[</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">cID</span> <span class="ow">in</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">cID</span> <span class="ow">in</span> <span class="n">IDs2discard</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters2discard</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span>
                <span class="k">del</span> <span class="n">cluster</span>
            <span class="k">del</span> <span class="n">clusters2discard</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;{0} discarded.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">IDs2discard</span> <span class="p">)</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
            <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Discarded IDs&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">IDs2discard</span>
            <span class="k">del</span> <span class="n">IDs2discard</span>

            <span class="k">if</span> <span class="n">converged</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">iter_max</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">iter_till_the_end</span><span class="p">:</span>
                <span class="n">ask2continue</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">iteration</span> <span class="o">&gt;=</span> <span class="n">iter_max</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">iter_max reached. See convergence plot. Stopping re-sampling if not defined otherwise ...&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">convergence_plot</span><span class="p">()</span>
                <span class="n">ask2continue</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># ask if user wants to continue with the re-sampling process:</span>
            <span class="k">if</span> <span class="n">ask2continue</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Verbosity level&#39;</span> <span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Enter how many iterations you would like to continue. (Has to be a multiple of iterstep = {0})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">iter_step</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;(enter &quot;0&quot; to stop resampling.)&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;(enter &quot;-1&quot; to resample until iter_max (= {0}) is reached.)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">iter_max</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">answer</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span> <span class="s">&#39;Enter a number ...&#39;</span> <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">iter_to_continue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">answer</span> <span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;INT conversion failed. Please try again!&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">iter_to_continue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">converged</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">iter_to_continue</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">iter_till_the_end</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">ask2continue</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">iter_max</span><span class="p">:</span>
                        <span class="n">converged</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">iter_to_continue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">iter_step</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">iter_to_continue</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">iter_step</span><span class="p">))</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">iter_to_continue</span> <span class="o">&lt;</span> <span class="n">iter_step</span><span class="p">:</span>
                        <span class="n">iter_to_continue</span> <span class="o">=</span> <span class="n">iter_step</span>
                    <span class="n">iter_to_continue</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span> <span class="n">iter_to_continue</span> <span class="p">)</span> <span class="o">/</span> <span class="n">n_multiprocesses</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;Resampling will continue another {0} iterations.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">iter_to_continue</span> <span class="o">*</span> <span class="n">n_multiprocesses</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
                    <span class="n">kwargs4multiprocess</span><span class="p">[</span> <span class="s">&#39;iterations&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">iter_to_continue</span>

        <span class="c"># final filtering: store only clusters in pyGCluster whose max_frequencies are above min_cluster_freq_2_retain (default 0.001):</span>
        <span class="n">min_count</span> <span class="o">=</span> <span class="n">iteration</span> <span class="o">*</span> <span class="n">min_cluster_freq_2_retain</span>
        <span class="n">clusterIDs2retain</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_count</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;{0} clusters above threshold of {1}. &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">clusterIDs2retain</span> <span class="p">),</span> <span class="n">min_cluster_freq_2_retain</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">clusterIDs2retain</span> <span class="p">),</span> <span class="n">n_dlc</span> <span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">uint32</span> <span class="p">)</span>
        <span class="n">baseX</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">alphabet</span> <span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tmp</span><span class="p">[</span> <span class="s">&#39;Iterations&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="n">tmp</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tmp</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span>
        <span class="n">tmp</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">clusterID</span> <span class="ow">in</span> <span class="n">tmpstruct_clustercounts</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">clusterID</span> <span class="ow">in</span> <span class="n">clusterIDs2retain</span><span class="p">:</span>
                <span class="n">final_cluster</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c"># map cluster back to decimal indices:</span>
                <span class="k">for</span> <span class="n">baseXstring</span> <span class="ow">in</span> <span class="n">cluster</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s">&#39;,&#39;</span> <span class="p">):</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">digit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">baseXstring</span><span class="p">[</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span> <span class="p">]</span> <span class="p">):</span>
                        <span class="n">index</span> <span class="o">+=</span> <span class="n">alphabet</span><span class="o">.</span><span class="n">find</span><span class="p">(</span> <span class="n">digit</span> <span class="p">)</span> <span class="o">*</span> <span class="n">baseX</span> <span class="o">**</span> <span class="n">i</span>
                    <span class="n">final_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">index</span> <span class="p">)</span>
                <span class="n">final_cluster</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">final_cluster</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="n">final_cluster</span> <span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">final_cluster</span> <span class="p">]</span> <span class="o">=</span> <span class="n">clusterID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add__</span><span class="p">(</span> <span class="n">tmp</span> <span class="p">)</span>
        <span class="c"># pickle results:</span>
        <span class="k">if</span> <span class="n">pickle_filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span> <span class="n">pickle_filename</span> <span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;re-sampling routine for {0} iterations finished. {1} clusters were obtained.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">iteration</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusterIDs2retain</span><span class="p">)</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
    <span class="k">def</span> <span class="nf">_get_normalized_slope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">iter_step</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the normalized slope between two 2D-coordinates:</span>
<span class="sd">        i.e. ( y2 / y1 ) - (1.0) / iter_step,</span>
<span class="sd">        where y = amount of most frequent clusters at a certain iteration,</span>
<span class="sd">        and iter_step = x2 - x1.</span>

<span class="sd">        :param y2: the y-coordinate of the second point.</span>
<span class="sd">        :type y2: float</span>
<span class="sd">        :param y1: the y-coordinate of the first point.</span>
<span class="sd">        :type y1: float</span>
<span class="sd">        :param iter_step: the difference between the x-coordinates of the two points, i.e. x2 - x1.</span>
<span class="sd">        :type iter_step: float</span>

<span class="sd">        rtype: float</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">numerator</span>   <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">y2</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">y1</span> <span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="n">norm_slope</span>  <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">iter_step</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">norm_slope</span>

<div class="viewcode-block" id="Cluster.check4convergence"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.check4convergence">[docs]</a>    <span class="k">def</span> <span class="nf">check4convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks if the re-sampling routine may be terminated, because the number of most frequent clusters remains almost constant.</span>
<span class="sd">        This is done by examining a plot of the amount of most frequent clusters vs. the number of iterations.</span>
<span class="sd">        Convergence is declared once the median normalized slope in a given window of iterations is equal or below &quot;iter_tol&quot;.</span>
<span class="sd">        For further information see Supplementary Material of the corresponding publication.</span>

<span class="sd">        :rtype: boolean</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">converged</span>          <span class="o">=</span> <span class="bp">False</span>
        <span class="n">sorted_iter2nfreqs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - iteration 2 n_mostfreq&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">iter_step</span>          <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_step&#39;</span> <span class="p">]</span>
        <span class="n">iter_window</span>        <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_window&#39;</span> <span class="p">]</span>
        <span class="n">iter_tol</span>           <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_tol&#39;</span> <span class="p">]</span>
        <span class="c"># determine normalized slope:</span>
        <span class="n">norm_slopes</span>        <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">n_mostfreq</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">sorted_iter2nfreqs</span> <span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">n_mostfreq_before</span> <span class="o">=</span> <span class="n">sorted_iter2nfreqs</span><span class="p">[</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">]</span>
            <span class="n">norm_slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_normalized_slope</span><span class="p">(</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">n_mostfreq</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">n_mostfreq_before</span><span class="p">,</span> <span class="n">iter_step</span> <span class="o">=</span> <span class="n">iter_step</span> <span class="p">)</span>
            <span class="n">norm_slopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">norm_slope</span> <span class="p">)</span>
        <span class="c"># determine convergence - is the median of normalized slopes in iter_window iterations &lt;= iter_tol?</span>
        <span class="n">n_slopes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="nb">round</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span> <span class="n">iter_window</span> <span class="p">)</span> <span class="o">/</span> <span class="n">iter_step</span> <span class="p">)</span> <span class="p">)</span> <span class="c"># prepare for sliding window</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">norm_slopes</span> <span class="p">)</span> <span class="o">-</span> <span class="n">n_slopes</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">):</span>
            <span class="n">iteration</span>                <span class="o">=</span> <span class="n">iter_step</span> <span class="o">+</span> <span class="n">iter_step</span> <span class="o">*</span> <span class="n">n_slopes</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">iter_step</span>
            <span class="n">slopes_in_sliding_window</span> <span class="o">=</span> <span class="n">norm_slopes</span><span class="p">[</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n_slopes</span> <span class="p">]</span>
            <span class="n">median_slope</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="n">slopes_in_sliding_window</span> <span class="p">)</span>
            <span class="k">if</span> <span class="o">-</span><span class="n">iter_tol</span> <span class="o">&lt;=</span> <span class="n">median_slope</span> <span class="o">&lt;=</span> <span class="n">iter_tol</span><span class="p">:</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">potentially converged. Check convergence plot!&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - first detected at iteration&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">converged</span>
</div>
<div class="viewcode-block" id="Cluster.convergence_plot"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.convergence_plot">[docs]</a>    <span class="k">def</span> <span class="nf">convergence_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;convergence_plot.pdf&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates a two-sided PDF file containing the full picture of the convergence plot, as well as a zoom of it.</span>
<span class="sd">        The convergence plot illustrates the development of the amount of most frequent clusters vs. the number of iterations.</span>
<span class="sd">        The dotted line in this plots represents the normalized slope, which is used for internal convergence determination.</span>

<span class="sd">        If rpy2 cannot be imported, a CSV file is created instead.</span>

<span class="sd">        :param filename: the filename of the PDF (or CSV) file.</span>
<span class="sd">        :type filename: string</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="kn">import</span> <span class="n">IntVector</span><span class="p">,</span> <span class="n">FloatVector</span><span class="p">,</span> <span class="n">StrVector</span>
            <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="kn">import</span> <span class="n">importr</span>
            <span class="n">graphics</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span> <span class="s">&#39;graphics&#39;</span> <span class="p">)</span>
            <span class="n">grdevices</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span> <span class="s">&#39;grDevices&#39;</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span> <span class="s">&#39;.pdf&#39;</span><span class="p">,</span> <span class="s">&#39;.csv&#39;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">filename</span> <span class="p">),</span> <span class="s">&#39;w&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span> <span class="s">&#39;iteration,amount of most frequent clusters&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">n_mostfreq</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - iteration 2 n_mostfreq&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">print</span><span class="p">(</span> <span class="s">&#39;{0},{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">n_mostfreq</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ INFO ] Since rpy2 could not be imported, a CSV file instead of a PDF plot of convergence was created. See in &quot;{0}&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">filename</span> <span class="p">)</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">_add_lines</span><span class="p">(</span> <span class="n">points2connect</span><span class="p">,</span> <span class="n">lty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span> <span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">points2connect</span> <span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">x_before</span><span class="p">,</span> <span class="n">y_before</span> <span class="o">=</span> <span class="n">points2connect</span><span class="p">[</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span>
                <span class="n">graphics</span><span class="o">.</span><span class="n">lines</span><span class="p">(</span> <span class="n">IntVector</span><span class="p">(</span> <span class="p">[</span> <span class="n">x_before</span><span class="p">,</span> <span class="n">x</span> <span class="p">]</span> <span class="p">),</span>
                                <span class="n">FloatVector</span><span class="p">(</span> <span class="p">[</span> <span class="n">y_before</span><span class="p">,</span> <span class="n">y</span> <span class="p">]</span> <span class="p">),</span>
                                <span class="n">lty</span> <span class="o">=</span> <span class="n">lty</span><span class="p">,</span>
                                <span class="n">col</span> <span class="o">=</span> <span class="n">color</span>
                <span class="p">)</span>

        <span class="n">iter_step</span>           <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_step&#39;</span> <span class="p">]</span>
        <span class="n">iter_window</span>         <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_window&#39;</span> <span class="p">]</span>
        <span class="n">iter_tol</span>            <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_tol&#39;</span> <span class="p">]</span>
        <span class="n">iteration2mostfreq</span>  <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - iteration 2 n_mostfreq&#39;</span> <span class="p">]</span>
        <span class="n">sorted_iter2mostfreq</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">iteration2mostfreq</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">)</span>

        <span class="c"># plot convergence curve:</span>
        <span class="n">grdevices</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">filename</span> <span class="p">),</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">12</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span> <span class="s">&#39;full&#39;</span><span class="p">,</span> <span class="s">&#39;zoom&#39;</span> <span class="p">]:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">sorted_iter2mostfreq</span>
            <span class="n">Ys</span> <span class="o">=</span> <span class="p">[</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">points</span> <span class="p">]</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;full&#39;</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">min</span><span class="p">(</span> <span class="n">Ys</span> <span class="p">),</span> <span class="nb">max</span><span class="p">(</span> <span class="n">Ys</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;#most_freq (left y-axis) and normalized_slope (= (current / before - 1.0) / iter_step) (right y-axis)&#39;</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;zoom&#39;</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">min</span><span class="p">(</span> <span class="n">Ys</span> <span class="p">),</span> <span class="nb">min</span><span class="p">(</span> <span class="n">Ys</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">1.075</span> <span class="p">)</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;ZOOM&#39;</span>
            <span class="n">subtitle</span> <span class="o">=</span> <span class="s">&#39;iter_top_P = {0}, iter_step = {1}, iter_tol = {2}, iter_window = {4}, iter_max = {3}&#39;</span>
            <span class="n">subtitle</span> <span class="o">=</span> <span class="n">subtitle</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_top_P&#39;</span> <span class="p">],</span>
                <span class="n">iter_step</span><span class="p">,</span>
                <span class="n">iter_tol</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - params&#39;</span> <span class="p">][</span> <span class="s">&#39;iter_max&#39;</span> <span class="p">],</span>
                <span class="n">iter_window</span>
            <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">IntVector</span><span class="p">(</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">points</span> <span class="p">]</span> <span class="p">),</span>
                <span class="n">IntVector</span><span class="p">(</span> <span class="n">Ys</span> <span class="p">),</span>
                <span class="n">main</span> <span class="o">=</span> <span class="n">title</span><span class="p">,</span>
                <span class="n">sub</span>  <span class="o">=</span> <span class="n">subtitle</span><span class="p">,</span>
                <span class="n">xlab</span> <span class="o">=</span> <span class="s">&#39;iteration&#39;</span><span class="p">,</span> <span class="n">xaxt</span> <span class="o">=</span> <span class="s">&#39;n&#39;</span><span class="p">,</span>
                <span class="n">ylab</span> <span class="o">=</span> <span class="s">&#39;len(most_freq)&#39;</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="n">IntVector</span><span class="p">(</span> <span class="n">ylim</span> <span class="p">),</span>
                <span class="n">col</span>  <span class="o">=</span> <span class="s">&#39;black&#39;</span><span class="p">,</span>
                <span class="n">pch</span>  <span class="o">=</span> <span class="mi">16</span>
            <span class="p">)</span>
            <span class="n">_add_lines</span><span class="p">(</span> <span class="n">points</span><span class="p">,</span> <span class="n">lty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span> <span class="p">)</span>
            <span class="n">x_axis_ticks</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span> <span class="n">iter_step</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span> <span class="n">iteration2mostfreq</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iter_step</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">at</span> <span class="o">=</span> <span class="n">IntVector</span><span class="p">(</span> <span class="n">x_axis_ticks</span> <span class="p">),</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;{0}k&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">tick</span> <span class="o">/</span> <span class="mi">1000</span> <span class="p">)</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">x_axis_ticks</span> <span class="p">],</span> <span class="n">las</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span> <span class="s">&#39;cex.axis&#39;</span> <span class="p">:</span> <span class="mf">0.75</span> <span class="p">}</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">at</span> <span class="o">=</span> <span class="n">IntVector</span><span class="p">(</span> <span class="n">x_axis_ticks</span> <span class="p">),</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">StrVector</span><span class="p">(</span> <span class="p">[</span> <span class="s">&#39;&#39;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">x_axis_ticks</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="s">&#39;bottomleft&#39;</span><span class="p">,</span>
                <span class="n">legend</span> <span class="o">=</span> <span class="n">StrVector</span><span class="p">(</span> <span class="p">[</span> <span class="s">&#39;#most_freq&#39;</span><span class="p">,</span> <span class="s">&#39;normalized_slope&#39;</span> <span class="p">]</span> <span class="p">),</span>
                <span class="n">lty</span>    <span class="o">=</span> <span class="n">IntVector</span><span class="p">(</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="p">),</span>
                <span class="n">pch</span>    <span class="o">=</span> <span class="n">IntVector</span><span class="p">(</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">),</span>
                <span class="n">bty</span>    <span class="o">=</span> <span class="s">&#39;n&#39;</span>
            <span class="p">)</span>

            <span class="c"># add second plot = normalized_slope-plot:</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">par</span><span class="p">(</span> <span class="n">new</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
            <span class="n">critical_interval</span> <span class="o">=</span> <span class="p">(</span> <span class="o">-</span><span class="n">iter_tol</span><span class="p">,</span> <span class="n">iter_tol</span> <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">firstConvergedAtIter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - first detected at iteration&#39;</span> <span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check4convergence</span><span class="p">()</span>
                <span class="n">firstConvergedAtIter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Convergence determination - first detected at iteration&#39;</span> <span class="p">]</span>
            <span class="n">iter2normslope</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span> <span class="n">iter_step</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span> <span class="p">)</span> <span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">n_mostfreq</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">sorted_iter2mostfreq</span><span class="p">[</span> <span class="mi">1</span><span class="p">:</span> <span class="p">]</span> <span class="p">):</span>
                <span class="n">iteration_before</span><span class="p">,</span> <span class="n">n_mostfreq_before</span> <span class="o">=</span> <span class="n">sorted_iter2mostfreq</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="c"># iteration2mostfreq[ iteration - iter_step ]</span>
                <span class="n">norm_slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_normalized_slope</span><span class="p">(</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">n_mostfreq</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">n_mostfreq_before</span><span class="p">,</span> <span class="n">iter_step</span> <span class="o">=</span> <span class="n">iteration</span> <span class="o">-</span> <span class="n">iteration_before</span> <span class="p">)</span>
                <span class="n">iter2normslope</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">norm_slope</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">iter2normslope</span>
            <span class="n">Ys</span> <span class="o">=</span> <span class="p">[</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">points</span> <span class="p">]</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span> <span class="n">critical_interval</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="n">critical_interval</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">IntVector</span><span class="p">(</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">points</span> <span class="p">]</span> <span class="p">),</span>
                <span class="n">FloatVector</span><span class="p">(</span> <span class="n">Ys</span> <span class="p">),</span>
                <span class="n">main</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="n">xlab</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="n">xaxt</span> <span class="o">=</span> <span class="s">&#39;n&#39;</span><span class="p">,</span>
                <span class="n">ylab</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="n">yaxt</span> <span class="o">=</span> <span class="s">&#39;n&#39;</span><span class="p">,</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">FloatVector</span><span class="p">(</span> <span class="n">ylim</span> <span class="p">),</span>
                <span class="n">pch</span>  <span class="o">=</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">_add_lines</span><span class="p">(</span> <span class="n">points</span><span class="p">,</span> <span class="n">lty</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">abline</span><span class="p">(</span> <span class="n">v</span> <span class="o">=</span> <span class="n">firstConvergedAtIter</span><span class="p">,</span> <span class="n">lty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">lines</span><span class="p">(</span> <span class="n">IntVector</span><span class="p">(</span> <span class="p">[</span> <span class="n">firstConvergedAtIter</span> <span class="o">-</span> <span class="n">iter_window</span><span class="p">,</span> <span class="n">firstConvergedAtIter</span> <span class="p">]</span> <span class="p">),</span> <span class="n">FloatVector</span><span class="p">(</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">),</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;darkgreen&#39;</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">text</span><span class="p">(</span> <span class="n">firstConvergedAtIter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span> <span class="n">firstConvergedAtIter</span> <span class="o">/</span> <span class="mi">1000</span> <span class="p">),</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">abline</span><span class="p">(</span> <span class="n">h</span> <span class="o">=</span> <span class="n">critical_interval</span><span class="p">[</span> <span class="mi">0</span> <span class="p">],</span> <span class="n">lty</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;darkgreen&#39;</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">abline</span><span class="p">(</span> <span class="n">h</span> <span class="o">=</span> <span class="n">critical_interval</span><span class="p">[</span> <span class="mi">1</span> <span class="p">],</span> <span class="n">lty</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="s">&#39;darkgreen&#39;</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">FloatVector</span><span class="p">(</span> <span class="p">[</span> <span class="n">ylim</span><span class="p">[</span> <span class="mi">0</span> <span class="p">],</span> <span class="n">ylim</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">/</span> <span class="mf">20.</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">/</span> <span class="mf">20.</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">grdevices</span><span class="o">.</span><span class="n">dev_off</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;... plot of convergence finished. See plot in &quot;{0}&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">filename</span> <span class="p">)</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.plot_clusterfreqs"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.plot_clusterfreqs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_clusterfreqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_cluster_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">top_X_clusters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Plot the frequencies of each cluster as a expression map:</span>
<span class="sd">        which cluster was found by which distance-linkage combination, and with what frequency?</span>
<span class="sd">        The plot&#39;s filename is prefixed by &#39;clusterFreqsMap&#39;, followed by the values of the parameters.</span>
<span class="sd">        E.g. &#39;clusterFreqsMap_minSize4_top0clusters_top10promille.svg&#39;.</span>
<span class="sd">        Clusters are sorted by size.</span>

<span class="sd">        :param min_cluster_size: only clusters with a size equal or greater than min_cluster_size appear in the plot of the cluster freqs.</span>
<span class="sd">        :type min_cluster_size: int</span>
<span class="sd">        :param threshold_4_the_lowest_max_freq: ]0, 1[ Clusters must have a maximum frequency of at least threshold_4_the_lowest_max_freq to appear in the plot.</span>
<span class="sd">        :type threshold_4_the_lowest_max_freq: float</span>
<span class="sd">        :param top_X_clusters: Plot of the top X clusters in the sorted list (by freq) of clusters having a maximum cluster frequency of at least threshold_4_the_lowest_max_freq (clusterfreq-plot is still sorted by size).</span>
<span class="sd">        :type top_X_clusters: int</span>

<span class="sd">        .. note ::</span>
<span class="sd">            if top_X_clusters is set to zero ( 0 ), this filter is switched off (switched off by default).</span>

<span class="sd">        :rtype: None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Function parameters&#39;</span> <span class="p">][</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_clusterfreqs</span><span class="o">.</span><span class="n">__name__</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span> <span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">&#39;self&#39;</span> <span class="p">}</span>
        <span class="n">allClusters_sortedByLength_l</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_most_frequent_clusters</span><span class="p">(</span><span class="n">min_cluster_size</span> <span class="o">=</span> <span class="n">min_cluster_size</span><span class="p">,</span> <span class="n">top_X_clusters</span> <span class="o">=</span> <span class="n">top_X_clusters</span><span class="p">,</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="o">=</span> <span class="n">threshold_4_the_lowest_max_freq</span><span class="p">),</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">allClusters_sortedByLength_l</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="s">&#39;Cluster ID: {0}, size: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">],</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">identifier</span> <span class="p">)</span>
            <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">cFreq</span><span class="p">,</span> <span class="n">cFreqDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">(</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">cluster</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">dlc</span><span class="p">,</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">cFreqDict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">):</span>
                <span class="n">data</span><span class="p">[</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">dlc</span> <span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span> <span class="p">)</span>
                <span class="n">freqs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="nb">round</span><span class="p">(</span> <span class="n">frequency</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">hm_filename</span> <span class="o">=</span> <span class="s">&#39;clusterFreqsMap_minSize{0}_top{1}clusters_top{2:.0f}promille&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">min_cluster_size</span><span class="p">,</span> <span class="n">top_X_clusters</span><span class="p">,</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="o">*</span> <span class="mi">1000</span> <span class="p">)</span>
        <span class="c"># max_value_4_expression_map = sorted( freqs )[ -3 ] # since root cluster has a freq of 1.0, position -1 is always 1.0 (and -2 close to 1.0 (root, too)!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_expression_map</span><span class="p">(</span>
            <span class="n">identifiers</span>       <span class="o">=</span> <span class="n">identifiers</span><span class="p">,</span>
            <span class="n">data</span>              <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
            <span class="n">conditions</span>        <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">cFreqDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">),</span>
            <span class="n">additional_labels</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="c"># min_value_4_expression_map              = 0.0,</span>
            <span class="n">max_value_4_expression_map</span>              <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="n">freqs</span> <span class="p">),</span>
            <span class="n">expression_map_filename</span> <span class="o">=</span> <span class="n">hm_filename</span><span class="o">+</span><span class="s">&#39;.svg&#39;</span><span class="p">,</span>
            <span class="n">legend_filename</span>   <span class="o">=</span> <span class="n">hm_filename</span><span class="o">+</span><span class="s">&#39;_legend.svg&#39;</span><span class="p">,</span>
            <span class="n">color_gradient</span>    <span class="o">=</span> <span class="s">&#39;barplot&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;... clusterfreqs_expressionmap saved as: &quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">hm_filename</span><span class="o">+</span><span class="s">&#39;.svg&#39;</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
    <span class="k">def</span> <span class="nf">_get_most_frequent_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_cluster_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">top_X_clusters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets the most frequent clusters. Filters either according to a frequency-threshold or gets the top X clusters.</span>

<span class="sd">        .. note ::</span>
<span class="sd">            Each cluster has attributed X counts, or frequencies, where X = len( Distance-linkage combinations ).</span>
<span class="sd">            For determination of most frequent clusters, only the max( X frequencies ) matters.</span>
<span class="sd">            Hence, a single frequency above threshold_4_the_lowest_max_freq is sufficient to include that cluster.</span>

<span class="sd">        :param min_cluster_size: only clusters bigger or equal than threshold are considered; e.g. 4</span>
<span class="sd">        :type min_cluster_size: int</span>

<span class="sd">        :param threshold_4_the_lowest_max_freq: ]0, 1[ get all clusters with a max frequency above threshold, e.g. 0.01 =&gt; 1%-clusters</span>
<span class="sd">        :type threshold_4_the_lowest_max_freq: float</span>

<span class="sd">        :param top_X_clusters: get the top X clusters in the sorted list (by freq) of clusters having a maximum cluster frequency of at least threshold_4_the_lowest_max_freq.</span>
<span class="sd">        :type top_X_clusters: int</span>

<span class="sd">        .. note ::</span>
<span class="sd">           top_X_clusters = 0 means that this filter is switched off (switched off by default).</span>

<span class="sd">        :rtype: List of the most frequent clusters in ARBITRARY order.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="n">threshold_4_the_lowest_max_freq</span>   <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="p">)</span>
        <span class="n">top_X_clusters</span>       <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">top_X_clusters</span> <span class="p">)</span>

        <span class="n">topP_count</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Iterations&#39;</span> <span class="p">]</span> <span class="o">*</span> <span class="n">threshold_4_the_lowest_max_freq</span>


        <span class="n">most_freq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_counts</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span> <span class="c"># get max count for each cluster</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">top_X_clusters</span><span class="p">:</span>
            <span class="n">mostfreqIDs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span> <span class="n">max_counts</span> <span class="o">&gt;=</span> <span class="n">topP_count</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">clusterID</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_cluster_size</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">clusterID</span> <span class="ow">in</span> <span class="n">mostfreqIDs</span><span class="p">:</span>
                        <span class="n">most_freq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># top_X_clusters filter is requested:</span>
            <span class="n">cID_mask</span> <span class="o">=</span> <span class="p">[</span> <span class="n">cID</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">cID</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">c</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_cluster_size</span> <span class="p">]</span>
            <span class="n">clusterIDs2retain</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cID</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">max_counts</span> <span class="o">&gt;=</span> <span class="n">topP_count</span> <span class="p">):</span>
                <span class="k">if</span> <span class="n">_</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cID</span> <span class="ow">in</span> <span class="n">cID_mask</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">clusterIDs2retain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span> <span class="n">max_counts</span><span class="p">[</span> <span class="n">cID</span> <span class="p">],</span> <span class="n">cID</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">clusterIDs2retain</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
            <span class="n">topX_clusterIDs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="p">[</span> <span class="n">cID</span> <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">cID</span> <span class="ow">in</span> <span class="n">clusterIDs2retain</span><span class="p">[</span> <span class="p">:</span> <span class="n">top_X_clusters</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">clusterID</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">clusterID</span> <span class="ow">in</span> <span class="n">topX_clusterIDs</span><span class="p">:</span>
                    <span class="n">most_freq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;{0} clusters are found for a threshold for {1} and a min cluster len of {2}.&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">most_freq</span> <span class="p">),</span> <span class="n">threshold_4_the_lowest_max_freq</span><span class="p">,</span> <span class="n">min_cluster_size</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">most_freq</span>

<div class="viewcode-block" id="Cluster.plot_nodetree"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.plot_nodetree">[docs]</a>    <span class="k">def</span> <span class="nf">plot_nodetree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree_filename</span> <span class="o">=</span> <span class="s">&#39;tree.dot&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        plot the dendrogram for the clustering of the most_frequent_clusters.</span>
<span class="sd">            - node label = nodeID internally used for self[&#39;Nodemap&#39;] (not the same as clusterID!).</span>
<span class="sd">            - node border color is white if the node is a close2root-cluster (i.e. larger than self[ &#39;for IO skip clusters bigger than&#39; ] ).</span>
<span class="sd">            - edge label = distance between parent and children.</span>
<span class="sd">            - edge - color codes:</span>
<span class="sd">                - black   = default; highlights child which is not a most_frequent_cluster but was created during formation of the dendrogram.</span>
<span class="sd">                - green   = children are connected with the root.</span>
<span class="sd">                - red     = highlights child which is a most_frequent_cluster.</span>
<span class="sd">                - yellow  = most_frequent_cluster is directly connected with the root.</span>

<span class="sd">        :param tree_filename: name of the Graphviz DOT file containing the dendrogram of the AHC of most frequent clusters. Best given with &quot;.dot&quot;-extension!</span>
<span class="sd">        :type tree_filename: string</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">tree_filename</span> <span class="p">),</span> <span class="s">&#39;w&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span> <span class="s">&#39;digraph &quot;pyGCluster nodemap_of_the_clustering_of_most_freq_clusters&quot; {&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
            <span class="n">node2tag</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># draw nodes:</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - binary tree&#39;</span> <span class="p">]</span> <span class="p">):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="nb">tuple</span><span class="p">(</span> <span class="nb">sorted</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="n">node</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;-1&#39;</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;size={0}, id={1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="n">node</span> <span class="p">)</span> <span class="p">),</span> <span class="n">label</span> <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">]</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="n">node</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;for IO skip clusters bigger than&#39;</span> <span class="p">]:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;white&#39;</span>
                <span class="k">print</span><span class="p">(</span> <span class="s">&#39;&quot;{0}&quot; [label=&quot;{1}&quot;, color = &quot;{2}&quot;];&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">tag</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="n">node2tag</span><span class="p">[</span> <span class="n">node</span> <span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>
            <span class="c"># insert connecting arrows:</span>
            <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">parent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - binary tree&#39;</span> <span class="p">]</span> <span class="p">):</span>
                <span class="n">is_root_node</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="n">parent</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">]:</span>
                    <span class="n">is_root_node</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - binary tree&#39;</span> <span class="p">][</span> <span class="n">parent</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - binary tree&#39;</span> <span class="p">][</span> <span class="n">child</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span>
                    <span class="k">if</span> <span class="n">is_root_node</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s">&#39;red&#39;</span><span class="p">:</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;yellow&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;green&#39;</span>
                    <span class="k">print</span><span class="p">(</span> <span class="s">&#39;&quot;{0}&quot; -&gt; &quot;{1}&quot; [color=&quot;{2}&quot;];&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">tag</span><span class="p">,</span> <span class="n">node2tag</span><span class="p">[</span> <span class="n">child</span> <span class="p">],</span> <span class="n">color</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
            <span class="k">print</span><span class="p">(</span> <span class="s">&#39;}&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
        <span class="c"># plot tree:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_file</span>  <span class="o">=</span> <span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">tree_filename</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="s">&#39;{0}.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">tree_filename</span><span class="p">[</span> <span class="p">:</span><span class="o">-</span><span class="mi">4</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span> <span class="p">[</span> <span class="s">&#39;dot&#39;</span><span class="p">,</span> <span class="s">&#39;-Tpdf&#39;</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="n">output_file</span> <span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ INFO ] plotting via &quot;dot -Tpdf ...&quot; of the binary cluster-tree failed; only DOT file created.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.calculate_distance_matrix"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.calculate_distance_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_distance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">min_overlap</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculates the specifically developed distance matrix for the AHC of clusters:</span>
<span class="sd">            (1) Clusters sharing *not* the minimum overlap are attributed a distance of &quot;self[ &#39;Root size&#39; ]&quot; (i.e. len( self[ &#39;Data&#39; ] ) ).</span>
<span class="sd">            (2) Clusters are attributed a distance of &quot;self[ &#39;Root size&#39; ] - 1&quot; to the root cluster.</span>
<span class="sd">            (3) Clusters sharing the minimum overlap are attributed a distance of &quot;size of the larger of the two clusters minus size of the overlap&quot;.</span>

<span class="sd">        The overlap betweeen a pair of clusters is relative, i.e. defined as the size of the overlap divided by the size of the larger of the two clusters.</span>

<span class="sd">        The resulting condensed distance matrix in not returned, but rather stored in self[ &#39;Nodemap - condensed distance matrix&#39; ].</span>

<span class="sd">        :param clusters: the most frequent clusters whose &quot;distance&quot; is to be determined.</span>
<span class="sd">        :type clusters: list of clusters. Clusters are represented as tuples consisting of their object&#39;s indices.</span>
<span class="sd">        :param min_overlap: ]0, 1[ threshold value to determine if the distance between two clusters is calculated according to (1) or (3).</span>
<span class="sd">        :type min_overlap: float</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;calculating distance matrix for {0} clusters ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">clusters</span> <span class="p">)</span> <span class="p">)</span> <span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="n">condensed_dist_matrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">set</span><span class="p">(</span> <span class="n">c</span> <span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">clusterI</span><span class="p">,</span> <span class="n">clusterJ</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span> <span class="n">clusters</span><span class="p">,</span> <span class="mi">2</span> <span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">clusterI</span> <span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">]</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span> <span class="n">clusterJ</span> <span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">]:</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">]</span> <span class="o">-</span> <span class="n">b</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">overlap</span> <span class="o">=</span> <span class="n">clusterI</span> <span class="o">&amp;</span> <span class="n">clusterJ</span>
                <span class="n">n_overlap</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">overlap</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">n_sizeI</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">clusterI</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">n_sizeJ</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">clusterJ</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">n_sizeI</span> <span class="o">&gt;</span> <span class="n">n_sizeJ</span><span class="p">:</span>
                    <span class="n">max_size</span> <span class="o">=</span> <span class="n">n_sizeI</span>
                    <span class="n">min_size</span> <span class="o">=</span> <span class="n">n_sizeJ</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">max_size</span> <span class="o">=</span> <span class="n">n_sizeJ</span>
                    <span class="n">min_size</span> <span class="o">=</span> <span class="n">n_sizeI</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span> <span class="n">n_overlap</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">max_size</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_overlap</span><span class="p">:</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">max_size</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">n_overlap</span>
            <span class="n">condensed_dist_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">dist</span> <span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - condensed distance matrix&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">condensed_dist_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;done.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
    <span class="k">def</span> <span class="nf">_get_levelX_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a list of all clusters that are present on a specific level in the node map.</span>
<span class="sd">        Each level corresponds to an iteration in the community construction.</span>

<span class="sd">        :param level: [0, max community-iterations] sets the level (or iteration) from which the clusters are to be returned.</span>
<span class="sd">        :type level: int</span>

<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cluster_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]:</span>
            <span class="n">cluster</span><span class="p">,</span> <span class="n">current_level</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">if</span> <span class="n">current_level</span> <span class="o">==</span> <span class="n">level</span><span class="p">:</span>
                <span class="n">cluster_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">cluster_list</span> <span class="p">)</span>

<div class="viewcode-block" id="Cluster.build_nodemap"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.build_nodemap">[docs]</a>    <span class="k">def</span> <span class="nf">build_nodemap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_cluster_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">top_X_clusters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">starting_min_overlap</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">increasing_min_overlap</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Construction of communities from a set of most_frequent_cluster.</span>
<span class="sd">        This set is obtained via :py:func:`pyGCluster.Cluster._get_most_frequent_clusters`, to which the first three parameters are passed.</span>
<span class="sd">        These clusters are then subjected to AHC with complete linkage.</span>
<span class="sd">        The distance matrix is calculated via :py:func:`pyGCluster.Cluster.calculate_distance_matrix`.</span>
<span class="sd">        The combination of complete linkage and the distance matrix assures that all clusters in a community exhibit at least the &quot;starting_min_overlap&quot; to each other.</span>
<span class="sd">        From the resulting cluster tree, a &quot;first draft&quot; of communities is obtained.</span>
<span class="sd">        These &quot;first&quot; communities are then themselves considered as clusters, and subjected to AHC again, until the community assignment of clusters remains constant.</span>
<span class="sd">        By this, clusters are inserted into a target community, which initially did not overlap with each cluster inside the target community,</span>
<span class="sd">        but do overlap if the clusters in the target community are combined into a single cluster.</span>
<span class="sd">        By this, the degree of stringency is reduced; the clusters fit into a community in a broader sense.</span>
<span class="sd">        For further information on the community construction, see the publication of pyGCluster.</span>

<span class="sd">        Internal structure of communities:</span>
<span class="sd">            &gt;&gt;&gt; name = ( cluster, level )</span>
<span class="sd">            ...         # internal name of the community.</span>
<span class="sd">            ...         # The first element in the tuple (&quot;cluster&quot;) contains the indices</span>
<span class="sd">            ...         # of the objects that comprise a community.</span>
<span class="sd">            ...         # The second element gives the level,</span>
<span class="sd">            ...         # or iteration when the community was formed.</span>
<span class="sd">            &gt;&gt;&gt; self[ &#39;Communities&#39; ][ name ][ &#39;children&#39; ]</span>
<span class="sd">            ...         # list containing the clusters that build the community.</span>
<span class="sd">            &gt;&gt;&gt; self[ &#39;Communities&#39; ][ name ][ &#39;# of nodes merged into community&#39; ]</span>
<span class="sd">            ...         # the number of clusters that build the community.</span>
<span class="sd">            &gt;&gt;&gt; self[ &#39;Communities&#39; ][ name ][ &#39;index 2 obCoFreq dict&#39; ]</span>
<span class="sd">            ...         # an OrderedDict in which each index is assigned its obCoFreq.</span>
<span class="sd">            ...         # Negative indices correspond to &quot;placeholders&quot;,</span>
<span class="sd">            ...         # which are required for the insertion of black lines into expression maps.</span>
<span class="sd">            ...         # Black lines in expression maps seperate the individual clusters</span>
<span class="sd">            ...         # that form a community, sorted by when</span>
<span class="sd">            ...         # they were inserted into the community.</span>
<span class="sd">            &gt;&gt;&gt; self[ &#39;Communities&#39; ][ name ][ &#39;highest obCoFreq&#39; ]</span>
<span class="sd">            ...         # the highest obCoFreq encountered in a community.</span>
<span class="sd">            &gt;&gt;&gt; self[ &#39;Communities&#39; ][ name ][ &#39;cluster ID&#39; ]</span>
<span class="sd">            ...         # the ID of the cluster containing the object with the highest obCoFreq.</span>

<span class="sd">        Of the following parameters, the first three are passed to :py:func:`pyGCluster.Cluster._get_most_frequent_clusters`:</span>

<span class="sd">        :param min_cluster_size: clusters smaller than this threshold are not considered for the community construction.</span>
<span class="sd">        :type min_cluster_size: int</span>
<span class="sd">        :param top_X_clusters: form communities from the top X clusters sorted by their maximum frequency.</span>
<span class="sd">        :type top_X_clusters: int</span>
<span class="sd">        :param threshold_4_the_lowest_max_freq: [0, 1[ form communities from clusters whose maximum frequency is at least this value.</span>
<span class="sd">        :type threshold_4_the_lowest_max_freq: float</span>

<span class="sd">        :param starting_min_overlap: ]0, 1[ minimum required relative overlap between clusters so that they are assigned the same community. The relative overlap is defined as the size of the overlap between two clusters, divided by the size of the larger cluster.</span>
<span class="sd">        :type starting_min_overlap: float</span>

<span class="sd">        :param increasing_min_overlap: defines the increase of the required overlap between communities</span>
<span class="sd">        :type increasing_min_overlap: float</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Function parameters&#39;</span> <span class="p">][</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_nodemap</span><span class="o">.</span><span class="n">__name__</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span> <span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">&#39;self&#39;</span> <span class="p">}</span>
        <span class="kn">import</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">as</span> <span class="nn">ssd</span>
        <span class="n">imported_from_scipy</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">fastcluster</span> <span class="kn">import</span> <span class="n">linkage</span> <span class="k">as</span> <span class="n">ahc</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">linkage</span> <span class="k">as</span> <span class="n">ahc</span>
                <span class="n">imported_from_scipy</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ ERROR ] You do require either &quot;fastcluster&quot; or &quot;scipy&quot; for the construction of communities.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>

        <span class="c"># The algorithm is as follows:</span>
        <span class="c"># Starting from the top, all descendants of any cluster that is smaller than the root are determined.</span>
        <span class="c"># Those descendants form a community.</span>
        <span class="k">def</span> <span class="nf">communities_by_ahc</span><span class="p">(</span><span class="n">cluster_list</span><span class="p">,</span> <span class="n">min_overlap</span><span class="p">):</span>
            <span class="c"># calculate distance matrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_distance_matrix</span><span class="p">(</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">cluster_list</span><span class="p">,</span> <span class="n">min_overlap</span> <span class="o">=</span> <span class="n">min_overlap</span> <span class="p">)</span>
            <span class="c"># perform AHC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;performing AHC for {0} clusters ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster_list</span> <span class="p">)</span> <span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
            <span class="c"># avoid scipy crash when only 2 objects are subjected to AHC:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - condensed distance matrix&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster_list</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - linkage matrix&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="n">cluster_list</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">+</span> <span class="n">cluster_list</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">imported_from_scipy</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - linkage matrix&#39;</span> <span class="p">]</span>  <span class="o">=</span> <span class="n">ahc</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - condensed distance matrix&#39;</span> <span class="p">],</span> <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;complete&#39;</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - linkage matrix&#39;</span> <span class="p">]</span>  <span class="o">=</span> <span class="n">ahc</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - condensed distance matrix&#39;</span> <span class="p">],</span> <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;complete&#39;</span><span class="p">,</span> <span class="n">preserve_input</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;done.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
            <span class="c"># parse clusters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;parsing clusters ...&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
            <span class="n">clusters</span>    <span class="o">=</span> <span class="p">{}</span> <span class="c"># required to reconstruct the clusters from the linkage matrix</span>
            <span class="n">nodemap</span>     <span class="o">=</span> <span class="p">{}</span> <span class="c"># each node = value is a dict with two keys: &#39;parent&#39; -&gt; parent cluster (as tuple), &#39;children&#39; -&gt; set of child clusters (tuples)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">cluster_list</span> <span class="p">):</span>
                <span class="n">clusters</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">cluster</span>
                <span class="n">nodemap</span><span class="p">[</span> <span class="n">cluster</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;children&#39;</span> <span class="p">:</span> <span class="p">[],</span> <span class="s">&#39;parent&#39;</span> <span class="p">:</span> <span class="bp">None</span> <span class="p">}</span>
            <span class="n">parentID</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster_list</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">childID_1</span><span class="p">,</span> <span class="n">childID_2</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - linkage matrix&#39;</span> <span class="p">]:</span>
                <span class="n">parentID</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">child1</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span> <span class="n">childID_1</span> <span class="p">]</span>
                <span class="n">child2</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[</span> <span class="n">childID_2</span> <span class="p">]</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">child1</span> <span class="o">+</span> <span class="n">child2</span>
                <span class="n">clusters</span><span class="p">[</span> <span class="n">parentID</span> <span class="p">]</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="n">nodemap</span><span class="p">[</span> <span class="n">child1</span> <span class="p">][</span> <span class="s">&#39;parent&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="n">nodemap</span><span class="p">[</span> <span class="n">child2</span> <span class="p">][</span> <span class="s">&#39;parent&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="n">nodemap</span><span class="p">[</span> <span class="n">parent</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;children&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="n">child1</span><span class="p">,</span> <span class="n">child2</span> <span class="p">],</span> <span class="s">&#39;parent&#39;</span> <span class="p">:</span> <span class="bp">None</span> <span class="p">}</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - binary tree&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">nodemap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;done.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>

            <span class="c"># recursive function 2 find communities:</span>
            <span class="k">def</span> <span class="nf">get_communities</span><span class="p">(</span> <span class="n">node</span> <span class="p">,</span> <span class="n">community_list</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">):</span>
                <span class="k">if</span> <span class="n">community_list</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">community_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">nodemap</span><span class="p">[</span> <span class="n">node</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="n">child</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">]:</span>
                        <span class="n">community_list</span> <span class="o">=</span> <span class="n">get_communities</span><span class="p">(</span> <span class="n">child</span><span class="p">,</span>  <span class="n">community_list</span> <span class="o">=</span> <span class="n">community_list</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">community_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_descendants_in_binary_tree</span><span class="p">(</span> <span class="n">node</span> <span class="o">=</span> <span class="n">child</span> <span class="p">)</span> <span class="o">+</span> <span class="p">[</span> <span class="n">child</span> <span class="p">]</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">community_list</span>

            <span class="c"># get root_node = top node of the tree:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodemap</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nodemap</span><span class="p">[</span> <span class="n">node</span> <span class="p">][</span> <span class="s">&#39;parent&#39;</span> <span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">root_node</span> <span class="o">=</span> <span class="n">node</span>
                    <span class="k">break</span>
            <span class="n">community_list</span> <span class="o">=</span> <span class="n">get_communities</span><span class="p">(</span> <span class="n">node</span> <span class="o">=</span> <span class="n">root_node</span><span class="p">,</span> <span class="n">community_list</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">)</span>

            <span class="n">clusters_combined_into_communities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">community</span> <span class="ow">in</span> <span class="n">community_list</span><span class="p">:</span>
                <span class="n">endnodes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">community</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">cluster_list</span><span class="p">:</span>
                        <span class="n">endnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span>
                <span class="n">clusters_combined_into_communities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">endnodes</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">clusters_combined_into_communities</span>

        <span class="k">def</span> <span class="nf">update_communities</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">clusters_combined_into_communities</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">community</span> <span class="ow">in</span> <span class="n">clusters_combined_into_communities</span><span class="p">:</span>
                <span class="c"># find cluster with highest freq</span>
                <span class="n">community_obCoFreq2cluster_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">community_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">community</span><span class="p">:</span>
                    <span class="n">highest_obCoFreq</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="p">(</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">level</span> <span class="p">)</span> <span class="p">][</span> <span class="s">&#39;highest obCoFreq&#39;</span> <span class="p">]</span>
                    <span class="n">community_obCoFreq2cluster_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span> <span class="n">highest_obCoFreq</span><span class="p">,</span> <span class="n">cluster</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">community_indices</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span>
                <span class="n">community_obCoFreq2cluster_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">)</span>
                <span class="n">first_cluster</span> <span class="o">=</span> <span class="n">community_obCoFreq2cluster_list</span><span class="p">[</span> <span class="mi">0</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">tuple</span><span class="p">(</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">community_indices</span> <span class="p">)</span> <span class="p">),</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]:</span>
                    <span class="n">current_highest_obCoFreq</span> <span class="o">=</span> <span class="n">community_obCoFreq2cluster_list</span><span class="p">[</span> <span class="mi">0</span> <span class="p">][</span> <span class="mi">0</span> <span class="p">]</span>
                    <span class="k">if</span> <span class="n">current_highest_obCoFreq</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;highest obCoFreq&#39;</span> <span class="p">]:</span>
                        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="p">(</span> <span class="n">first_cluster</span><span class="p">,</span> <span class="n">level</span> <span class="p">)</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">]</span>
                    <span class="n">community_obCoFreq2cluster_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span> <span class="p">)</span> <span class="c"># assure that the first cluster is also properly inserted</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">first_cluster</span> <span class="p">]</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="p">(</span> <span class="n">first_cluster</span><span class="p">,</span> <span class="n">level</span> <span class="p">)</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="p">(</span> <span class="n">first_cluster</span><span class="p">,</span> <span class="n">level</span> <span class="p">)</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">]</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;highest obCoFreq&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;# of nodes merged into community&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="p">(</span> <span class="n">first_cluster</span><span class="p">,</span> <span class="n">level</span> <span class="p">)</span> <span class="p">][</span> <span class="s">&#39;# of nodes merged into community&#39;</span> <span class="p">]</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;# of nodes merged into community&#39;</span> <span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">community_obCoFreq2cluster_list</span> <span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span>
                <span class="c"># insert children and update obCoFreq-Dict:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">community_obCoFreq2cluster_list</span><span class="p">[</span> <span class="mi">1</span> <span class="p">:</span> <span class="p">]:</span>
                    <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span>
                    <span class="n">placeholder_added</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                        <span class="n">obCoFreq</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="p">(</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">level</span> <span class="p">)</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">]</span>
                        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">]:</span>
                            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">obCoFreq</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">placeholder_added</span><span class="p">:</span>
                                <span class="n">placeholder</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
                                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">][</span> <span class="n">placeholder</span> <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
                                <span class="n">placeholder_added</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">]</span> <span class="o">=</span> <span class="n">obCoFreq</span>
                <span class="n">max_freq</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;highest obCoFreq&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">max_freq</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">init_cluster2community0_level</span><span class="p">():</span>
            <span class="n">most_frequent_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_most_frequent_clusters</span><span class="p">(</span> <span class="n">min_cluster_size</span> <span class="o">=</span> <span class="n">min_cluster_size</span><span class="p">,</span> <span class="n">top_X_clusters</span> <span class="o">=</span> <span class="n">top_X_clusters</span><span class="p">,</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="o">=</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="p">)</span>
            <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">most_frequent_clusters</span> <span class="p">):</span>
                <span class="n">index2obCoFreq</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">cFreq</span><span class="p">,</span> <span class="n">cFreqDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">(</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">cluster</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="n">index2obCoFreq</span><span class="p">[</span> <span class="n">index</span> <span class="p">]</span> <span class="o">=</span> <span class="n">cFreq</span>
                <span class="n">max_freq</span> <span class="o">=</span> <span class="n">cFreq</span> <span class="c"># max_freq = max( index2obCoFreq.values() ) = cFreq, because the indices are only from a single cluster at level 0</span>
                <span class="n">name</span> <span class="o">=</span> <span class="p">(</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">level</span> <span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">]</span>                                           <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]</span>                             <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;index 2 obCoFreq dict&#39;</span> <span class="p">]</span>                <span class="o">=</span> <span class="n">index2obCoFreq</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;highest obCoFreq&#39;</span> <span class="p">]</span>                     <span class="o">=</span> <span class="n">max_freq</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">]</span>                           <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;# of nodes merged into community&#39;</span> <span class="p">]</span>     <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">return</span>

        <span class="n">min_overlap</span> <span class="o">=</span> <span class="n">starting_min_overlap</span>
        <span class="n">init_cluster2community0_level</span><span class="p">()</span>
        <span class="n">level</span>              <span class="o">=</span> <span class="mi">0</span>
        <span class="n">community_snapshot</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">cluster_list</span>                       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_levelX_clusters</span><span class="p">(</span> <span class="n">level</span> <span class="o">=</span> <span class="n">level</span> <span class="p">)</span>
            <span class="n">clusters_combined_into_communities</span> <span class="o">=</span> <span class="n">communities_by_ahc</span><span class="p">(</span> <span class="n">cluster_list</span><span class="p">,</span> <span class="n">min_overlap</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">community_snapshot</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">clusters_combined_into_communities</span> <span class="p">)</span> <span class="ow">or</span> <span class="n">min_overlap</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_nodetree</span><span class="p">(</span> <span class="s">&#39;AHCofClusters_binaryTree_iteration{0}.dot&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">update_communities</span><span class="p">(</span> <span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">,</span> <span class="n">clusters_combined_into_communities</span> <span class="o">=</span> <span class="n">clusters_combined_into_communities</span> <span class="p">)</span>
            <span class="n">community_snapshot</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">clusters_combined_into_communities</span> <span class="p">)</span>
            <span class="n">min_overlap</span>                        <span class="o">+=</span> <span class="n">increasing_min_overlap</span>
            <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span>
</div>
    <span class="k">def</span> <span class="nf">_get_descendants_in_binary_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Recursively determines the descendants of a given node in an AHC tree.</span>

<span class="sd">        :param node: tuple describing uniquely a node in the AHC tree. It resembles a pyGCluster-cluster, but may contain the same index several times, e.g. if (1,2) and (1,3) are merged into (1,1,2,3).</span>
<span class="sd">        :type node: tuple</span>
<span class="sd">        :param children: all descendants determined so far. Should equal None for the first call.</span>
<span class="sd">        :type children: list</span>

<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">children</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - binary tree&#39;</span> <span class="p">][</span> <span class="n">node</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Nodemap - binary tree&#39;</span> <span class="p">][</span> <span class="n">node</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]:</span>
                <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">child</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_descendants_in_binary_tree</span><span class="p">(</span> <span class="n">node</span> <span class="o">=</span> <span class="n">child</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">children</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">children</span>

    <span class="k">def</span> <span class="nf">_get_descendants_in_community_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_name</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Recursively determines the descendants of a given node in the community tree.</span>
<span class="sd">        In contrast to :py:func:`pyGCluster.Cluster._get_descendants_in_binary_tree` , the community tree is not a binary tree;</span>
<span class="sd">        and &quot;parent_name&quot; differs from the &quot;node&quot;-parameter of the former (see below).</span>

<span class="sd">        :param parent_name: tuple with two elements: ( cluster, level ). Here, cluster is a pyGCluster-cluster, i.e. a tuple containing each index describing a cluster only once.</span>
<span class="sd">        :type parent_name: tuple</span>
<span class="sd">        :param children: all descendants determined so far. Should equal None for the first call.</span>
<span class="sd">        :type children: list</span>

<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">children</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">parent_name</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">parent</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">parent_name</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">parent_name</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]:</span>
                <span class="n">child_name</span> <span class="o">=</span> <span class="p">(</span> <span class="n">child</span><span class="p">,</span> <span class="n">level</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">child_name</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_descendants_in_community_tree</span><span class="p">(</span> <span class="n">parent_name</span> <span class="o">=</span> <span class="n">child_name</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">children</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">children</span>

<div class="viewcode-block" id="Cluster.create_rainbow_colors"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.create_rainbow_colors">[docs]</a>    <span class="k">def</span> <span class="nf">create_rainbow_colors</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a list of rainbow colors. Colors are expressed as hexcodes of RGB values.</span>

<span class="sd">        :param n_colors: number of rainbow colors.</span>
<span class="sd">        :type n_colors: int</span>

<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">colorsys</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_colors</span> <span class="p">):</span>
            <span class="c"># i has to be [0.0, 1.0[</span>
            <span class="n">i</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">n_colors</span> <span class="p">)</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="p">]</span>
            <span class="n">hexcode</span> <span class="o">=</span> <span class="s">&#39;#&#39;</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rgb</span><span class="p">:</span>
                <span class="n">_hex</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">_</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_hex</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">_hex</span> <span class="o">=</span> <span class="s">&#39;0{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hex</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_hex</span> <span class="o">=</span> <span class="s">&#39;{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_hex</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">hexcode</span> <span class="o">+=</span> <span class="n">_hex</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hexcode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">colors</span>
</div>
<div class="viewcode-block" id="Cluster.write_legend"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.write_legend">[docs]</a>    <span class="k">def</span> <span class="nf">write_legend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;legend.txt&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates a legend for the community node map as a TXT file.</span>
<span class="sd">        Herein, the object composition of each cluster of the node map as well as its frequencies are recorded.</span>
<span class="sd">        Since this function is internally called by :py:func:`pyGCluster.Cluster.write_dot`, it is typically not necessary to call this function.</span>

<span class="sd">        :param filename: name of the legend TXT file, best given with extension &quot;.txt&quot;.</span>
<span class="sd">        :type filename: string</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="p">,</span> <span class="n">filename</span> <span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">legend</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span> <span class="s">&quot;Frequency order:</span><span class="se">\n</span><span class="s">{0}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">sorted</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">legend</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]:</span>
                <span class="n">cluster</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;for IO skip clusters bigger than&#39;</span> <span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]:</span>
                    <span class="n">cFreq</span><span class="p">,</span> <span class="n">cFreqDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">(</span> <span class="n">cluster</span> <span class="o">=</span> <span class="n">cluster</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cFreqDict</span> <span class="o">=</span> <span class="p">{</span> <span class="bp">None</span> <span class="p">:</span> <span class="o">-</span><span class="mi">99</span> <span class="p">}</span>
                <span class="n">nodeID</span> <span class="o">=</span> <span class="s">&#39;{0}, {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">],</span> <span class="n">level</span> <span class="p">)</span>
                <span class="k">print</span><span class="p">(</span> <span class="s">&#39;label = &quot;{nodeID:0&gt;3}&quot;, size = {size:0&gt;3}, frequencies = {frequencies}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">nodeID</span> <span class="o">=</span> <span class="n">nodeID</span><span class="p">,</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">),</span>
                    <span class="n">frequencies</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="p">[</span> <span class="s">&#39;{0:5.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span> <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">cFreqDict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
                    <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">legend</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="n">addOn</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">addOn</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Additional Labels&#39;</span> <span class="p">][</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Identifiers&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">]</span> <span class="p">]</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">addOn</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">addOn</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="nb">set</span><span class="p">()):</span>
                            <span class="n">addOn</span> <span class="o">=</span> <span class="s">&quot;.oOo.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">addOn</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">print</span><span class="p">(</span> <span class="s">&#39;{0}</span><span class="se">\t</span><span class="s">{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Identifiers&#39;</span> <span class="p">][</span> <span class="n">index</span> <span class="p">],</span> <span class="n">addOn</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">legend</span> <span class="p">)</span>
                <span class="k">print</span><span class="p">(</span> <span class="s">&#39;+&#39;</span> <span class="o">*</span> <span class="mi">50</span> <span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">legend</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;... nodemap saved in &quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.write_dot"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.write_dot">[docs]</a>    <span class="k">def</span> <span class="nf">write_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="p">,</span> <span class="n">scaleByFreq</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">min_obcofreq_2_plot</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">n_legend_nodes</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">min_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">color_gradient</span> <span class="o">=</span> <span class="s">&#39;1337&#39;</span><span class="p">,</span> <span class="n">box_style</span> <span class="o">=</span> <span class="s">&#39;classic&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Writes a Graphviz DOT file representing the cluster composition of communities.</span>
<span class="sd">        Herein, each node represents a cluster. Its name is a combination of the cluster&#39;s ID, followed by the level / iteration it was inserted into the community:</span>

<span class="sd">            - The node&#39;s size reflects the cluster&#39;s cFreq.</span>
<span class="sd">            - The node&#39;s shape illustrates by which distance metric the cluster was found (if the shape is a point, this illustrates that this cluster was not among the most_frequent_clusters, but only formed during AHC of clusters).</span>
<span class="sd">            - The node&#39;s color shows the community membership; except for clusters which are larger than self[ &#39;for IO skip clusters bigger than&#39; ], those are highlighted in grey.</span>
<span class="sd">            - The node connecting all clusters is the root (the cluster holding all objects), which is highlighted in white.</span>

<span class="sd">        The DOT file may be rendered with &quot;Graphviz&quot; or further processed with other appropriate programs such as e.g. &quot;Gephi&quot;.</span>
<span class="sd">        If &quot;Graphviz&quot; is available, the DOT file is eventually rendered with &quot;Graphviz&quot;&#39;s dot-algorithm.</span>

<span class="sd">        In addition, a expression map for each cluster of the node map is created (via :py:func:`pyGCluster.Cluster.draw_expression_map_for_community_cluster`).</span>

<span class="sd">        Those are saved in the sub-folder &quot;communityClusters&quot;.</span>

<span class="sd">        This function also calls :py:func:`pyGCluster.Cluster.write_legend`,</span>
<span class="sd">        which creates a TXT file containing the object composition of all clusters, as well as their frequencies.</span>

<span class="sd">        :param filename: file name of the Graphviz DOT file representing the node map, best given with extension &quot;.dot&quot;.</span>
<span class="sd">        :type filename: string</span>
<span class="sd">        :param scaleByFreq: switch to either scale nodes (= clusters) by cFreq or apply a constant size to each node (the latter may be useful to put emphasis on the nodes&#39; shapes).</span>
<span class="sd">        :type scaleByFreq: boolean</span>
<span class="sd">        :param min_obcofreq_2_plot: if defined, clusters with lower cFreq than this value are skipped, i.e. not plotted.</span>
<span class="sd">        :type min_obcofreq_2_plot: float</span>
<span class="sd">        :param n_legend_nodes: number of nodes representing the legend for the node sizes. The node sizes themselves encode for the cFreq. &quot;Legend nodes&quot; are drawn as grey boxes.</span>
<span class="sd">        :type n_legend_nodes: int</span>

<span class="sd">        :param min_value_4_expression_map: lower bound for color coding of values in the expression map. Remember that log2-values are expected, i.e. this value should be &lt; 0.</span>
<span class="sd">        :type min_value_4_expression_map: float</span>
<span class="sd">        :param max_value_4_expression_map: upper bound for color coding of values in the expression map.</span>
<span class="sd">        :type max_value_4_expression_map: float</span>
<span class="sd">        :param color_gradient: name of the color gradient used for plotting the expression map.</span>
<span class="sd">        :type color_gradient: string</span>
<span class="sd">        :param box_style: the way the relative standard deviation is visualized in the expression map. Currently supported are &#39;modern&#39;, &#39;fusion&#39; or &#39;classic&#39;.</span>
<span class="sd">        :type box_style: string</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Function parameters&#39;</span> <span class="p">][</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_dot</span><span class="o">.</span><span class="n">__name__</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span> <span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">&#39;self&#39;</span> <span class="p">}</span>
        <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="n">node_templateString</span> <span class="o">=</span> <span class="s">&#39;&quot;{nodeID}&quot; [label=&quot;{label}&quot;, color=&quot;{color}&quot;, shape=&quot;{shape}&quot;, width=&quot;{freq}&quot;, height=&quot;{freq}&quot;, fixedsize=true, community={community}, c_members={c_members}, metrix=&quot;{metrix}&quot;, normalized_max_obCoFreq=&quot;{normalized_max_obCoFreq}&quot;];&#39;</span>
        <span class="n">node_templateString_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">edge_templateString</span> <span class="o">=</span> <span class="s">&#39;&quot;{parent}&quot; -&gt; &quot;{child}&quot; [color=&quot;{color}&quot;, arrowsize=2.0];&#39;</span>
        <span class="n">edge_templateString_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s">&#39;Communities&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;function &quot;build_nodemap()&quot; was not called prior. Building node map with default settings ...&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_nodemap</span><span class="p">()</span>

        <span class="n">most_frequent_clusters_used_4_nodemap</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_levelX_clusters</span><span class="p">(</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>

        <span class="c"># assign each distance metric combo a specific shape (if possible):</span>
        <span class="n">metrix2shape</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">n_metrices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distances&#39;</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distances&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ INFO ] more distance metrics than shapes! All shapes equal &quot;ellipse&quot;.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;ellipse&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_metrices</span> <span class="o">**</span> <span class="n">n_metrices</span> <span class="p">)</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;box&#39;</span><span class="p">,</span> <span class="s">&#39;ellipse&#39;</span><span class="p">,</span> <span class="s">&#39;triangle&#39;</span><span class="p">,</span> <span class="s">&#39;diamond&#39;</span><span class="p">,</span> <span class="s">&#39;octagon&#39;</span><span class="p">,</span> <span class="s">&#39;invtriangle&#39;</span><span class="p">,</span> <span class="s">&#39;invtrapezium&#39;</span> <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_metrices</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">):</span>
            <span class="k">for</span> <span class="n">metric_combo</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distances&#39;</span> <span class="p">]</span> <span class="p">,</span> <span class="n">i</span> <span class="p">):</span>
                <span class="n">metrix2shape</span><span class="p">[</span> <span class="s">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">metric_combo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;metric 2 shape:&#39;</span><span class="p">,</span> <span class="n">metrix2shape</span> <span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;nodemap metric2shape&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">metrix2shape</span>
        <span class="c"># determine max obCoFreq for proper node scaling:</span>
        <span class="n">sorted_obCoFreqs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="p">[</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;highest obCoFreq&#39;</span> <span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">max_obCoFreq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">sorted_obCoFreqs</span><span class="p">[</span> <span class="o">-</span><span class="mi">2</span> <span class="p">]</span> <span class="p">)</span> <span class="c"># sorted_obCoFreqs[ -1 ] == root, hence max_obCoFreq would always be cFreq(root) == 2.0!</span>
        <span class="c"># get top, i.e. largest cluster of each community:</span>
        <span class="n">max_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="p">[</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">communities_top_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_levelX_clusters</span><span class="p">(</span> <span class="n">level</span> <span class="o">=</span> <span class="n">max_level</span> <span class="p">)</span>
        <span class="c"># set colors:</span>
        <span class="n">communities_minus_close2root</span> <span class="o">=</span> <span class="p">[</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>  <span class="n">communities_top_cluster</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">c</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;for IO skip clusters bigger than&#39;</span> <span class="p">]</span> <span class="p">]</span>
        <span class="n">community_colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_rainbow_colors</span><span class="p">(</span> <span class="n">n_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">communities_minus_close2root</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">name2community_and_color</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">communityID</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">communities_top_cluster</span> <span class="p">):</span>
            <span class="k">if</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">communities_minus_close2root</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">community_colors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;#BEBEBE&#39;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">max_level</span> <span class="p">)</span>
            <span class="n">communityID_color</span> <span class="o">=</span> <span class="p">(</span> <span class="n">communityID</span><span class="p">,</span> <span class="n">color</span> <span class="p">)</span>
            <span class="n">name2community_and_color</span><span class="p">[</span> <span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">communityID_color</span>
            <span class="k">for</span> <span class="n">child_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_descendants_in_community_tree</span><span class="p">(</span> <span class="n">parent_name</span> <span class="o">=</span> <span class="n">name</span> <span class="p">):</span>
                <span class="n">name2community_and_color</span><span class="p">[</span> <span class="n">child_name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">communityID_color</span>

        <span class="c"># filter nodes by min_obcofreq_2_plot, and build &#39;name2nodeID&#39;-dict:</span>
        <span class="n">name2nodeID</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">skipped_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">skipped_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root&#39;</span> <span class="p">],</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]:</span>
            <span class="n">name2nodeID</span><span class="p">[</span> <span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">name2nodeID</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">min_obcofreq_2_plot</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;highest obCoFreq&#39;</span> <span class="p">]:</span>
                <span class="n">community</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="n">max_level</span> <span class="o">&gt;</span> <span class="n">level</span><span class="p">:</span> <span class="c"># prevent that communities are lost if community freq &lt; min_obcofreq_2_plot</span>
                    <span class="n">skipped_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">name</span> <span class="p">)</span>

        <span class="c">### write dot file:</span>
        <span class="n">dot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">filename</span> <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">dot_filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span> <span class="p">)</span>  <span class="k">as</span> <span class="n">dot</span><span class="p">:</span>
            <span class="c">## initialize DOT file:</span>
            <span class="k">print</span><span class="p">(</span> <span class="s">&#39;digraph &quot;pyGCluster nodemap&quot; {&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span> <span class="p">)</span>
            <span class="k">print</span><span class="p">(</span> <span class="s">&#39;graph [overlap=Prism, splines=true, ranksep=5.0, nodesep=0.75];&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span> <span class="p">)</span>
            <span class="k">print</span><span class="p">(</span> <span class="s">&#39;node [style=filled]&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span> <span class="p">)</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">5.</span>
            <span class="c">## draw nodes:</span>
            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">max_level</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_levelX_clusters</span><span class="p">(</span> <span class="n">level</span> <span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="p">(</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">level</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">skipped_nodes</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c"># draw expression map:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;for IO skip clusters bigger than&#39;</span> <span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">draw_expression_map_for_community_cluster</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">min_value_4_expression_map</span> <span class="o">=</span> <span class="n">min_value_4_expression_map</span><span class="p">,</span> <span class="n">max_value_4_expression_map</span> <span class="o">=</span> <span class="n">max_value_4_expression_map</span><span class="p">,</span> <span class="n">color_gradient</span> <span class="o">=</span> <span class="n">color_gradient</span> <span class="p">,</span> <span class="n">sub_folder</span> <span class="o">=</span> <span class="s">&#39;communityClusters&#39;</span><span class="p">,</span> <span class="n">box_style</span> <span class="o">=</span> <span class="n">box_style</span> <span class="p">)</span>

                    <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;nodeID&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">name2nodeID</span><span class="p">[</span> <span class="n">name</span> <span class="p">]</span>
                    <span class="c"># scale node size:</span>
                    <span class="k">if</span> <span class="n">scaleByFreq</span><span class="p">:</span>
                        <span class="n">normalized_obCoFreq</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;highest obCoFreq&#39;</span> <span class="p">]</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="n">normalized_obCoFreq</span> <span class="o">/</span> <span class="n">max_obCoFreq</span> <span class="o">*</span> <span class="n">scale_factor</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="mf">2.5</span>
                    <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;freq&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
                    <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;label&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&#39;{0}-{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">],</span> <span class="n">level</span> <span class="p">)</span>
                    <span class="c"># determine shape:</span>
                    <span class="k">if</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">most_frequent_clusters_used_4_nodemap</span><span class="p">:</span>
                        <span class="n">clusterID</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span>
                        <span class="n">distances</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">clusterID</span> <span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">]:</span>
                            <span class="n">distance</span><span class="p">,</span> <span class="n">linkage</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">][</span> <span class="n">i</span> <span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span> <span class="p">)</span>
                            <span class="n">distances</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">distance</span> <span class="p">)</span>
                        <span class="n">distances</span> <span class="o">=</span> <span class="s">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">distances</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;metrix&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">distances</span>
                        <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;shape&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">metrix2shape</span><span class="p">[</span> <span class="n">distances</span> <span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;metrix&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&#39;None&#39;</span>
                        <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;shape&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&#39;point&#39;</span>
                    <span class="c"># store the cluster&#39;s size (in terms of objects describing it), set color and community ID:</span>
                    <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;c_members&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span>
                    <span class="n">communityID</span><span class="p">,</span> <span class="n">community_color</span> <span class="o">=</span> <span class="n">name2community_and_color</span><span class="p">[</span> <span class="n">name</span> <span class="p">]</span>
                    <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;color&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">community_color</span>
                    <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;community&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">communityID</span>
                    <span class="n">node_templateString_dict</span><span class="p">[</span> <span class="s">&#39;normalized_max_obCoFreq&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">name</span> <span class="p">][</span> <span class="s">&#39;highest obCoFreq&#39;</span> <span class="p">]</span>
                    <span class="c"># finally insert node into dot-file:</span>
                    <span class="k">print</span><span class="p">(</span> <span class="n">node_templateString</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="o">**</span><span class="n">node_templateString_dict</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span> <span class="p">)</span>
            <span class="c">## insert edges:</span>
            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_level</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_levelX_clusters</span><span class="p">(</span> <span class="n">level</span> <span class="p">):</span>
                    <span class="n">parent_name</span>  <span class="o">=</span> <span class="p">(</span> <span class="n">parent</span><span class="p">,</span> <span class="n">level</span> <span class="p">)</span>
                    <span class="n">edge_templateString_dict</span><span class="p">[</span> <span class="s">&#39;parent&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">name2nodeID</span><span class="p">[</span> <span class="n">parent_name</span> <span class="p">]</span>
                    <span class="n">edge_templateString_dict</span><span class="p">[</span> <span class="s">&#39;color&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">name2community_and_color</span><span class="p">[</span> <span class="n">parent_name</span> <span class="p">][</span> <span class="mi">1</span> <span class="p">]</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="n">parent_name</span> <span class="p">][</span> <span class="s">&#39;children&#39;</span> <span class="p">]:</span>
                        <span class="n">child_name</span>  <span class="o">=</span> <span class="p">(</span> <span class="n">child</span><span class="p">,</span> <span class="n">level</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
                        <span class="k">if</span> <span class="n">child_name</span> <span class="ow">in</span> <span class="n">skipped_nodes</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">edge_templateString_dict</span><span class="p">[</span> <span class="s">&#39;child&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">name2nodeID</span><span class="p">[</span> <span class="n">child_name</span> <span class="p">]</span>
                        <span class="c"># nut to break: child without direct parent ...</span>
                        <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="n">skipped_nodes</span><span class="p">:</span>
                            <span class="c"># find largest parent:</span>
                            <span class="n">communityID</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">name2community_and_color</span><span class="p">[</span> <span class="n">child_name</span> <span class="p">]</span>
                            <span class="c"># get all community clusters which are attributed the current communityID:</span>
                            <span class="n">community_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name2community_and_color</span><span class="p">:</span>
                                <span class="n">ID</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">name2community_and_color</span><span class="p">[</span> <span class="n">name</span> <span class="p">]</span>
                                <span class="k">if</span> <span class="n">ID</span> <span class="o">==</span> <span class="n">communityID</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">child_name</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">&gt;</span> <span class="n">child_name</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]:</span>
                                    <span class="n">community_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">name</span> <span class="p">)</span>
                            <span class="c"># Of those, extract clusters which are NOT to be skipped:</span>
                            <span class="n">potential_parents</span> <span class="o">=</span> <span class="n">community_names</span> <span class="o">-</span> <span class="n">skipped_nodes</span>
                            <span class="c"># get parent with lowest level:</span>
                            <span class="n">min_level</span> <span class="o">=</span> <span class="n">max_level</span>
                            <span class="k">for</span> <span class="n">potential_parent_name</span> <span class="ow">in</span> <span class="n">potential_parents</span><span class="p">:</span>
                                <span class="n">parent</span><span class="p">,</span> <span class="n">_level</span> <span class="o">=</span> <span class="n">potential_parent_name</span>
                                <span class="k">if</span> <span class="n">min_level</span> <span class="o">&gt;</span> <span class="n">_level</span><span class="p">:</span>
                                    <span class="n">min_level</span> <span class="o">=</span> <span class="n">_level</span>
                            <span class="k">for</span> <span class="n">potential_parent_name</span> <span class="ow">in</span> <span class="n">potential_parents</span><span class="p">:</span>
                                <span class="n">parent</span><span class="p">,</span> <span class="n">_level</span> <span class="o">=</span> <span class="n">potential_parent_name</span>
                                <span class="k">if</span> <span class="n">_level</span> <span class="o">==</span> <span class="n">min_level</span><span class="p">:</span>
                                    <span class="n">edge_templateString_dict</span><span class="p">[</span> <span class="s">&#39;parent&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">name2nodeID</span><span class="p">[</span> <span class="n">potential_parent_name</span> <span class="p">]</span>
                                    <span class="k">break</span>
                        <span class="k">print</span><span class="p">(</span> <span class="n">edge_templateString</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="o">**</span><span class="n">edge_templateString_dict</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span> <span class="p">)</span>

            <span class="c">## connect largest cluster of each community with root:</span>
            <span class="n">root_name</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root&#39;</span> <span class="p">],</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
            <span class="n">name2nodeID</span><span class="p">[</span> <span class="n">root_name</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">name2nodeID</span> <span class="p">)</span>
            <span class="n">node_templateString_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;nodeID&#39;</span> <span class="p">:</span> <span class="n">name2nodeID</span><span class="p">[</span> <span class="n">root_name</span> <span class="p">],</span>
                <span class="s">&#39;freq&#39;</span> <span class="p">:</span> <span class="n">scale_factor</span><span class="p">,</span>
                <span class="s">&#39;label&#39;</span> <span class="p">:</span> <span class="s">&#39;ROOT&#39;</span><span class="p">,</span>
                <span class="s">&#39;c_members&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Root size&#39;</span> <span class="p">],</span>
                <span class="s">&#39;community&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="s">&#39;color&#39;</span> <span class="p">:</span> <span class="s">&#39;#FFFFFF&#39;</span><span class="p">,</span>
                <span class="s">&#39;metrix&#39;</span> <span class="p">:</span> <span class="s">&#39;ALL&#39;</span><span class="p">,</span>
                <span class="s">&#39;shape&#39;</span> <span class="p">:</span> <span class="s">&#39;ellipse&#39;</span><span class="p">,</span>
                <span class="s">&#39;normalized_max_obCoFreq&#39;</span> <span class="p">:</span> <span class="s">&#39;-99&#39;</span>
            <span class="p">}</span>
            <span class="k">print</span><span class="p">(</span> <span class="n">node_templateString</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="o">**</span><span class="n">node_templateString_dict</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span> <span class="p">)</span>
            <span class="n">edge_templateString_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;parent&#39;</span> <span class="p">:</span> <span class="n">name2nodeID</span><span class="p">[</span> <span class="n">root_name</span> <span class="p">],</span> <span class="s">&#39;color&#39;</span> <span class="p">:</span> <span class="s">&#39;#000000&#39;</span> <span class="p">}</span>
            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">communities_top_cluster</span><span class="p">:</span>
                <span class="n">cluster_name</span> <span class="o">=</span> <span class="p">(</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">max_level</span> <span class="p">)</span>
                <span class="n">edge_templateString_dict</span><span class="p">[</span> <span class="s">&#39;child&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">name2nodeID</span><span class="p">[</span> <span class="n">cluster_name</span> <span class="p">]</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">edge_templateString</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="o">**</span><span class="n">edge_templateString_dict</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span> <span class="p">)</span>

            <span class="c">## add legend for the node size as additional, grey, boxed-sized nodes:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_legend_nodes</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span>  <span class="n">max_obCoFreq</span> <span class="o">*</span> <span class="p">(</span> <span class="n">i</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">n_legend_nodes</span> <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">max_obCoFreq</span>
                <span class="n">node_templateString_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;nodeID&#39;</span> <span class="p">:</span> <span class="s">&#39;legend_node_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">i</span> <span class="p">),</span>
                    <span class="s">&#39;freq&#39;</span> <span class="p">:</span> <span class="n">f</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">,</span>
                    <span class="s">&#39;label&#39;</span> <span class="p">:</span> <span class="nb">round</span><span class="p">(</span> <span class="n">f</span><span class="p">,</span> <span class="mi">4</span> <span class="p">),</span>
                    <span class="s">&#39;c_members&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s">&#39;community&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s">&#39;color&#39;</span> <span class="p">:</span> <span class="s">&#39;#BEBEBE&#39;</span><span class="p">,</span>
                    <span class="s">&#39;metrix&#39;</span> <span class="p">:</span> <span class="s">&#39;None&#39;</span><span class="p">,</span>
                    <span class="s">&#39;shape&#39;</span> <span class="p">:</span> <span class="s">&#39;box&#39;</span><span class="p">,</span>
                    <span class="s">&#39;normalized_max_obCoFreq&#39;</span> <span class="p">:</span> <span class="s">&#39;-99&#39;</span>
                <span class="p">}</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">node_templateString</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="o">**</span><span class="n">node_templateString_dict</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_legend_nodes</span> <span class="p">):</span>
                <span class="n">edge_templateString_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;parent&#39;</span> <span class="p">:</span> <span class="s">&#39;legend_node_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">i</span> <span class="p">),</span> <span class="s">&#39;child&#39;</span> <span class="p">:</span> <span class="s">&#39;legend_node_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">),</span> <span class="s">&#39;color&#39;</span> <span class="p">:</span> <span class="s">&#39;#BEBEBE&#39;</span> <span class="p">}</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">edge_templateString</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="o">**</span><span class="n">edge_templateString_dict</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span> <span class="p">)</span>
            <span class="c">## finalize DOT file:</span>
            <span class="k">print</span><span class="p">(</span> <span class="s">&#39;}&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">dot</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_legend</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;{0}__legend.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rendered_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="s">&#39;{0}.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">filename</span><span class="p">[</span> <span class="p">:</span> <span class="o">-</span><span class="mi">4</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span> <span class="p">[</span> <span class="s">&#39;dot&#39;</span><span class="p">,</span> <span class="s">&#39;-Tpdf&#39;</span><span class="p">,</span> <span class="n">dot_filename</span><span class="p">,</span> <span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="n">rendered_filename</span> <span class="p">],</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span> <span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ INFO ] only DOT file created, renderering with Graphviz failed.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.frequencies"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.frequencies">[docs]</a>    <span class="k">def</span> <span class="nf">frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">clusterID</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">cluster</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a tuple with (i) the cFreq and (ii) a Collections.DefaultDict containing the DLC:frequency pairs for either</span>
<span class="sd">        an identifier, e.g. &quot;JGI4|Chlre4|123456&quot;</span>
<span class="sd">        or clusterID</span>
<span class="sd">        or cluster.</span>
<span class="sd">        Returns &#39;None&#39; if the identifier is not part of the data set, or clusterID or cluster was not found during iterations.</span>

<span class="sd">        Example:</span>

<span class="sd">            &gt;&gt;&gt; cFreq, dlc_freq_dict = cluster.frequencies( identifier = &#39;JGI4|Chlre4|123456&#39; )</span>
<span class="sd">            &gt;&gt;&gt; dlc_freq_dict</span>
<span class="sd">            ... defaultdict(&lt;type &#39;float&#39;&gt;,</span>
<span class="sd">            ... {&#39;average-correlation&#39;: 0.0, &#39;complete-correlation&#39;: 0.0,</span>
<span class="sd">            ... &#39;centroid-euclidean&#39;: 0.0015, &#39;median-euclidean&#39;: 0.0064666666666666666,</span>
<span class="sd">            ... &#39;ward-euclidean&#39;: 0.0041333333333333335, &#39;weighted-correlation&#39;: 0.0,</span>
<span class="sd">            ... &#39;complete-euclidean&#39;: 0.0014, &#39;weighted-euclidean&#39;: 0.0066333333333333331,</span>
<span class="sd">            ... &#39;average-euclidean&#39;: 0.0020333333333333332})</span>

<span class="sd">        :param identifier: search frequencies by identifier input</span>
<span class="sd">        :type identifier: string</span>
<span class="sd">        :param clusterID: search frequencies by cluster ID input</span>
<span class="sd">        :type clusterID: int</span>
<span class="sd">        :param cluster: search frequencies by cluster (tuple of ints) input</span>
<span class="sd">        :type cluster: tuple</span>

<span class="sd">        :rtype: tuple</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">clusterID</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cluster</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;invalid call of function &quot;frequencies&quot;: neither &quot;identifier&quot;, &quot;clusterID&quot; nor &quot;cluster&quot; were given.</span><span class="se">\n\t</span><span class="s">returning None ...&#39;</span><span class="p">,</span>
                <span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">cFreqDict</span> <span class="o">=</span> <span class="n">ddict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># search by identifier</span>
            <span class="n">ident_index</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Identifiers&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">identifier</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">clusterID</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">ident_index</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]):</span>
                        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">clusterID</span> <span class="p">][</span> <span class="n">i</span> <span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Iterations&#39;</span> <span class="p">]</span> <span class="p">)</span>
                        <span class="n">cFreqDict</span><span class="p">[</span> <span class="n">method</span> <span class="p">]</span> <span class="o">+=</span> <span class="n">freq</span>
        <span class="k">elif</span> <span class="n">cluster</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">clusterID</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster 2 clusterID&#39;</span> <span class="p">][</span> <span class="n">cluster</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">clusterID</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dlc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">):</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Cluster counts&#39;</span> <span class="p">][</span> <span class="n">clusterID</span> <span class="p">][</span> <span class="n">i</span> <span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Iterations&#39;</span> <span class="p">]</span> <span class="p">)</span>
                <span class="n">cFreqDict</span><span class="p">[</span> <span class="n">dlc</span> <span class="p">]</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="n">distance_freqs</span> <span class="o">=</span> <span class="p">{</span> <span class="n">distance</span> <span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">distance</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distances&#39;</span> <span class="p">]</span> <span class="p">}</span>
        <span class="k">for</span> <span class="n">dlc</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cFreqDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">distance</span><span class="p">,</span> <span class="n">linkage</span> <span class="o">=</span> <span class="n">dlc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s">&#39;-&#39;</span> <span class="p">)</span>
            <span class="n">distance_freqs</span><span class="p">[</span> <span class="n">distance</span> <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span>
        <span class="n">cFreq</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span> <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">distance_freqs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">cFreq</span><span class="p">,</span> <span class="n">cFreqDict</span>
</div>
<div class="viewcode-block" id="Cluster.plot_mean_distributions"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.plot_mean_distributions">[docs]</a>    <span class="k">def</span> <span class="nf">plot_mean_distributions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates a density plot of mean values for each condition via rpy2.</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">rpy2.robjects</span> <span class="kn">as</span> <span class="nn">robjects</span>
            <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="kn">import</span> <span class="n">r</span>
            <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="kn">import</span> <span class="n">importr</span>
            <span class="n">graphics</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s">&#39;graphics&#39;</span><span class="p">)</span>
            <span class="n">grdevices</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s">&#39;grDevices&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ WARNING ] since &quot;rpy2&quot; is not available (ImportError), the plot of the distribution of mean values could not be created.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">grdevices</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="p">,</span> <span class="s">&#39;distribution_of_means.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]:</span>
            <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">]:</span>
                <span class="n">mean</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">mean</span> <span class="p">)</span>
            <span class="n">graphics</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                                <span class="n">r</span><span class="o">.</span><span class="n">density</span><span class="p">(</span> <span class="n">robjects</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span> <span class="n">means</span> <span class="p">)</span> <span class="p">),</span>
                                <span class="n">main</span> <span class="o">=</span> <span class="n">condition</span><span class="p">,</span>
                                <span class="n">col</span>  <span class="o">=</span> <span class="s">&#39;blue&#39;</span><span class="p">,</span>
                                <span class="n">xlab</span> <span class="o">=</span> <span class="s">&#39;Mean values&#39;</span><span class="p">,</span>
                                <span class="n">ylab</span> <span class="o">=</span> <span class="s">&#39;Density&#39;</span><span class="p">,</span>

            <span class="p">)</span>
        <span class="n">grdevices</span><span class="o">.</span><span class="n">dev_off</span><span class="p">()</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.draw_expression_profiles"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.draw_expression_profiles">[docs]</a>    <span class="k">def</span> <span class="nf">draw_expression_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Draws an expression profile plot (SVG) for each community, illustrating the main &quot;expression pattern&quot; of a community.</span>
<span class="sd">        Each line in this plot represents an object. The &quot;grey cloud&quot; illustrates the range of the standard deviation of the mean values.</span>
<span class="sd">        The plots are named prefixed by &quot;exProf&quot;, followed by the community name as it is shown in the node map.</span>

<span class="sd">        :param min_value_4_expression_map: minimum of the y-axis (since data should be log2 values, this value should typically be &lt; 0).</span>
<span class="sd">        :type min_value_4_expression_map: int</span>
<span class="sd">        :param max_value_4_expression_map: maximum for the y-axis.</span>
<span class="sd">        :type max_value_4_expression_map: int</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Function parameters&#39;</span> <span class="p">][</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_expression_profiles</span><span class="o">.</span><span class="n">__name__</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span> <span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">&#39;self&#39;</span> <span class="p">}</span>
        <span class="kn">import</span> <span class="nn">numpy</span>
        <span class="n">FONT_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">MIN_V</span><span class="p">,</span> <span class="n">MAX_V</span> <span class="o">=</span> <span class="n">min_value_4_expression_map</span><span class="p">,</span> <span class="n">max_value_4_expression_map</span>
        <span class="k">if</span> <span class="n">min_value_4_expression_map</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">max_value_4_expression_map</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># determine min and max for y-axis:</span>
            <span class="n">_yAxisMinMax</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">]:</span>
                <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">]:</span>
                    <span class="n">mean</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span>
                    <span class="n">_yAxisMinMax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="nb">round</span><span class="p">(</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">sd</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
                    <span class="n">_yAxisMinMax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="nb">round</span><span class="p">(</span> <span class="n">mean</span> <span class="o">-</span> <span class="n">sd</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">min_value_4_expression_map</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">MIN_V</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="nb">min</span><span class="p">(</span> <span class="n">_yAxisMinMax</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">max_value_4_expression_map</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">MAX_V</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span> <span class="n">_yAxisMinMax</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="c"># give y-axis the same amount in positive and negative direction (e.g. from - 10 to 10):</span>
            <span class="k">if</span> <span class="n">min_value_4_expression_map</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">max_value_4_expression_map</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># but only if no value is given, otherwise it&#39;s probably user-chosen!</span>
                <span class="k">if</span> <span class="n">MAX_V</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">MIN_V</span> <span class="p">):</span>
                    <span class="n">MIN_V</span> <span class="o">=</span> <span class="n">MAX_V</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">MAX_V</span> <span class="o">=</span> <span class="n">MIN_V</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">startingX</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">startingY</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">+</span> <span class="n">y_offset</span> <span class="c"># determine lenth of y-axis and y-range, represents zero point</span>
        <span class="n">maxY</span> <span class="o">=</span> <span class="p">(</span> <span class="n">startingY</span> <span class="o">-</span> <span class="n">y_offset</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">scalingX</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="p">[</span> <span class="nb">len</span><span class="p">(</span> <span class="n">con</span> <span class="p">)</span> <span class="o">*</span> <span class="n">FONT_SIZE</span> <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">20</span> <span class="c"># distance between each condition</span>
        <span class="n">scalingY</span> <span class="o">=</span> <span class="p">(</span> <span class="n">maxY</span> <span class="o">-</span> <span class="p">(</span> <span class="n">startingY</span> <span class="o">-</span> <span class="n">y_offset</span> <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">MAX_V</span> <span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># has to be negative!</span>

        <span class="k">def</span> <span class="nf">svg_text</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;&lt;text x=&quot;{0}&quot; y=&quot;{1}&quot;&gt; {2} &lt;/text&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text</span> <span class="p">)</span>

        <span class="k">def</span> <span class="nf">svg_line</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;&lt;line x1=&quot;{0}&quot; y1=&quot;{1}&quot; x2=&quot;{2}&quot; y2=&quot;{3}&quot; style=&quot;stroke:#000000&quot;/&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="p">)</span>

        <span class="k">def</span> <span class="nf">svg_comment</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;&lt;!-- {0} --&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">text</span> <span class="p">)</span>

        <span class="k">def</span> <span class="nf">min_max_ratioWithSD</span><span class="p">(</span><span class="n">ratios</span><span class="p">,</span> <span class="n">SDs</span><span class="p">):</span>
            <span class="n">ratios_plus_SD</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ratio</span> <span class="o">+</span> <span class="n">SDs</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">ratios</span> <span class="p">)</span> <span class="p">]</span>
            <span class="n">ratios_minus_SD</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ratio</span> <span class="o">-</span> <span class="n">SDs</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ratio</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">ratios</span> <span class="p">)</span> <span class="p">]</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span> <span class="n">ratios_minus_SD</span> <span class="p">),</span> <span class="nb">max</span><span class="p">(</span> <span class="n">ratios_plus_SD</span> <span class="p">)</span>

        <span class="n">n_conditions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">max_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="p">[</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_levelX_clusters</span><span class="p">(</span> <span class="n">max_level</span> <span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;for IO skip clusters bigger than&#39;</span> <span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">),</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">ratios</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">shape</span> <span class="p">)</span>
            <span class="n">SDs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">shape</span> <span class="p">)</span>
            <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row_index</span><span class="p">,</span> <span class="n">identifier_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">cluster</span> <span class="p">):</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Identifiers&#39;</span> <span class="p">][</span> <span class="n">identifier_index</span> <span class="p">]</span>
                <span class="k">for</span> <span class="n">col_index</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">]</span> <span class="p">):</span>
                    <span class="n">mean</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Data&#39;</span> <span class="p">][</span> <span class="n">identifier</span> <span class="p">][</span> <span class="n">condition</span> <span class="p">]</span>
                    <span class="n">ratios</span><span class="p">[</span> <span class="n">row_index</span> <span class="p">][</span> <span class="n">col_index</span> <span class="p">]</span> <span class="o">=</span> <span class="n">mean</span>
                    <span class="n">SDs</span><span class="p">[</span> <span class="n">row_index</span> <span class="p">][</span> <span class="n">col_index</span> <span class="p">]</span> <span class="o">=</span> <span class="n">sd</span>
                <span class="n">addOn</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">addOn</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Additional Labels&#39;</span> <span class="p">][</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;Identifiers&#39;</span><span class="p">][</span> <span class="n">index</span> <span class="p">]</span> <span class="p">]</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">addOn</span> <span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">list</span><span class="p">()</span> <span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span> <span class="n">addOn</span> <span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span> <span class="nb">set</span><span class="p">()</span> <span class="p">):</span>
                        <span class="n">addOn</span> <span class="o">=</span> <span class="s">&quot;.oOo.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">list</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span> <span class="n">addOn</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="n">addOn</span><span class="p">:</span>
                    <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;{0}___{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">addOn</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">identifier</span> <span class="p">)</span>

            <span class="c">### draw expression profile:</span>
            <span class="n">communityID</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">][</span> <span class="p">(</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">max_level</span> <span class="p">)</span> <span class="p">][</span> <span class="s">&#39;cluster ID&#39;</span> <span class="p">]</span>
            <span class="n">n_values</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">ratios</span> <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="p">,</span> <span class="s">&#39;exProf_{0}-{1}.svg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">communityID</span><span class="p">,</span> <span class="n">max_level</span> <span class="p">)</span> <span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">startingX</span> <span class="o">+</span> <span class="n">scalingX</span> <span class="o">*</span> <span class="p">(</span> <span class="n">n_conditions</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">][</span> <span class="o">-</span><span class="mi">1</span> <span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">FONT_SIZE</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span> <span class="p">[</span> <span class="nb">len</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span> <span class="o">*</span> <span class="n">FONT_SIZE</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">identifiers</span> <span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">10</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; font-size=&quot;{2}px&quot; font-family=&quot;Verdana&quot; width=&quot;{0}&quot; height=&quot;{1}&quot;&gt;&#39;</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">width</span><span class="p">,</span> <span class="n">maxY</span> <span class="o">+</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="n">FONT_SIZE</span><span class="p">,</span> <span class="n">FONT_SIZE</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="c">## draw SD-cloud:</span>
                <span class="c"># determine min and max ratio + SD:</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">svg_comment</span><span class="p">(</span> <span class="s">&#39;SD CLOUD:&#39;</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_conditions</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span>
                    <span class="n">y1_min</span><span class="p">,</span> <span class="n">y1_max</span> <span class="o">=</span> <span class="n">min_max_ratioWithSD</span><span class="p">(</span> <span class="p">[</span> <span class="n">ratios</span><span class="p">[</span> <span class="n">j</span> <span class="p">][</span> <span class="n">i</span> <span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_values</span> <span class="p">)</span> <span class="p">],</span> <span class="p">[</span> <span class="n">SDs</span><span class="p">[</span> <span class="n">j</span> <span class="p">][</span> <span class="n">i</span> <span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_values</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
                    <span class="n">y2_min</span><span class="p">,</span> <span class="n">y2_max</span> <span class="o">=</span> <span class="n">min_max_ratioWithSD</span><span class="p">(</span> <span class="p">[</span> <span class="n">ratios</span><span class="p">[</span> <span class="n">j</span> <span class="p">][</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_values</span> <span class="p">)</span> <span class="p">],</span> <span class="p">[</span> <span class="n">SDs</span><span class="p">[</span> <span class="n">j</span> <span class="p">][</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_values</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&lt;path d=&quot;M{x1} {y1_min} L{x2} {y2_min} L{x2} {y2_max} L{x1} {y1_max} Z&quot; fill=&quot;{fill}&quot;/&gt;&#39;</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;fill&#39;</span> <span class="p">:</span> <span class="s">&#39;#D3D3D3&#39;</span><span class="p">}</span>
                    <span class="n">d</span><span class="p">[</span> <span class="s">&#39;x1&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingX</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">scalingX</span>
                    <span class="n">d</span><span class="p">[</span> <span class="s">&#39;x2&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingX</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">scalingX</span>
                    <span class="n">d</span><span class="p">[</span> <span class="s">&#39;y1_min&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">y1_min</span><span class="o">*</span><span class="n">scalingY</span>
                    <span class="n">d</span><span class="p">[</span> <span class="s">&#39;y1_max&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">y1_max</span><span class="o">*</span><span class="n">scalingY</span>
                    <span class="n">d</span><span class="p">[</span> <span class="s">&#39;y2_min&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">y2_min</span><span class="o">*</span><span class="n">scalingY</span>
                    <span class="n">d</span><span class="p">[</span> <span class="s">&#39;y2_max&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">y2_max</span><span class="o">*</span><span class="n">scalingY</span>
                    <span class="k">print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="o">**</span><span class="n">d</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>

                <span class="c">## draw expression profile lines:</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">svg_comment</span><span class="p">(</span> <span class="s">&#39;EXPRESSION PROFILE LINES:&#39;</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_conditions</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">n_values</span> <span class="p">):</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">d</span><span class="p">[</span> <span class="s">&#39;x1&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingX</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">scalingX</span>
                        <span class="n">d</span><span class="p">[</span> <span class="s">&#39;x2&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingX</span> <span class="o">+</span> <span class="p">(</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">*</span> <span class="n">scalingX</span>
                        <span class="n">d</span><span class="p">[</span> <span class="s">&#39;y1&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">ratios</span><span class="p">[</span> <span class="n">j</span> <span class="p">][</span> <span class="n">i</span> <span class="p">]</span> <span class="o">*</span> <span class="n">scalingY</span>
                        <span class="n">d</span><span class="p">[</span> <span class="s">&#39;y2&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">ratios</span><span class="p">[</span> <span class="n">j</span> <span class="p">][</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">*</span> <span class="n">scalingY</span>
                        <span class="k">print</span><span class="p">(</span> <span class="n">svg_line</span><span class="p">(</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span> <span class="s">&#39;x1&#39;</span> <span class="p">],</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span> <span class="s">&#39;y1&#39;</span> <span class="p">],</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span> <span class="s">&#39;x2&#39;</span> <span class="p">],</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span> <span class="s">&#39;y2&#39;</span> <span class="p">]</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>

                <span class="c">## add legend:</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">svg_comment</span><span class="p">(</span> <span class="s">&#39;LEGEND:&#39;</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="c"># first, collect all values to plot -&gt; to allow removing overlapping identifiers:</span>
                <span class="n">legend</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">identifiers</span> <span class="p">):</span>
                    <span class="n">_last_ratio</span> <span class="o">=</span> <span class="n">ratios</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="o">-</span><span class="mi">1</span> <span class="p">]</span>
                    <span class="n">_x</span> <span class="o">=</span> <span class="n">startingX</span> <span class="o">+</span> <span class="n">scalingX</span> <span class="o">*</span> <span class="p">(</span> <span class="n">n_conditions</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                    <span class="n">_y</span> <span class="o">=</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">_last_ratio</span> <span class="o">*</span> <span class="n">scalingY</span>
                    <span class="n">legend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">identifier</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">legend</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="c"># get all y-differences:</span>
                <span class="n">y_differences</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">identifier</span> <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">legend</span><span class="p">[</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">]</span> <span class="p">):</span>
                    <span class="n">y_differences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">legend</span><span class="p">[</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">][</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">-</span> <span class="n">y</span> <span class="p">)</span>
                <span class="c"># max font size for legend is the minimum y distance -&gt; no overlap!</span>
                <span class="n">legend_maxFontSize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="nb">round</span><span class="p">(</span> <span class="nb">min</span><span class="p">(</span> <span class="n">y_differences</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">legend_maxFontSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">legend_maxFontSize</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c"># plot legend</span>
                <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">legend</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span> <span class="s">&#39;&lt;text x=&quot;{0}&quot; y=&quot;{1}&quot; font-size=&quot;{3}px&quot;&gt;{2}&lt;/text&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">legend_maxFontSize</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>

                <span class="c">## plot axis:</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">svg_comment</span><span class="p">(</span> <span class="s">&#39;AXES:&#39;</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="c"># y-axis:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">svg_line</span><span class="p">(</span> <span class="n">x1</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">MAX_V</span> <span class="o">*</span> <span class="n">scalingY</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">maxY</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="c"># y-axis - ticks:</span>
                <span class="n">y_ticks_per_unit</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MAX_V</span> <span class="o">*</span> <span class="n">y_ticks_per_unit</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">):</span>
                    <span class="n">_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span> <span class="o">/</span> <span class="n">y_ticks_per_unit</span>
                    <span class="n">_y</span> <span class="o">=</span>  <span class="n">startingY</span> <span class="o">+</span> <span class="n">_ratio</span> <span class="o">*</span> <span class="n">scalingY</span>
                    <span class="k">print</span><span class="p">(</span> <span class="n">svg_text</span><span class="p">(</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span> <span class="o">+</span> <span class="n">FONT_SIZE</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;+{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">_ratio</span> <span class="p">)</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span> <span class="n">svg_line</span><span class="p">(</span> <span class="n">x1</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">_y</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">_y</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">MIN_V</span> <span class="p">)</span> <span class="o">*</span> <span class="n">y_ticks_per_unit</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">):</span>
                    <span class="n">_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span> <span class="o">/</span> <span class="n">y_ticks_per_unit</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">_y</span> <span class="o">=</span>  <span class="n">startingY</span> <span class="o">+</span> <span class="n">_ratio</span> <span class="o">*</span> <span class="n">scalingY</span>
                    <span class="k">print</span><span class="p">(</span> <span class="n">svg_text</span><span class="p">(</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_y</span> <span class="o">+</span> <span class="n">FONT_SIZE</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">_ratio</span><span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span> <span class="n">svg_line</span><span class="p">(</span> <span class="n">x1</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">_y</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">_y</span><span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">svg_text</span><span class="p">(</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">FONT_SIZE</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">svg_line</span><span class="p">(</span> <span class="n">x1</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">startingY</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">startingY</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="c"># zero-line:</span>
                <span class="k">print</span><span class="p">(</span> <span class="n">svg_line</span><span class="p">(</span> <span class="n">x1</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">startingY</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">startingX</span> <span class="o">+</span> <span class="n">scalingX</span> <span class="o">*</span> <span class="p">(</span> <span class="n">n_conditions</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">),</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">startingY</span> <span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                <span class="c"># x-axis = conditions:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]</span> <span class="p">):</span>
                    <span class="n">_x</span> <span class="o">=</span> <span class="n">startingX</span> <span class="o">+</span> <span class="n">scalingX</span> <span class="o">*</span> <span class="n">i</span>
                    <span class="k">print</span><span class="p">(</span> <span class="n">svg_text</span><span class="p">(</span> <span class="n">x</span><span class="o">=</span> <span class="n">_x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">maxY</span> <span class="o">+</span> <span class="n">y_offset</span> <span class="o">+</span> <span class="n">FONT_SIZE</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">condition</span><span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&lt;line x1=&quot;{0}&quot; y1=&quot;{1}&quot; x2=&quot;{2}&quot; y2=&quot;{3}&quot; style=&quot;stroke-dasharray: 5, 5; stroke:#000000&quot;/&gt;&#39;</span>
                    <span class="k">print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">_x</span><span class="p">,</span> <span class="n">startingY</span> <span class="o">+</span> <span class="n">MAX_V</span> <span class="o">*</span> <span class="n">scalingY</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">maxY</span> <span class="o">+</span> <span class="n">y_offset</span><span class="p">),</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>

                <span class="k">print</span><span class="p">(</span> <span class="s">&#39;&lt;/svg&gt;&#39;</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">fout</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;... community expression profile plots saved in &quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.do_it_all"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.do_it_all">[docs]</a>    <span class="k">def</span> <span class="nf">do_it_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">working_directory</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">distances</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">linkages</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">function_2_generate_noise_injected_datasets</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="n">min_cluster_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">alphabet</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">force_plotting</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">min_cluster_freq_2_retain</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
                    <span class="n">pickle_filename</span> <span class="o">=</span> <span class="s">&#39;pyGCluster_resampled.pkl&#39;</span><span class="p">,</span> <span class="n">cpus_2_use</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">iter_max</span> <span class="o">=</span> <span class="mi">250000</span><span class="p">,</span>
                    <span class="n">iter_tol</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">iter_step</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">iter_top_P</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">iter_window</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span> <span class="n">iter_till_the_end</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="n">top_X_clusters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                    <span class="n">starting_min_overlap</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">increasing_min_overlap</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                    <span class="n">color_gradient</span> <span class="o">=</span> <span class="s">&#39;1337&#39;</span><span class="p">,</span> <span class="n">box_style</span> <span class="o">=</span> <span class="s">&#39;classic&#39;</span><span class="p">,</span>
                    <span class="n">min_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">max_value_4_expression_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">additional_labels</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Evokes all necessary functions which constitute the main functionality of pyGCluster.</span>
<span class="sd">        This is AHC clustering with noise injection and a variety of DLCs,</span>
<span class="sd">        in order to identify highly reproducible clusters,</span>
<span class="sd">        followed by a meta-clustering of highly reproducible clusters into so-called &#39;communities&#39;.</span>

<span class="sd">        The functions that are called are:</span>

<span class="sd">           - :py:func:`pyGCluster.Cluster.resample`</span>
<span class="sd">           - :py:func:`pyGCluster.Cluster.build_nodemap`</span>
<span class="sd">           - :py:func:`pyGCluster.Cluster.write_dot`</span>
<span class="sd">           - :py:func:`pyGCluster.Cluster.draw_community_expression_maps`</span>
<span class="sd">           - :py:func:`pyGCluster.Cluster.draw_expression_profiles`</span>

<span class="sd">        For a complete list of possible </span>
<span class="sd">        Distance matrix calculations</span>
<span class="sd">        see: http://docs.scipy.org/doc/scipy/reference/spatial.distance.html</span>
<span class="sd">        or Linkage methods</span>
<span class="sd">        see: http://docs.scipy.org/doc/scipy/reference/generated/scipy.cluster.hierarchy.linkage.html</span>

<span class="sd">        .. note ::</span>
<span class="sd">            If memory is of concern (e.g. for a large dataset, &gt; 5000 objects), cpus_2_use should be kept low.</span>

<span class="sd">        :param distances: list of distance metrices, given as strings, e.g. [ &#39;correlation&#39;, &#39;euclidean&#39; ]</span>
<span class="sd">        :type distances: list</span>
<span class="sd">        :param linkages: list of distance metrices, given as strings, e.g. [ &#39;average&#39;, &#39;complete&#39;, &#39;ward&#39; ]</span>
<span class="sd">        :type linkages: list</span>
<span class="sd">        :param function_2_generate_noise_injected_datasets: function to generate noise-injected datasets. If None (default), Gaussian distributions are used.</span>
<span class="sd">        :type function_2_generate_noise_injected_datasets: function</span>
<span class="sd">        :param min_cluster_size: minimum size of a cluster, so that it is included in the assessment of cluster reproducibilities.</span>
<span class="sd">        :type min_cluster_size: int</span>
<span class="sd">        :param alphabet: alphabet used to convert decimal indices to characters to save memory. Defaults to string.printable, without &#39;,&#39;.</span>
<span class="sd">        :type alphabet: string</span>

<span class="sd">        .. note ::</span>
<span class="sd">            If alphabet contains &#39;,&#39;, this character is removed from alphabet, because the indices comprising a cluster are saved comma-seperated.</span>

<span class="sd">        :param force_plotting: the convergence plot is created after each iter_step iteration (otherwise only when convergence is detected).</span>
<span class="sd">        :type force_plotting: boolean</span>
<span class="sd">        :param min_cluster_freq_2_retain: ]0, 1[ minimum frequency of a cluster (only the maximum of the dlc-frequencies matters here) it has to exhibit to be stored in pyGCluster once all iterations are finished.</span>
<span class="sd">        :type min_cluster_freq_2_retain: float</span>
<span class="sd">        :param cpus_2_use: number of threads that are evoked in the re-sampling routine.</span>
<span class="sd">        :type cpus_2_use: int</span>
<span class="sd">        :param iter_max: maximum number of re-sampling iterations.</span>
<span class="sd">        :type iter_max: int</span>

<span class="sd">        Convergence determination:</span>

<span class="sd">        :param iter_tol: ]0, 1e-3[ value for the threshold of the median of normalized slopes, in order to declare convergence.</span>
<span class="sd">        :type iter_tol: float</span>
<span class="sd">        :param iter_step: number of iterations each multiprocess performs and simultaneously the interval in which to check for convergence.</span>
<span class="sd">        :type iter_step: int</span>
<span class="sd">        :param iter_top_P: ]0, 1[ for the convergence estmation, the amount of most frequent clusters is examined. This is the threshold for the minimum frequency of a cluster to be included.</span>
<span class="sd">        :type iter_top_P: float</span>
<span class="sd">        :param iter_window: size of the sliding window in iterations. The median is obtained from normalized slopes inside this window - *should be a multiple of iter_step*</span>
<span class="sd">        :type iter_window: int</span>
<span class="sd">        :param iter_till_the_end: if set to True, the convergence determination is switched off; hence, re-sampling is performed until iter_max is reached.</span>
<span class="sd">        :type iter_till_the_end: boolean</span>

<span class="sd">        Output/Plotting:</span>

<span class="sd">        :param pickle_filename: Filename of the output pickle object</span>
<span class="sd">        :type pickle_filename: string </span>
<span class="sd">        :param top_X_clusters: Plot of the top X clusters in the sorted list (by freq) of clusters having a maximum cluster frequency of at least threshold_4_the_lowest_max_freq (clusterfreq-plot is still sorted by size).</span>
<span class="sd">        :type top_X_clusters: int</span>
<span class="sd">        :param threshold_4_the_lowest_max_freq: ]0, 1[ Clusters must have a maximum frequency of at least threshold_4_the_lowest_max_freq to appear in the plot.</span>
<span class="sd">        :type threshold_4_the_lowest_max_freq: float  </span>
<span class="sd">        :param min_value_4_expression_map: lower bound for color coding of values in the expression map. Remember that log2-values are expected, i.e. this value should be &lt; 0!</span>
<span class="sd">        :type min_value_4_expression_map: float</span>
<span class="sd">        :param max_value_4_expression_map: upper bound for color coding of values in the expression map.</span>
<span class="sd">        :type max_value_4_expression_map: float</span>
<span class="sd">        :param color_gradient: name of the color gradient used for plotting the expression map. Currently supported are default, Daniel, barplot, 1337, BrBG, PiYG, PRGn, PuOr, RdBu, RdGy, RdYlBu, RdYlGn and Spectral</span>
<span class="sd">        :type color_gradient: string</span>
<span class="sd">        :param expression_map_filename: file name for expression map. .svg will be added if required.</span>
<span class="sd">        :type expression_map_filename: string</span>
<span class="sd">        :param legend_filename: file name for legend .svg will be added if required.</span>
<span class="sd">        :type legend_filename: string</span>
<span class="sd">        :param box_style: the way the relative standard deviation is visualized in the expression map. Currently supported are &#39;modern&#39;, &#39;fusion&#39; or &#39;classic&#39;.</span>
<span class="sd">        :type box_style: string  </span>
<span class="sd">        :param starting_min_overlap: ]0, 1[ minimum required relative overlap between clusters so that they are assigned the same community. The relative overlap is defined as the size of the overlap between two clusters, divided by the size of the larger cluster.</span>
<span class="sd">        :type starting_min_overlap: float</span>
<span class="sd">        :param increasing_min_overlap: defines the increase of the required overlap between communities</span>
<span class="sd">        :type increasing_min_overlap: float</span>
<span class="sd">        :param additional_labels: dictionary, where additional labels can be defined which will be added in the expression map plots to the gene/protein names</span>
<span class="sd">        :type additional_labels: dict</span>

<span class="sd">        :rtype: None</span>

<span class="sd">        For more information to each parameter, please refer to :py:func:`pyGCluster.Cluster.resample`,</span>
<span class="sd">        and the subsequent functions:</span>
<span class="sd">        :py:func:`pyGCluster.Cluster.build_nodemap`,</span>
<span class="sd">        :py:func:`pyGCluster.Cluster.write_dot`,</span>
<span class="sd">        :py:func:`pyGCluster.Cluster.draw_community_expression_maps`,</span>
<span class="sd">        :py:func:`pyGCluster.Cluster.draw_expression_profiles`.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">working_directory</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">working_directory</span>
        <span class="k">if</span> <span class="n">distances</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;euclidean&#39;</span><span class="p">,</span> <span class="s">&#39;correlation&#39;</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">linkages</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">linkages</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;complete&#39;</span><span class="p">,</span> <span class="s">&#39;average&#39;</span><span class="p">,</span> <span class="s">&#39;weighted&#39;</span><span class="p">,</span> <span class="s">&#39;centroid&#39;</span><span class="p">,</span> <span class="s">&#39;median&#39;</span><span class="p">,</span> <span class="s">&#39;ward&#39;</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">additional_labels</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Additional Labels&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">additional_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;RESAMPLING ...&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span>
            <span class="n">distances</span>                                   <span class="o">=</span> <span class="n">distances</span><span class="p">,</span>
            <span class="n">linkages</span>                                    <span class="o">=</span> <span class="n">linkages</span><span class="p">,</span>
            <span class="n">function_2_generate_noise_injected_datasets</span> <span class="o">=</span> <span class="n">function_2_generate_noise_injected_datasets</span><span class="p">,</span>
            <span class="n">alphabet</span>                                    <span class="o">=</span> <span class="n">alphabet</span><span class="p">,</span>
            <span class="n">iter_max</span>                                    <span class="o">=</span> <span class="n">iter_max</span><span class="p">,</span>
            <span class="n">iter_top_P</span>                                  <span class="o">=</span> <span class="n">iter_top_P</span><span class="p">,</span>
            <span class="n">iter_step</span>                                   <span class="o">=</span> <span class="n">iter_step</span><span class="p">,</span>
            <span class="n">iter_tol</span>                                    <span class="o">=</span> <span class="n">iter_tol</span><span class="p">,</span>
            <span class="n">iter_window</span>                                 <span class="o">=</span> <span class="n">iter_window</span><span class="p">,</span>
            <span class="n">min_cluster_size</span>                            <span class="o">=</span> <span class="n">min_cluster_size</span><span class="p">,</span>
            <span class="n">min_cluster_freq_2_retain</span>                   <span class="o">=</span> <span class="n">min_cluster_freq_2_retain</span><span class="p">,</span>
            <span class="n">pickle_filename</span>                             <span class="o">=</span> <span class="n">pickle_filename</span><span class="p">,</span>
            <span class="n">cpus_2_use</span>                                  <span class="o">=</span> <span class="n">cpus_2_use</span><span class="p">,</span>
            <span class="n">iter_till_the_end</span>                           <span class="o">=</span> <span class="n">iter_till_the_end</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;Resampling done.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">plotting cluster frequencies, building node map, drawing expression maps ...&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_clusterfreqs</span><span class="p">(</span>
            <span class="n">min_cluster_size</span>                    <span class="o">=</span> <span class="n">min_cluster_size</span><span class="p">,</span>
            <span class="n">top_X_clusters</span>                      <span class="o">=</span> <span class="n">top_X_clusters</span><span class="p">,</span>
            <span class="n">threshold_4_the_lowest_max_freq</span>     <span class="o">=</span> <span class="n">threshold_4_the_lowest_max_freq</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_nodemap</span><span class="p">(</span>
            <span class="n">min_cluster_size</span> <span class="o">=</span> <span class="n">min_cluster_size</span><span class="p">,</span>
            <span class="n">top_X_clusters</span>                      <span class="o">=</span> <span class="n">top_X_clusters</span><span class="p">,</span>
            <span class="n">threshold_4_the_lowest_max_freq</span>     <span class="o">=</span> <span class="n">threshold_4_the_lowest_max_freq</span><span class="p">,</span>
            <span class="n">starting_min_overlap</span>                <span class="o">=</span> <span class="n">starting_min_overlap</span><span class="p">,</span>
            <span class="n">increasing_min_overlap</span>              <span class="o">=</span> <span class="n">increasing_min_overlap</span>
        <span class="p">)</span>
        <span class="n">dot_filename</span> <span class="o">=</span> <span class="s">&#39;nodemap_minSize{0}_top{1}_top{2:.0f}promille.dot&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">min_cluster_size</span><span class="p">,</span> <span class="n">top_X_clusters</span><span class="p">,</span> <span class="n">threshold_4_the_lowest_max_freq</span> <span class="o">*</span> <span class="mi">1000</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_dot</span><span class="p">(</span>
            <span class="n">filename</span>                    <span class="o">=</span> <span class="n">dot_filename</span><span class="p">,</span>
            <span class="n">min_value_4_expression_map</span>  <span class="o">=</span> <span class="n">min_value_4_expression_map</span><span class="p">,</span>
            <span class="n">max_value_4_expression_map</span>  <span class="o">=</span> <span class="n">max_value_4_expression_map</span><span class="p">,</span>
            <span class="n">color_gradient</span>              <span class="o">=</span> <span class="n">color_gradient</span><span class="p">,</span>
            <span class="n">box_style</span>                   <span class="o">=</span> <span class="n">box_style</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_community_expression_maps</span><span class="p">(</span>
            <span class="n">min_value_4_expression_map</span>  <span class="o">=</span> <span class="n">min_value_4_expression_map</span><span class="p">,</span>
            <span class="n">max_value_4_expression_map</span>  <span class="o">=</span> <span class="n">max_value_4_expression_map</span><span class="p">,</span>
            <span class="n">color_gradient</span>              <span class="o">=</span> <span class="n">color_gradient</span><span class="p">,</span>
            <span class="n">box_style</span>                   <span class="o">=</span> <span class="n">box_style</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw_expression_profiles</span><span class="p">(</span>
            <span class="n">min_value_4_expression_map</span> <span class="o">=</span> <span class="n">min_value_4_expression_map</span><span class="p">,</span>
            <span class="n">max_value_4_expression_map</span> <span class="o">=</span> <span class="n">max_value_4_expression_map</span>
        <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.info"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Prints some information about the clustering via pyGCluster:</span>

<span class="sd">            - number of genes/proteins clustered</span>
<span class="sd">            - number of conditions defined</span>
<span class="sd">            - number of distance-linkage combinations</span>
<span class="sd">            - number of iterations performed</span>

<span class="sd">        as well as some information about the communities, the legend for the shapes of nodes in the node map and the way the functions were called.</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ INFO ] {0:*^100}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="s">&#39; info function START &#39;</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">            {0:&gt;9} identifiers were used to cluster</span>
<span class="s">            {1:&gt;9} conditions were defined</span>
<span class="s">            {2:&gt;9} linkage - distance def combos were used</span>
<span class="s">            {3:&gt;9} iterations were peformed</span>

<span class="s">            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Identifiers&#39;</span> <span class="p">]</span> <span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Conditions&#39;</span> <span class="p">]</span> <span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Distance-linkage combinations&#39;</span> <span class="p">]</span> <span class="p">),</span>
                <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Iterations&#39;</span> <span class="p">]</span>
            <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;Results are saved in the folder: &quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">]</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;Communities&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="n">max_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="p">[</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Communities&#39;</span> <span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">communities_top_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_levelX_clusters</span><span class="p">(</span> <span class="n">level</span> <span class="o">=</span> <span class="n">max_level</span> <span class="p">)</span>
            <span class="n">communities_minus_close2root</span> <span class="o">=</span> <span class="p">[</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>  <span class="n">communities_top_cluster</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">c</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;for IO skip clusters bigger than&#39;</span> <span class="p">]</span> <span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;{3} most_frequent_clusters were combined into {0} communities. {1} of those communities contain more than {2} objects (i.e. are &quot;close to root&quot; communities).&#39;</span>
            <span class="n">n_communities</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">communities_top_cluster</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">n_communities</span><span class="p">,</span> <span class="n">n_communities</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span> <span class="n">communities_minus_close2root</span> <span class="p">),</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;for IO skip clusters bigger than&#39;</span> <span class="p">],</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_levelX_clusters</span><span class="p">(</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;See below for the parameters that were used to form communities (function &quot;build_nodemap&quot;).&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;Communities were not yet formed.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;nodemap metric2shape&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;The legend for the node shapes in the DOT file is:&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;nodemap metric2shape&#39;</span> <span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39; - clusters that are found by distance metric(s): &quot;{0}&quot; are visualized as &quot;{1}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">metric</span><span class="p">,</span> <span class="n">shape</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;Values of the parameters of the functions that were already called:&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Function parameters&#39;</span> <span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">- function {0} was called with ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">function_name</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">kw</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Function parameters&#39;</span> <span class="p">][</span> <span class="n">function_name</span> <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\t\t</span><span class="s">- - keyword: &quot;{0}&quot;, value: &quot;{1}&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">kw</span><span class="p">,</span> <span class="n">value</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;[ INFO ] {0:*^100}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="s">&#39; info function END &#39;</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.save"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;pyGCluster.pkl&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Saves the current pyGCluster.Cluster object in a Pickle object.</span>

<span class="sd">        :param filename: may be either a simple file name (&quot;example.pkl&quot;) or a complete path (e.g. &quot;/home/user/Desktop/example.pkl&quot;). In the former case, the pickle is stored in pyGCluster&#39;s working directory.</span>
<span class="sd">        :type filename: string</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tmp</span><span class="p">[</span> <span class="n">key</span> <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span> <span class="n">key</span> <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">]:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">filename</span> <span class="p">),</span> <span class="s">&#39;wb&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">fout</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;pyGCluster pickled in: &quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">filename</span> <span class="p">)</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">fout</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;pyGCluster pickled in: &quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">filename</span> <span class="p">),</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.load"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fills a pyGCluster.Cluster object with the session saved as &quot;filename&quot;.</span>
<span class="sd">        If &quot;filename&quot; is not a complete path, e.g. &quot;example.pkl&quot; (instead of &quot;/home/user/Desktop/example.pkl&quot;), the directory given by self[ &#39;Working directory&#39; ] is used.</span>

<span class="sd">        .. note ::</span>
<span class="sd">            Loading of pyGCluster has to be performed as a 2-step-procedure:</span>
<span class="sd">                &gt;&gt;&gt; LoadedClustering = pyGCluster.Cluster()</span>
<span class="sd">                &gt;&gt;&gt; LoadedClustering.load( &quot;/home/user/Desktop/example.pkl&quot; )</span>

<span class="sd">        :param filename: may be either a simple file name (&quot;example.pkl&quot;) or a complete path (e.g. &quot;/home/user/Desktop/example.pkl&quot;).</span>
<span class="sd">        :type filename: string</span>

<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">_dir</span><span class="p">,</span> <span class="n">_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">_dir</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">fin</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Working directory&#39;</span> <span class="p">],</span> <span class="n">filename</span> <span class="p">),</span> <span class="s">&#39;rb&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">fin</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span> <span class="n">key</span> <span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span> <span class="n">key</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span> <span class="s">&#39;pyGCluster loaded.&#39;</span><span class="p">,</span> <span class="n">verbosity_level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="Cluster.median"><a class="viewcode-back" href="../pyGCluster.html#pyGCluster.Cluster.median">[docs]</a>    <span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the median from a list of numeric values.</span>

<span class="sd">        :param _list:</span>
<span class="sd">        :type _list: list</span>

<span class="sd">        :rtype: int / float</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">_list</span> <span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">_list</span> <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">length</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span> <span class="n">_list</span><span class="p">[</span> <span class="n">length</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">+</span> <span class="n">_list</span><span class="p">[</span> <span class="n">length</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">return</span> <span class="n">_list</span><span class="p">[</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Internal print function which implements the &quot;verbosity_level&quot; parameter.</span>
<span class="sd">        :rtype: none</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span> <span class="s">&#39;verbosity_level&#39;</span> <span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="p">[</span> <span class="s">&#39;Verbosity level&#39;</span> <span class="p">]:</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span> <span class="s">&#39;verbosity_level&#39;</span> <span class="p">]</span>
            <span class="k">print</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
        <span class="k">return</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c">#invoke the freeze_support funtion for windows based systems</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">getwindowsversion</span><span class="p">()</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">()</span>
    <span class="nb">exit</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">pyGCluster 0.18.4 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Daniel Jaeger, Johannes Barth, Anna Niehues and Christian Fufezan.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>